<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDT | Poliția Română</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Teko:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- MDT Redesign Theme --- */
        :root {
            --mdt-bg: rgba(13, 17, 23, 1); /* Very dark charcoal */
            --mdt-bg-secondary: rgba(22, 27, 34, 1); /* Dark panel background */
            --mdt-bg-tertiary: rgba(1, 4, 9, 1); /* Blackest background */
            --mdt-border: #30363d; /* Muted border */
            --mdt-border-highlight: #8b949e;
            --mdt-text-primary: #e6edf3; /* Primary text - off-white */
            --mdt-text-secondary: #7d8590; /* Secondary text - gray */
            --mdt-text-accent: #58a6ff; /* Blue accent for highlights */
            --mdt-text-input: #c9d1d9; /* Text inside inputs */
            --mdt-alert-red: #f85149;
            --mdt-alert-yellow: #d29922;
            --mdt-alert-green: #3fb950;
            --mdt-accent-purple: #a371f7;
            --mdt-accent-orange: #f97316;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background-color: var(--mdt-bg-tertiary);
            color: var(--mdt-text-primary);
            padding: 0.5rem;
        }

        /* Main application container */
        .mdt-container {
            background-color: var(--mdt-bg);
            border: 1px solid var(--mdt-border);
            height: calc(100vh - 1rem);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 0.5rem; /* Rounded corners for the main container */
        }

        /* Header Bar */
        .mdt-header {
            background-color: var(--mdt-bg-tertiary);
            border-bottom: 1px solid var(--mdt-border);
            padding: 0.25rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            border-top-left-radius: 0.5rem; /* Rounded corners for header */
            border-top-right-radius: 0.5rem;
        }
        .mdt-header .logo-title {
            font-family: 'Teko', sans-serif;
            font-size: 1.75rem;
            letter-spacing: 1px;
            color: var(--mdt-text-primary);
        }
        .mdt-header .status-bar {
            display: flex;
            gap: 1.5rem;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .mdt-header .status-item span:first-child {
            color: var(--mdt-text-secondary);
            margin-right: 0.5rem;
        }
        .mdt-header .status-item .status-ok {
            color: var(--mdt-alert-green);
            font-weight: 700;
        }

        /* Main Content Area */
        .mdt-main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Tab styling */
        .tab-container {
            border-bottom: 2px solid var(--mdt-border);
            margin-bottom: 1rem;
            display: flex; /* Use flex for tabs */
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }
        .tab-button {
            font-family: 'Teko', sans-serif;
            font-size: 1.25rem;
            letter-spacing: 0.5px;
            padding: 0.5rem 1.5rem;
            border: 1px solid transparent;
            border-bottom: none;
            color: var(--mdt-text-secondary);
            transition: all 0.2s ease-in-out;
            margin-bottom: -2px; /* Overlap border */
            border-top-left-radius: 0.25rem; /* Small rounded corners for tabs */
            border-top-right-radius: 0.25rem;
        }
        .tab-button.active {
            color: var(--mdt-text-primary);
            background-color: var(--mdt-bg);
            border-color: var(--mdt-border);
            border-bottom-color: var(--mdt-bg);
        }
        .tab-button:hover:not(.active) {
            color: var(--mdt-text-primary);
        }

        .sub-tab-button {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            color: var(--mdt-text-secondary);
            border-bottom: 2px solid transparent; /* Added for active state */
            transition: border-color 0.2s ease;
        }
        .sub-tab-button.active {
            color: var(--mdt-text-accent);
            border-bottom-color: var(--mdt-text-accent);
        }
        .sub-tab-button:hover:not(.active) {
            color: var(--mdt-text-primary);
        }


        .tab-content.active, .sub-tab-content.active {
            display: block;
        }
        .tab-content, .sub-tab-content {
            display: none;
        }

        /* Form and Input Styling */
        label.label-text {
            display: block;
            color: var(--mdt-text-secondary);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 0.35rem;
        }
        .input-field, .select-field, .textarea-field {
            background-color: var(--mdt-bg-secondary);
            border: 1px solid var(--mdt-border);
            color: var(--mdt-text-input);
            padding: 0.5rem 0.75rem;
            width: 100%;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            border-radius: 0.25rem; /* Rounded corners for inputs */
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            outline: none;
            border-color: var(--mdt-text-accent);
            background-color: var(--mdt-bg);
            box-shadow: 0 0 0 1px var(--mdt-text-accent); /* Subtle glow on focus */
        }
        .input-field-readonly {
            background-color: #21262d !important;
            cursor: not-allowed;
        }
        .select-field option {
            background-color: var(--mdt-bg-secondary);
            color: var(--mdt-text-input);
        }
        .input-group {
            display: flex;
            align-items: center;
            background-color: var(--mdt-bg-secondary);
            border: 1px solid var(--mdt-border);
            border-radius: 0.25rem; /* Rounded corners for input groups */
        }
        .input-group:focus-within {
             border-color: var(--mdt-text-accent);
             background-color: var(--mdt-bg);
             box-shadow: 0 0 0 1px var(--mdt-text-accent);
        }
        .input-group i {
            color: var(--mdt-text-secondary);
            padding: 0 0.75rem;
        }
        .input-group .input-field {
            border: none;
            background: transparent;
            box-shadow: none; /* Remove focus shadow from inner input */
        }
        .input-group .input-field:focus {
            box-shadow: none;
        }

        /* Validation styles */
        .input-field.incomplete, .textarea-field.incomplete {
            border-color: var(--mdt-alert-red);
            box-shadow: 0 0 0 1px var(--mdt-alert-red);
        }
        .input-field.completed, .textarea-field.completed {
            border-color: var(--mdt-alert-green);
        }

        /* Checkbox & Radio */
        .control-label {
            color: var(--mdt-text-primary);
            font-size: 0.9rem;
            display: inline-flex; /* Align checkbox/radio with text */
            align-items: center;
            cursor: pointer;
        }
        .control-input {
            margin-right: 0.5rem;
            accent-color: var(--mdt-text-accent); /* Accent color for native controls */
            width: 1rem;
            height: 1rem;
        }

        /* Section Boxes */
        .section-box {
            border: 1px solid var(--mdt-border);
            background-color: var(--mdt-bg-secondary);
            padding: 1rem;
            display: grid;
            gap: 1.25rem;
            border-radius: 0.5rem; /* Rounded corners for section boxes */
        }
        .section-box h3 {
            font-family: 'Teko', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.5px;
            color: var(--mdt-text-primary);
            border-bottom: 1px solid var(--mdt-border);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        /* Overwriting old box styles to match new theme */
        .turquoise-box, .magenta-box, .white-box, .orange-box, .yellow-box, .blue-box, .sanctions-container {
            border: 1px solid var(--mdt-border);
            background-color: var(--mdt-bg-secondary);
            padding: 1rem;
            display: grid;
            gap: 1.25rem;
            border-radius: 0.5rem; /* Consistent rounded corners */
        }
        .sanctions-container {
            border-color: var(--mdt-alert-red);
            background-color: rgba(248, 81, 73, 0.1); /* Slightly red tint for sanctions */
        }
        .sanctions-title {
            color: var(--mdt-alert-red);
            font-family: 'Teko', sans-serif;
            font-size: 1.5rem;
            justify-content: center;
            display: flex;
            align-items: center;
        }
        
        /* Buttons */
        .btn {
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 0.85rem;
            padding: 0.6rem 1.2rem;
            border: 1px solid var(--mdt-border-highlight);
            background-color: transparent;
            color: var(--mdt-text-primary);
            text-transform: uppercase;
            transition: all 0.2s ease;
            cursor: pointer;
            border-radius: 0.25rem; /* Rounded corners for buttons */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:hover {
            background-color: var(--mdt-border-highlight);
            color: var(--mdt-bg-tertiary);
        }
        .btn-primary {
            background-color: var(--mdt-text-accent);
            border-color: var(--mdt-text-accent);
            color: var(--mdt-bg-tertiary);
            box-shadow: 0 2px 5px rgba(88, 166, 255, 0.2);
        }
        .btn-primary:hover {
            background-color: #7fbcfd;
            border-color: #7fbcfd;
        }
        .btn-danger {
            background-color: var(--mdt-alert-red);
            border-color: var(--mdt-alert-red);
            color: var(--mdt-text-primary);
            box-shadow: 0 2px 5px rgba(248, 81, 73, 0.2);
        }
        .btn-danger:hover {
            background-color: #ff6e67;
            border-color: #ff6e67;
        }
        .btn-success {
            background-color: var(--mdt-alert-green);
            border-color: var(--mdt-alert-green);
            color: var(--mdt-bg-tertiary);
            box-shadow: 0 2px 5px rgba(63, 185, 80, 0.2);
        }
        .btn-success:hover {
            background-color: #59d56d;
            border-color: #59d56d;
        }

        /* Re-style existing buttons to match new theme */
        .btn-secondary {
            background-color: var(--mdt-bg-secondary);
            color: var(--mdt-text-secondary);
            border: 1px solid var(--mdt-border);
        }
        .btn-secondary:hover {
            border-color: var(--mdt-border-highlight);
            color: var(--mdt-text-primary);
            background-color: #21262d;
        }
        .btn-primary-small {
             background-color: var(--mdt-alert-green); 
             border: 1px solid var(--mdt-alert-green); 
             color: var(--mdt-bg-tertiary);
             padding: 0.4rem 0.8rem;
             font-size: 0.75rem;
             border-radius: 0.25rem;
        }
        .btn-primary-small:hover { 
            background-color: #59d56d; 
            border-color: #59d56d;
        }

        /* Output areas */
        .output-blue-border {
            border-color: var(--mdt-text-accent) !important;
            background-color: var(--mdt-bg);
            color: var(--mdt-text-input);
            min-height: 100px;
            border-radius: 0.25rem;
        }
        .preview-box {
            background-color: var(--mdt-bg);
            color: var(--mdt-text-secondary);
            border: 1px solid var(--mdt-border);
            padding: 0.5rem;
            min-height: 40px;
            font-size: 0.8rem;
            line-height: 1.5;
            white-space: pre-wrap;
            border-radius: 0.25rem;
        }
        .preview-box strong.text-red-500 {
            color: var(--mdt-alert-red);
        }
        .preview-box strong.text-green-400 {
            color: var(--mdt-alert-green);
        }


        .hidden-element { display: none !important; }

        /* Modal styling */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background-color: var(--mdt-bg);
            padding: 1.5rem;
            border: 1px solid var(--mdt-border-highlight);
            width: 90%;
            max-width: 700px;
            box-shadow: 0 0 30px rgba(88, 166, 255, 0.2);
            border-radius: 0.5rem; /* Rounded corners for modals */
            position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none;
            color: var(--mdt-text-secondary); font-size: 1.5rem; cursor: pointer;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: var(--mdt-text-primary);
        }

        /* Toast Notification */
        .toast-message {
            position: fixed; bottom: 20px; right: 20px;
            background-color: var(--mdt-bg-secondary);
            color: var(--mdt-text-primary);
            padding: 1rem 1.5rem;
            border: 1px solid var(--mdt-border-highlight);
            z-index: 2000;
            display: flex; align-items: center; gap: 1rem;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
            border-radius: 0.25rem; /* Rounded corners for toast */
        }
        .toast-message.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .toast-message.success { border-left: 5px solid var(--mdt-alert-green); }
        .toast-message.error { border-left: 5px solid var(--mdt-alert-red); }
        
        /* General layout helpers */
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 1024px) {
            .form-grid { grid-template-columns: repeat(2, 1fr); }
            .form-grid-col-span-2 { grid-column: span 2 / span 2; }
        }
        .form-column { display: flex; flex-direction: column; gap: 1.25rem; }

        /* Specific styles for lists in settings */
        .cod-penal-list-item, .speed-limit-list-item, .vehicle-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--mdt-bg);
            border: 1px solid var(--mdt-border);
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            word-break: break-word; /* Allow long text to break */
        }
        .cod-penal-list-item .actions, .speed-limit-list-item .actions, .vehicle-list-item .actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0; /* Prevent buttons from shrinking */
            margin-left: 1rem; /* Space between text and buttons */
        }
        .settings-list-scrollable {
            max-height: 400px; /* Adjust as needed */
            overflow-y: auto;
            border: 1px solid var(--mdt-border);
            padding: 0.5rem;
            background-color: var(--mdt-bg-secondary);
            border-radius: 0.25rem;
        }

        /* Blinking warning for error messages */
        .blinking-warning {
            animation: blink-animation 1s steps(1, start) infinite;
        }
        @keyframes blink-animation {
            to {
                visibility: hidden;
            }
        }

        /* Verification details box */
        .verification-details {
            background-color: var(--mdt-bg-secondary);
            border: 1px dashed var(--mdt-border-highlight);
            padding: 1rem;
            border-radius: 0.25rem;
            margin-top: 0.75rem;
        }
        .verification-details p {
            margin-bottom: 0.25rem;
        }
        .verification-details .sanction-word {
            font-weight: bold;
        }

        /* Incompatibilities list */
        .incompatibilitati-container {
            background-color: var(--mdt-bg-tertiary); /* Darker background for the list */
            border: 1px solid var(--mdt-border);
            padding: 0.75rem;
            border-radius: 0.25rem;
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* Space between checkboxes */
        }
        .incompatibilitati-container .control-label {
            background-color: var(--mdt-bg);
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            border: 1px solid var(--mdt-border);
            font-size: 0.8rem;
            white-space: nowrap; /* Prevent wrapping for individual items */
        }
        .incompatibilitati-container .control-label input {
            margin-right: 0.3rem;
        }

        /* Martor entry styling */
        .martor-entry {
            background-color: var(--mdt-bg);
            border: 1px dashed var(--mdt-border);
            padding: 1rem;
            border-radius: 0.5rem;
            position: relative;
            margin-bottom: 1rem; /* Space between entries */
        }
        .martor-entry .delete-martor-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--mdt-alert-red);
            color: var(--mdt-text-primary);
            border: none;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .martor-entry .delete-martor-btn:hover {
            background-color: #ff6e67;
        }

        /* General form field spacing */
        .form-group {
            margin-bottom: 1rem;
        }

        /* Specific grid for 2-item rows like substances */
        .grid-row-2-items {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .grid-row-2-items {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .grid-row-3-items {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .grid-row-3-items {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Placeholder list in settings */
        #placeholders-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            background-color: var(--mdt-bg-secondary);
            border: 1px solid var(--mdt-border);
            padding: 0.75rem;
            border-radius: 0.25rem;
        }
        #placeholders-list div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #placeholder-output {
            background-color: var(--mdt-bg);
            border: 1px solid var(--mdt-border);
            padding: 0.5rem;
            min-height: 30px;
            font-size: 0.9rem;
            color: var(--mdt-text-input);
            border-radius: 0.25rem;
            white-space: pre-wrap; /* Preserve line breaks for content */
        }

        /* AI Settings Modal specific styling */
        #aiSettingsModal .modal-content, #compositePlaceholdersModal .modal-content, #ghidModal .modal-content {
            max-width: 900px; /* Wider for code/text editors */
        }
        #aiSettingsModal textarea, #compositePlaceholdersModal textarea, #ghidModal textarea {
            min-height: 150px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
        }

        /* Ghid Editor Toolbar */
        .ghid-editor-toolbar {
            background-color: var(--mdt-bg-secondary);
            border: 1px solid var(--mdt-border);
            border-bottom: none;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .toolbar-button {
            background: none;
            border: 1px solid var(--mdt-border);
            color: var(--mdt-text-secondary);
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }
        .toolbar-button:hover {
            background-color: var(--mdt-border-highlight);
            color: var(--mdt-bg-tertiary);
        }
        #ghidEditor {
            background-color: var(--mdt-bg);
            border: 1px solid var(--mdt-border);
            min-height: 300px;
            padding: 1rem;
            overflow-y: auto;
            border-bottom-left-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
            outline: none; /* Remove default focus outline */
        }
        #tutorialContentContainer {
            background-color: var(--mdt-bg);
            border: 1px solid var(--mdt-border);
            padding: 1rem;
            border-radius: 0.25rem;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }
        #tutorialContentContainer h2 {
            font-family: 'Teko', sans-serif;
            font-size: 1.75rem;
            color: var(--mdt-text-accent);
            border-bottom: 1px solid var(--mdt-border);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        #tutorialContentContainer h3 {
            font-family: 'Teko', sans-serif;
            font-size: 1.25rem;
            color: var(--mdt-text-primary);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #tutorialContentContainer p, #tutorialContentContainer li {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--mdt-text-input);
            margin-bottom: 0.5rem;
        }
        #tutorialContentContainer ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        #tutorialContentContainer blockquote {
            border-left: 4px solid var(--mdt-text-accent);
            background-color: rgba(88, 166, 255, 0.1);
            padding: 0.75rem 1rem;
            margin: 1rem 0;
            color: var(--mdt-text-primary);
            font-style: italic;
            border-radius: 0.25rem;
        }
        #tutorialContentContainer code {
            background-color: var(--mdt-bg-tertiary);
            padding: 0.2em 0.4em;
            border-radius: 0.2em;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85em;
            color: var(--mdt-alert-green);
        }

    </style>
</head>
<body>
    <div class="mdt-container">
        <!-- MDT Header -->
        <header class="mdt-header">
            <div class="flex items-center gap-4">
                <!-- Police Logo -->
                <img src="https://i.imgur.com/PL6J46Q.png" alt="Logo Politia" class="h-10 w-auto">
                <h1 class="logo-title">POLIȚIA ROMÂNĂ - MOBILE DATA TERMINAL</h1>
            </div>
            <div class="status-bar">
                <!-- Display Unit Call Sign -->
                <div class="status-item"><span>UNIT:</span> <span id="patrol-unit-display">N/A</span></div>
                <!-- Display full patrol members' names and ranks -->
                <div class="status-item"><span>PATRULĂ:</span> <span id="patrol-members-display">Nicio patrulă setată</span></div>
                <!-- Removed "STATUS: ONLINE" as requested -->
                <div class="status-item"><span>TIME:</span> <span id="current-time-display">00:00:00</span></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="mdt-main">
            <!-- Main Tab Navigation -->
            <div class="tab-container">
                <button class="tab-button active" data-tab="procesator">PROCESATOR CAZ</button>
                <button class="tab-button" data-tab="db_setari">BAZE DE DATE</button>
                <button class="tab-button" data-tab="app_setari">SETĂRI</button>
            </div>

            <!-- Procesator Tab Content -->
            <div id="procesator" class="tab-content active">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-2">
                        <label for="importAllSettingsFile" id="importAllSettingsLabel" class="btn-secondary cursor-pointer flex items-center gap-2">
                            <i class="fa-solid fa-upload"></i> Încarcă date
                        </label>
                        <input type="file" id="importAllSettingsFile" class="hidden-element" accept=".txt">
                        <p class="text-xs text-gray-500">Încarcă fișierul „mdt_data.txt”</p>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <button type="button" id="seteazaPatrulaBtn" class="btn-secondary flex items-center gap-2"><i class="fa-solid fa-user-shield"></i> Setează Patrulă</button>
                        <div id="patrolDisplay" class="text-xs text-gray-500 mt-1">
                            - Nicio patrulă setată
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="verificare_articol" class="label-text flex items-center gap-2"><i class="fa-solid fa-book-open"></i>Verificare Articol Cod Penal:</label>
                    <div class="input-group">
                         <i class="fa-solid fa-magnifying-glass"></i>
                        <input list="lista_articole_verificare" id="verificare_articol" class="input-field flex-grow" placeholder="Caută articol...">
                    </div>
                    <datalist id="lista_articole_verificare"></datalist>
                    <div id="verificare_articol_details" class="verification-details mt-2 hidden-element p-2 border border-dashed border-gray-600"></div>
                </div>

                <!-- Inceput Formular Procesator -->
                <form id="procesatorForm" class="form-grid"> 
                    <!-- Coloana Stanga -->
                    <div class="form-column">
                        <div class="turquoise-box">
                            <h3><i class="fa-solid fa-users mr-2"></i> Părți Implicate</h3>
                            <div>
                                <label for="nume" class="label-text">Nume și Prenume Inculpat:</label>
                                <div class="input-group"><i class="fa-solid fa-user"></i><input type="text" id="nume" class="input-field" placeholder="Nume inculpat"></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                                <div>
                                    <label for="cnp" class="label-text">CNP Inculpat:</label>
                                    <div class="input-group"><i class="fa-solid fa-id-card"></i><input type="number" id="cnp" class="input-field" placeholder="CNP" min="0"></div>
                                </div>
                                <div>
                                    <label class="label-text">Sex Inculpat:</label>
                                    <div class="control-group mt-1 flex gap-4"><label class="control-label"><input type="radio" name="sex" value="masculin" class="control-input radio-input" checked> Masculin</label><label class="control-label"><input type="radio" name="sex" value="feminin" class="control-input radio-input"> Feminin</label></div>
                                </div>
                            </div>
                            <div>
                                <label for="nume_reclamant" class="label-text">Nume și Prenume Reclamant/Victimă:</label>
                                <div class="input-group"><i class="fa-solid fa-user-injured"></i><input type="text" id="nume_reclamant" class="input-field no-validation" placeholder="Nume reclamant/victimă"></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                                 <div>
                                    <label for="cnp_reclamant" class="label-text">CNP Reclamant/Victimă:</label>
                                     <div class="input-group"><i class="fa-solid fa-id-card"></i><input type="number" id="cnp_reclamant" class="input-field no-validation" placeholder="CNP" min="0"></div>
                                </div>
                                <div>
                                    <label class="label-text">Sex Reclamant/Victimă:</label>
                                    <div class="control-group mt-1 flex gap-4"><label class="control-label"><input type="radio" name="sex_reclamant" value="masculin_reclamant" class="control-input radio-input" checked> Masculin</label><label class="control-label"><input type="radio" name="sex_reclamant" value="feminin_reclamant" class="control-input radio-input"> Feminin</label></div>
                                </div>
                            </div>
                            <div class="border-t border-dashed border-gray-600 my-2"></div>
                            <div>
                                <h4 class="label-text mb-2"><i class="fa-solid fa-user-friends"></i> Martori</h4>
                                <div id="martoriContainer" class="space-y-4"></div>
                                <button type="button" id="adaugaMartorBtn" class="btn-secondary mt-3 text-xs py-1.5 px-3 flex items-center gap-2"><i class="fa-solid fa-plus-circle"></i> Adaugă Martor</button>
                            </div>
                        </div>

                        <div class="magenta-box">
                            <h3><i class="fa-solid fa-bullhorn mr-2"></i>Tip Acțiune</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                                <label class="control-label"><input type="radio" name="actiune" value="standard" class="control-input radio-input" checked> Standard</label>
                                <label class="control-label"><input type="radio" name="actiune" value="apel_112" class="control-input radio-input"> Apel 112</label>
                                <label class="control-label"><input type="radio" name="actiune" value="autoconstatare" class="control-input radio-input"> Autoconstatare</label>
                                <label class="control-label"><input type="radio" name="actiune" value="detectie_focuri_arma" class="control-input radio-input"> Sistem S.R.I.</label>
                                <label class="control-label"><input type="radio" name="actiune" value="alarma_jaf" class="control-input radio-input"> Alarmă Jaf</label>
                                <label class="control-label"><input type="radio" name="actiune" value="razie_mineriada" class="control-input radio-input"> Mineriadă</label>
                                <label class="control-label"><input type="radio" name="actiune" value="razie_rutiera" class="control-input radio-input"> Rutieră</label>
                                <label class="control-label"><input type="radio" name="actiune" value="razie_main" class="control-input radio-input"> Razie</label>
                            </div>
                        </div>
                        
                        <div id="jaf_box" class="orange-box hidden-element">
                            <h3><i class="fa-solid fa-store mr-2"></i> Detalii Jaf</h3>
                            <div>
                                 <label for="obiectiv_jaf" class="label-text">Selectează alarmele:</label>
                                 <select id="obiectiv_jaf" class="select-field"><option value="">Selectează...</option><option value="unui magazin">unui magazin</option><option value="benzinăriei">benzinăriei</option><option value="Băncii FLEECA">Băncii FLEECA</option></select>
                            </div>
                             <div>
                                <label for="locatie_jaf" class="label-text">Locație Jaf:</label>
                                <input type="text" id="locatie_jaf" list="lista_locatii_jaf" class="input-field" placeholder="selectează strada">
                                <datalist id="lista_locatii_jaf"></datalist>
                            </div>
                        </div>

                    </div> <!-- Sfarsit Coloana Stanga -->

                    <!-- Coloana Dreapta -->
                    <div class="form-column">
                        <div class="section-box">
                            <h3><i class="fa-solid fa-map-location-dot mr-2"></i> Locație și Timp</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="zona_input" class="label-text">Zonă / Stradă:</label>
                                    <div class="input-group"><i class="fa-solid fa-road"></i><input list="lista_zone" id="zona_input" name="zona_input" class="input-field" placeholder="Selectează sau scrie strada..."></div>
                                    <datalist id="lista_zone"></datalist>
                                </div>
                                <div>
                                    <label for="limita_viteza_zona" class="label-text">Limită Viteză Zonă:</label>
                                    <input type="text" id="limita_viteza_zona" class="input-field input-field-readonly" placeholder="Automat" readonly>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="data_procesare" class="label-text">Data:</label>
                                    <div class="input-group"><i class="fa-solid fa-calendar-days"></i><input type="text" id="data_procesare" class="input-field"></div>
                                </div>
                                <div>
                                    <label for="ora_procesare" class="label-text">Ora:</label>
                                    <div class="input-group"><i class="fa-solid fa-clock"></i><input type="text" id="ora_procesare" class="input-field"></div>
                                </div>
                                <div class="self-end">
                                    <button type="button" id="actualizeazaDateTimeBtn" class="btn-secondary w-full">ACUM</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="yellow-box">
                             <h3><i class="fa-solid fa-car mr-2"></i> Detalii Vehicul</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="tip_vehicul_procesator" class="label-text">Tip Vehicul:</label>
                                    <select id="tip_vehicul_procesator" class="select-field"><option value="">Selectează tipul...</option></select>
                                </div>
                                <div>
                                    <label for="model_vehicul_input" class="label-text">Model Vehicul:</label>
                                    <div class="flex items-center gap-2">
                                        <input list="lista_modele_vehicule" id="model_vehicul_input" name="model_vehicul_input" class="input-field flex-grow" placeholder="Selectează sau scrie modelul...">
                                        <button type="button" id="adaugaVehiculDinProcesatorBtn" class="btn-secondary whitespace-nowrap !py-2.5">Adaugă</button>
                                    </div>
                                    <datalist id="lista_modele_vehicule"></datalist>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="culoare_vehicul" class="label-text">Culoare:</label>
                                    <input type="text" id="culoare_vehicul" class="input-field" placeholder="Culoarea vehiculului">
                                </div>
                                <div>
                                    <label for="nr_inmatriculare" class="label-text">Nr. Înmatriculare:</label>
                                    <input type="text" id="nr_inmatriculare" class="input-field no-validation" placeholder="Opțional">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                <div>
                                    <label for="viteza_inregistrata" class="label-text">Viteză Înregistrată (km/h):</label>
                                    <input type="number" id="viteza_inregistrata" class="input-field" placeholder="Ex: 70" min="0">
                                </div>
                               <div>
                                   <label for="autospeciala_select" class="label-text">Autospeciala Implicată:</label>
                                   <select id="autospeciala_select" name="autospeciala_select" class="select-field no-validation"><option value="" selected>Fără</option><option value="Autospeciala de Poliție">Autospeciala de Poliție</option><option value="Blindata S.A.S.">Blindata S.A.S.</option><option value="Autospeciala S.M.U.R.D.">Autospeciala S.M.U.R.D.</option></select>
                               </div>
                            </div>
                        </div>
                        
                        <div class="white-box">
                             <h3><i class="fa-solid fa-clipboard-check mr-2"></i> Constatări Suplimentare</h3>
                             <div class="flex flex-wrap gap-x-6 gap-y-2">
                                 <label class="control-label"><input type="checkbox" id="substanta_checkbox" class="control-input checkbox-input"> <i class="fa-solid fa-wine-bottle mx-1"></i> Substanțe</label>
                                 <label class="control-label"><input type="checkbox" id="perchezitie_checkbox" class="control-input checkbox-input"> <i class="fa-solid fa-person-military-searching mx-1"></i> Percheziție</label>
                                 <label class="control-label"><input type="checkbox" id="crima_organizata_checkbox" class="control-input checkbox-input"> <i class="fa-solid fa-people-group mx-1"></i> Crimă Organizată</label>
                                 <label class="control-label"><input type="checkbox" id="licente_checkbox" class="control-input checkbox-input"> <i class="fa-solid fa-id-badge mx-1"></i> Licențe</label>
                             </div>
                             <div id="substanta_container" class="grid-row-2-items hidden-element"><div><label class="label-text">&nbsp;</label><input type="text" id="substanta_influenta" class="input-field max-w-xs" placeholder="Ex: Alcool"></div><div><label for="concentratia" class="label-text">Concentrația:</label><input type="text" id="concentratia" class="input-field max-w-xs" placeholder="Ex: 0.8 mg/L"></div></div>
                             <div id="perchezitie_container" class="grid-row-3-items hidden-element"><div><label for="perchezitie_buzunare" class="label-text text-xs">Buzunare/Arme&Muniție:</label><input type="text" id="perchezitie_buzunare" class="input-field" placeholder="Descriere obiecte găsite"></div><div><label for="perchezitie_torpedo" class="label-text text-xs">Torpedo:</label><input type="text" id="perchezitie_torpedo" class="input-field" placeholder="Descriere obiecte găsite"></div><div><label for="perchezitie_portbagaj" class="label-text text-xs">Portbagaj:</label><input type="text" id="perchezitie_portbagaj" class="input-field" placeholder="Descriere obiecte găsite"></div></div>
                             <div id="crima_organizata_container" class="hidden-element space-y-4"><div class="grid-row-2-items"><div><label for="tigari_contrabanda" class="label-text">Țigări de contrabandă:</label><input type="number" id="tigari_contrabanda" class="input-field max-w-xs" placeholder="Cantitate" min="0"></div><div><label for="bani_murdari" class="label-text">Bani nemarcați/murdari:</label><input type="number" id="bani_murdari" class="input-field max-w-xs" placeholder="Cantitate" min="0"></div></div><div class="grid-row-2-items"><div><label for="droguri_risc" class="label-text">Droguri de Risc:</label><input type="text" id="droguri_risc" class="input-field max-w-xs" placeholder="Cantitate și drog"></div><div><label for="droguri_mare_risc" class="label-text">Droguri de Mare Risc:</label><input type="text" id="droguri_mare_risc" class="input-field max-w-xs" placeholder="Cantitate și drog"></div></div></div>
                             <div id="licente_container" class="hidden-element space-y-4 mt-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="lipsa_licenta_1" class="label-text">Lipsă document 1:</label><select id="lipsa_licenta_1" name="lipsa_licenta_1" class="select-field"><option value="">Niciunul</option><option value="buletin">buletin</option><option value="permis de conducere">permis de conducere</option><option value="licență de miner">licență de miner</option><option value="licență de pescar">licență de pescar</option><option value="licență de transport comercial">licență de transport comercial</option><option value="licență de tractat">licență de tractat</option><option value="licență de pilot">licență de pilot</option><option value="licență de navigație">licență de navigație</option><option value="permis de port-arme">permis de port-arme</option></select></div>
                                    <div><label for="lipsa_licenta_2" class="label-text">Lipsă document 2:</label><select id="lipsa_licenta_2" name="lipsa_licenta_2" class="select-field"><option value="">Niciunul</option><option value="buletin">buletin</option><option value="permis de conducere">permis de conducere</option><option value="licență de miner">licență de miner</option><option value="licență de pescar">licență de pescar</option><option value="licență de transport comercial">licență de transport comercial</option><option value="licență de tractat">licență de tractat</option><option value="licență de pilot">licență de pilot</option><option value="licență de navigație">licență de navigație</option><option value="permis de port-arme">permis de port-arme</option></select></div>
                                </div>
                                <div><label for="braconaj_materiale" class="label-text">Braconaj / Materiale confiscate:</label><textarea id="braconaj_materiale" class="textarea-field" placeholder="Pești sau materiale deținute fără licență"></textarea></div>
                             </div>
                        </div>
                    </div> <!-- Sfarsit Coloana Dreapta -->

                    <!-- Infracțiuni & Sancțiuni - Full Width -->
                    <div class="form-grid-col-span-2">
                        <div class="blue-box">
                            <h3><i class="fa-solid fa-file-signature mr-2"></i> Încadrare Fapte</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                                <div class="space-y-2"><label for="infractiune1" class="label-text">Infracțiune 1:</label><input type="text" id="infractiune1" class="input-field infractiune-input" placeholder="Caută..." list="lista_infractiuni_datalist"><div id="feedbackInfractiune1" class="infraction-feedback hidden-element"></div><label for="preview_template1" class="label-text mt-2">Previzualizare Șablon:</label><div id="preview_template1" class="preview-box"></div><label for="mentiuni1" class="label-text">Mențiuni 1:</label><textarea id="mentiuni1" class="textarea-field no-validation" rows="2" placeholder="Detalii suplimentare..."></textarea></div>
                                <div class="space-y-2"><label for="infractiune2" class="label-text">Infracțiune 2:</label><input type="text" id="infractiune2" class="input-field infractiune-input no-validation" placeholder="Caută..." list="lista_infractiuni_datalist"><div id="feedbackInfractiune2" class="infraction-feedback hidden-element"></div><label for="preview_template2" class="label-text mt-2">Previzualizare Șablon:</label><div id="preview_template2" class="preview-box"></div><label for="mentiuni2" class="label-text">Mențiuni 2:</label><textarea id="mentiuni2" class="textarea-field no-validation" rows="2" placeholder="Detalii suplimentare..."></textarea></div>
                                <div class="space-y-2"><label for="infractiune3" class="label-text">Infracțiune 3:</label><input type="text" id="infractiune3" class="input-field infractiune-input no-validation" placeholder="Caută..." list="lista_infractiuni_datalist"><div id="feedbackInfractiune3" class="infraction-feedback hidden-element"></div><label for="preview_template3" class="label-text mt-2">Previzualizare Șablon:</label><div id="preview_template3" class="preview-box"></div><label for="mentiuni3" class="label-text">Mențiuni 3:</label><textarea id="mentiuni3" class="textarea-field no-validation" rows="2" placeholder="Detalii suplimentare..."></textarea></div>
                            </div>
                            <datalist id="lista_infractiuni_datalist"></datalist>
                            <div id="globalInfractionError" class="text-red-600 font-bold mt-2 hidden-element text-center"></div>
                        </div>
                    </div>

                    <div class="form-grid-col-span-2">
                        <div class="sanctions-container">
                            <h2 class="sanctions-title flex items-center gap-2"><i class="fa-solid fa-gavel"></i> Sancțiuni Aplicate (Automat)</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 items-start">
                                <div><label for="amenda_totala" class="label-text">Amendă ($):</label><div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">$</span><input type="number" id="amenda_totala" class="input-field pl-7 w-[200px]" placeholder="Calculat"></div></div>
                                <div class="grid grid-cols-2 gap-4"><div><label for="arest_total_min" class="label-text">Arest Min (luni):</label><input type="number" id="arest_total_min" class="input-field" placeholder="Calculat" min="0"></div><div><label for="arest_total_max" class="label-text">Arest Max (luni):</label><input type="number" id="arest_total_max" class="input-field" placeholder="Calculat" min="0"></div></div>
                            </div>
                            <div class="flex flex-wrap gap-x-6 gap-y-2 items-center mt-4"><div class="flex-shrink-0 flex-grow"><label for="puncte_permis" class="label-text">Puncte Permis:</label><input type="number" id="puncte_permis" class="input-field w-[120px]" placeholder="Calculat" min="0"></div><label class="control-label"><input type="checkbox" id="anulare_permis" class="control-input checkbox-input"> Anulare permis</label><label class="control-label"><input type="checkbox" id="ridicare_vehicul" class="control-input checkbox-input"> Ridicare vehicul</label><label class="control-label"><input type="checkbox" id="perchezitie_masura" class="control-input checkbox-input"> Percheziție</label></div>
                            <div id="locatie_detentie_container" class="mt-4"><label for="locatie_detentie" class="label-text">Locație detenție:</label><select id="locatie_detentie" class="select-field"><option value="Penitenciarul Sandy" selected>Penitenciarul Sandy</option><option value="celulele din Secția Sandy">celulele din Secția Sandy</option><option value="celulele din Secția Centrală">celulele din Secția Centrală</option><option value="celulele din secția Secundară">celulele din secția Secundară</option></select></div>
                        </div>
                    </div>

                    <!-- Butoane actiune - se intind pe ambele coloane -->
                    <div class="form-grid-col-span-2">
                        <div class="border-t border-dashed border-gray-600 my-4"></div>
                        <div class="section-box bg-gray-900/50">
                            <button type="button" id="generateCaseDescriptionBtn" class="btn btn-primary w-full text-lg">
                                <i class="fa-solid fa-cogs mr-2"></i> GENEREAZĂ RAPORT CAZ
                            </button>
                            <div id="caseDescriptionLoading" class="loading-indicator hidden-element mt-2 text-center text-yellow-400">Se generează descrierea...</div>
                            <textarea id="generatedTitlesOutput" class="textarea-field mt-2 hidden-element output-blue-border" rows="2" readonly placeholder="Titlu generat..."></textarea>
                            <textarea id="caseDescriptionOutput" class="textarea-field mt-2 hidden-element output-blue-border" rows="15" readonly placeholder="Descriere generată..."></textarea>
                        </div>

                        <div class="mt-4 flex flex-col sm:flex-row gap-4"> 
                            <button type="button" id="copyTitlesBtn" class="btn btn-success flex-grow">Copiază Titlu</button>
                            <button type="button" id="copyDescriptionBtn" class="btn btn-success flex-grow">Copiază Descriere</button>
                            <button type="button" id="resetFormBtn" class="btn btn-danger flex-grow">Resetează Formular</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- DB Settings Tab Content -->
            <div id="db_setari" class="tab-content">
                <!-- Content for DB Settings remains the same, but will inherit new styles -->
                <div class="global-settings-actions mb-4">
                    <button type="button" id="exportAllSettingsBtn" class="btn-secondary">Salvează Toate Datele</button>
                </div>
                <div class="sub-tab-container flex gap-2 border-b border-gray-700 mb-4">
                    <button class="sub-tab-button active" data-subtab="cod_penal_settings">Cod Penal</button>
                    <button class="sub-tab-button" data-subtab="vehicule_settings">Vehicule</button>
                    <button class="sub-tab-button" data-subtab="limite_viteza_settings">Limite de viteză</button>
                </div>
                <div id="cod_penal_settings" class="sub-tab-content active">
                     <h3 class="text-lg font-bold mt-4 mb-2 flex items-center gap-2"><i class="fa-solid fa-gavel"></i> Adaugă/Modifică Articol Cod Penal</h3>
                    <form id="codPenalForm" class="space-y-4 p-4 border border-dashed border-gray-700 rounded-md">
                        <div class="grid grid-cols-1 md:grid-cols-[auto_auto_1fr] gap-4 items-start">
                            <div><label for="articol_cap" class="label-text">Capitol:</label><input type="text" id="articol_cap" class="input-field max-w-[120px]" placeholder="Ex: Cap. 3"></div>
                            <div><label for="articol_numar_input" class="label-text">Număr Articol:</label><input type="text" id="articol_numar_input" class="input-field max-w-[150px]" placeholder="Ex: 1.2"></div>
                            <div><label for="articol_titlu" class="label-text">Titlul Infracțiunii:</label><input type="text" id="articol_titlu" class="input-field" placeholder="Titlul Legii"></div>
                        </div>
                        <div><label for="articol_definitie" class="label-text">Definiție / Descriere:</label><textarea id="articol_definitie" class="textarea-field" placeholder="Definește legea"></textarea></div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label for="articol_amenda_min" class="label-text">Amendă Min ($):</label><input type="number" id="articol_amenda_min" class="input-field" placeholder="min" min="0"></div>
                            <div><label for="articol_amenda_max" class="label-text">Amendă Max ($):</label><input type="number" id="articol_amenda_max" class="input-field" placeholder="max" min="0"></div>
                            <div><label for="articol_arest_min" class="label-text">Arest Min (luni):</label><input type="number" id="articol_arest_min" class="input-field" placeholder="min" min="0"></div>
                            <div class="flex items-end gap-2">
                                <div class="flex-grow"><label for="articol_arest_max" class="label-text">Arest Max (luni):</label><input type="number" id="articol_arest_max" class="input-field" placeholder="max" min="0"></div>
                                <label class="control-label whitespace-nowrap"><input type="checkbox" id="articol_arest_pe_viata" class="control-input checkbox-input"> Pe viață</label>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-end gap-4">
                            <button type="button" id="editeazaDescrieriBtn" class="btn-secondary self-end">Editează Descrieri</button>
                            <div class="flex-shrink-0"><label for="articol_puncte_permis" class="label-text">Puncte Permis:</label><input type="number" id="articol_puncte_permis" class="input-field max-w-[80px]" placeholder="0" min="0"></div>
                            <div class="flex-grow"><label class="label-text">Sancțiuni:</label><div class="control-group flex flex-wrap gap-4"><label class="control-label"><input type="checkbox" id="articol_anulare_permis" class="control-input checkbox-input"> Anulare Permis</label><label class="control-label"><input type="checkbox" id="articol_ridicare_vehicul" class="control-input checkbox-input"> Ridicare Vehicul</label><label class="control-label"><input type="checkbox" id="articol_perchezitie" class="control-input checkbox-input"> Percheziție</label></div></div>
                        </div>
                        <textarea id="articol_model_descriere_1" class="hidden-element"></textarea><textarea id="articol_model_descriere_2" class="hidden-element"></textarea><textarea id="articol_model_descriere_3" class="hidden-element"></textarea>
                         <div class="mt-2"><label id="incompatibilitatiLabel" class="label-text">Incompatibilități (nu se cumulează cu): <span id="incompatibilitatiCount">(0)</span></label><div id="incompatibilitatiListContainer" class="incompatibilitati-container max-h-[150px] overflow-y-auto p-2 border border-gray-700 bg-black/20"></div></div>
                        <div class="settings-actions"><button type="submit" id="salveazaArticolBtn" class="btn-primary-small">Salvează Articol</button></div>
                    </form>
                    <div class="border-t border-gray-700 my-6"></div>
                    <h3 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-list-ul"></i> Listă Articole Cod Penal</h3>
                    <div id="listaArticoleCodPenal" class="space-y-2 settings-list-scrollable max-h-96 overflow-y-auto p-2 border border-gray-800"></div>
                </div>

                <div id="vehicule_settings" class="sub-tab-content">
                    <h3 class="text-lg font-bold mt-4 mb-2 flex items-center gap-2"><i class="fa-solid fa-car"></i> Adaugă/Modifică Vehicul Personalizat</h3>
                    <div class="space-y-4 p-4 border border-dashed border-gray-700 rounded-md">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="vehicle_type_settings" class="label-text">Tip Vehicul:</label>
                                <select id="vehicle_type_settings" class="select-field">
                                    <option value="">Selectează tipul...</option>
                                </select>
                            </div>
                            <div>
                                <label for="vehicle_model_settings_input" class="label-text">Model Vehicul:</label>
                                <input type="text" id="vehicle_model_settings_input" class="input-field" placeholder="Ex: Audi A4">
                            </div>
                        </div>
                        <div class="settings-actions">
                            <button type="button" id="addCustomVehicleBtn" class="btn-primary-small">Adaugă Vehicul</button>
                        </div>
                    </div>
                    <div class="border-t border-gray-700 my-6"></div>
                    <h3 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-list-alt"></i> Listă Vehicule Personalizate</h3>
                    <div id="customVehicleList" class="space-y-2 settings-list-scrollable"></div>
                </div>

                <div id="limite_viteza_settings" class="sub-tab-content">
                    <h3 class="text-lg font-bold mt-4 mb-2 flex items-center gap-2"><i class="fa-solid fa-road"></i> Adaugă/Modifică Limită de Viteză</h3>
                    <div class="space-y-4 p-4 border border-dashed border-gray-700 rounded-md">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="street_name_settings_input" class="label-text">Nume Stradă/Zonă:</label>
                                <input type="text" id="street_name_settings_input" class="input-field" placeholder="Ex: Bulevardul Libertății">
                            </div>
                            <div>
                                <label for="speed_limit_settings_input" class="label-text">Limită Viteză (km/h):</label>
                                <input type="number" id="speed_limit_settings_input" class="input-field" placeholder="Ex: 50" min="0">
                            </div>
                        </div>
                        <div class="settings-actions">
                            <button type="button" id="addSpeedLimitBtn" class="btn-primary-small">Adaugă Limită</button>
                        </div>
                    </div>
                    <div class="border-t border-gray-700 my-6"></div>
                    <h3 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-list-ol"></i> Listă Limite de Viteză</h3>
                    <div id="speedLimitListUL" class="space-y-2 settings-list-scrollable"></div>
                </div>
            </div>

            <!-- App Settings Tab Content -->
            <div id="app_setari" class="tab-content">
                <div class="sub-tab-container flex gap-2 border-b border-gray-700 mb-4">
                    <button class="sub-tab-button active" data-subtab="placeholders_subtab">Placeholders</button>
                    <button class="sub-tab-button" data-subtab="aspect_subtab">Aspect</button>
                    <button class="sub-tab-button" data-subtab="templates_subtab">Șabloane & Avansat</button>
                    <button class="sub-tab-button" data-subtab="ghid_subtab">Ghid</button>
                </div>

                <div id="placeholders_subtab" class="sub-tab-content">
                    <h3 class="text-lg font-bold mt-4 mb-2 flex items-center gap-2"><i class="fa-solid fa-code"></i> Placeholders Disponibili</h3>
                    <p class="text-sm text-gray-400 mb-4">Dă click pe un placeholder pentru a-l copia. Aceasta este o listă completă a tuturor placeholderilor dinamici.</p>
                    <div id="placeholders-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                        <!-- Placeholders will be populated here by JS -->
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row gap-4 items-center">
                        <button type="button" id="exportPlaceholdersBtn" class="btn-secondary flex-grow"><i class="fa-solid fa-download"></i> Exportă Lista</button>
                        <div class="input-group flex-grow">
                             <i class="fa-solid fa-question-circle"></i>
                            <input type="text" id="placeholder-input" class="input-field flex-grow" placeholder="Verifică valoarea unui placeholder (ex: {nume})">
                        </div>
                    </div>
                    <div id="placeholder-output" class="mt-2 p-2 border border-dashed border-gray-600 min-h-[40px] text-sm flex items-center">
                        <!-- Placeholder value will be displayed here -->
                    </div>
                    <button type="button" id="showCompositePlaceholdersBtn" class="btn-secondary mt-4"><i class="fa-solid fa-puzzle-piece"></i> Editează Placeholders Compusi</button>
                </div>

                <div id="aspect_subtab" class="sub-tab-content">
                    <h3 class="text-lg font-bold mt-4 mb-2 flex items-center gap-2"><i class="fa-solid fa-palette"></i> Personalizare Aspect</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="color-mdt-bg" class="label-text">Fundal Principal (Culoare):</label>
                            <input type="color" id="color-mdt-bg" class="w-full h-10 rounded-md" data-color-var="mdt-bg">
                            <label for="alpha-mdt-bg" class="label-text mt-2">Transparență:</label>
                            <div class="flex items-center gap-2">
                                <input type="range" id="alpha-mdt-bg" min="0" max="1" step="0.01" value="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" data-color-var="mdt-bg">
                                <span id="alpha-value-mdt-bg" class="text-xs text-gray-400 w-10 text-right">1.00</span>
                            </div>
                        </div>
                        <div>
                            <label for="color-mdt-bg-secondary" class="label-text">Fundal Secundar (Culoare):</label>
                            <input type="color" id="color-mdt-bg-secondary" class="w-full h-10 rounded-md" data-color-var="mdt-bg-secondary">
                            <label for="alpha-mdt-bg-secondary" class="label-text mt-2">Transparență:</label>
                            <div class="flex items-center gap-2">
                                <input type="range" id="alpha-mdt-bg-secondary" min="0" max="1" step="0.01" value="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" data-color-var="mdt-bg-secondary">
                                <span id="alpha-value-mdt-bg-secondary" class="text-xs text-gray-400 w-10 text-right">1.00</span>
                            </div>
                        </div>
                        <div>
                            <label for="color-mdt-bg-tertiary" class="label-text">Fundal Terțiar (Culoare):</label>
                            <input type="color" id="color-mdt-bg-tertiary" class="w-full h-10 rounded-md" data-color-var="mdt-bg-tertiary">
                            <label for="alpha-mdt-bg-tertiary" class="label-text mt-2">Transparență:</label>
                            <div class="flex items-center gap-2">
                                <input type="range" id="alpha-mdt-bg-tertiary" min="0" max="1" step="0.01" value="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" data-color-var="mdt-bg-tertiary">
                                <span id="alpha-value-mdt-tertiary" class="text-xs text-gray-400 w-10 text-right">1.00</span>
                            </div>
                        </div>
                        <div>
                            <label for="color-mdt-border" class="label-text">Culoare Borduri:</label>
                            <input type="color" id="color-mdt-border" class="w-full h-10 rounded-md" data-color-var="mdt-border">
                        </div>
                        <div>
                            <label for="color-mdt-border-highlight" class="label-text">Borduri Evidențiate:</label>
                            <input type="color" id="color-mdt-border-highlight" class="w-full h-10 rounded-md" data-color-var="mdt-border-highlight">
                        </div>
                        <div>
                            <label for="color-mdt-text-primary" class="label-text">Text Principal:</label>
                            <input type="color" id="color-mdt-text-primary" class="w-full h-10 rounded-md" data-color-var="mdt-text-primary">
                        </div>
                        <div>
                            <label for="color-mdt-text-secondary" class="label-text">Text Secundar:</label>
                            <input type="color" id="color-mdt-text-secondary" class="w-full h-10 rounded-md" data-color-var="mdt-text-secondary">
                        </div>
                        <div>
                            <label for="color-mdt-text-accent" class="label-text">Culoare Accent:</label>
                            <input type="color" id="color-mdt-text-accent" class="w-full h-10 rounded-md" data-color-var="mdt-text-accent">
                        </div>
                        <div>
                            <label for="color-mdt-text-input" class="label-text">Text Input:</label>
                            <input type="color" id="color-mdt-text-input" class="w-full h-10 rounded-md" data-color-var="mdt-text-input">
                        </div>
                        <div>
                            <label for="color-mdt-alert-red" class="label-text">Alertă Roșu:</label>
                            <input type="color" id="color-mdt-alert-red" class="w-full h-10 rounded-md" data-color-var="mdt-alert-red">
                        </div>
                        <div>
                            <label for="color-mdt-alert-yellow" class="label-text">Alertă Galben:</label>
                            <input type="color" id="color-mdt-alert-yellow" class="w-full h-10 rounded-md" data-color-var="mdt-alert-yellow">
                        </div>
                        <div>
                            <label for="color-mdt-alert-green" class="label-text">Alertă Verde:</label>
                            <input type="color" id="color-mdt-alert-green" class="w-full h-10 rounded-md" data-color-var="mdt-alert-green">
                        </div>
                    </div>
                    <button type="button" id="resetColorsBtn" class="btn-secondary mt-6"><i class="fa-solid fa-undo"></i> Resetează Culorile</button>
                </div>

                <div id="templates_subtab" class="sub-tab-content">
                    <h3 class="text-lg font-bold mt-4 mb-2 flex items-center gap-2"><i class="fa-solid fa-file-code"></i> Șabloane de Bază (Introducere/Sancțiuni)</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="template_intro_standard" class="label-text">Introducere Standard:</label>
                            <textarea id="template_intro_standard" class="textarea-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="template_intro_apel_112" class="label-text">Introducere Apel 112:</label>
                            <textarea id="template_intro_apel_112" class="textarea-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="template_intro_autoconstatare" class="label-text">Introducere Autoconstatare:</label>
                            <textarea id="template_intro_autoconstatare" class="textarea-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="template_intro_detectie_focuri_arma" class="label-text">Introducere Sistem S.R.I. (Focuri Armă):</label>
                            <textarea id="template_intro_detectie_focuri_arma" class="textarea-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="template_intro_alarma_jaf" class="label-text">Introducere Alarmă Jaf:</label>
                            <textarea id="template_intro_jaf" class="textarea-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="template_intro_razie_mineriada" class="label-text">Introducere Razie Mineriadă:</label>
                            <textarea id="template_intro_mineriada" class="textarea-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="template_intro_razie_rutiera" class="label-text">Introducere Razie Rutieră:</label>
                            <textarea id="template_intro_rutiera" class="textarea-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="template_intro_razie_main" class="label-text">Introducere Razie Generală:</label>
                            <textarea id="template_intro_razie_sas" class="textarea-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="template_sanctions" class="label-text">Șablon Sancțiuni Finale:</label>
                            <textarea id="template_sanctions" class="textarea-field" rows="3"></textarea>
                        </div>
                    </div>
                    <button type="button" id="saveAiLogicBtn" class="btn-primary mt-6"><i class="fa-solid fa-save"></i> Salvează Șabloanele</button>
                    
                    <h3 class="text-lg font-bold mt-8 mb-2 flex items-center gap-2"><i class="fa-solid fa-robot"></i> Setări Avansate de Generare (AI)</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="ai_prompt_instructions" class="label-text">Instrucțiuni AI (Prompt):</label>
                            <textarea id="ai_prompt_instructions" class="textarea-field" rows="4" readonly></textarea>
                            <p class="text-xs text-gray-500 mt-1">Acest câmp este doar pentru vizualizare. Logica AI este predefinită.</p>
                        </div>
                        <div>
                            <label for="title_separator_input" class="label-text">Separator Titlu:</label>
                            <input type="text" id="title_separator_input" class="input-field" placeholder="Ex: ; ">
                        </div>
                        <div>
                            <label for="title_format_input" class="label-text">Format Titlu:</label>
                            <input type="text" id="title_format_input" class="input-field" placeholder="Ex: {titluri_infractiuni} ({capitol_principal})">
                        </div>
                        <div>
                            <label for="composite_header_template" class="label-text">Șablon Antet Raport:</label>
                            <textarea id="composite_header_template" class="textarea-field" rows="6"></textarea>
                        </div>
                    </div>
                    <button type="button" id="aiSettingsBtn" class="btn-primary mt-6"><i class="fa-solid fa-cog"></i> Editează Setări Avansate</button>
                </div>

                <div id="ghid_subtab" class="sub-tab-content">
                    <h3 class="text-lg font-bold mt-4 mb-2 flex items-center gap-2"><i class="fa-solid fa-book"></i> Ghid de Utilizare</h3>
                    <div id="tutorialContentContainer" class="mb-4">
                        <!-- Content loaded from localStorage or defaultGhidHTML -->
                    </div>
                    <button type="button" id="editGhidBtn" class="btn-secondary"><i class="fa-solid fa-edit"></i> Editează Ghidul</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (structure remains, styles inherited) -->
    <!-- Agenti Modal -->
    <div id="agentiModal" class="modal-overlay hidden-element">
        <div class="modal-content">
            <button id="closeAgentiModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center text-sky-400">Setează Patrula</h3>
            <div class="space-y-6">
                 <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center"><input type="checkbox" style="visibility: hidden;" class="control-input checkbox-input"><h4 class="text-lg font-medium text-sky-500 mb-2 col-span-3">Agent Operativ:</h4></div>
                <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center">
                    <input type="checkbox" style="visibility: hidden;" class="control-input checkbox-input">
                    <div><input type="text" id="agent_op_call_sign_modal" class="input-field max-w-[100px]" placeholder="CS"></div>
                    <div><select id="agent_op_grad_modal" class="select-field max-w-xs"><option value="" disabled selected>Alege Grad...</option><option value="Cadet">Cadet</option><option value="Agent">Agent</option><option value="Agent Principal">Agent Principal</option><option value="Agent Șef Adjunct">Agent Șef Adjunct</option><option value="Agent Șef Principal">Agent Șef Principal</option><option value="Inspector">Inspector</option><option value="Inspector Principal">Inspector Principal</option><option value="Subcomisar">Subcomisar</option><option value="Comisar">Comisar</option><option value="Comisar Șef">Comisar Șef</option><option value="Chestor Adjunct">Chestor Adjunct</option><option value="Chestor">Chestor</option><option value="Agent S.A.S.">Agent S.A.S.</option><option value="Agent Special S.A.S.">Agent Special S.A.S.</option><option value="Coordonator S.A.S.">Coordonator S.A.S.</option><option value="Comandant Șef S.A.S.">Comandant Șef S.A.S.</option></select></div>
                    <div><input type="text" id="agent_op_nume_modal" class="input-field" placeholder="Numele tău"></div>
                </div>
                <div>
                    <h4 class="text-lg font-medium text-sky-500 mb-2">Agent Constatator:</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center">
                         <input type="checkbox" id="include_agent_const_checkbox_modal" class="control-input checkbox-input">
                        <div><input type="text" id="agent_const_call_sign_modal" class="input-field max-w-[100px]" placeholder="CS"></div>
                        <div><select id="agent_const_grad_modal" class="select-field max-w-xs"><option value="" disabled selected>Alege Grad...</option><option value="Cadet">Cadet</option><option value="Agent">Agent</option><option value="Agent Principal">Agent Principal</option><option value="Agent Șef Adjunct">Agent Șef Adjunct</option><option value="Agent Șef Principal">Agent Șef Principal</option><option value="Inspector">Inspector</option><option value="Inspector Principal">Inspector Principal</option><option value="Subcomisar">Subcomisar</option><option value="Comisar">Comisar</option><option value="Comisar Șef">Comisar Șef</option><option value="Chestor Adjunct">Chestor Adjunct</option><option value="Chestor">Chestor</option><option value="Agent S.A.S.">Agent S.A.S.</option><option value="Agent Special S.A.S.">Agent Special S.A.S.</option><option value="Coordonator S.A.S.">Coordonator S.A.S.</option><option value="Comandant Șef S.A.S.">Comandant Șef S.A.S.</option></select></div>
                        <div><input type="text" id="agent_const_nume_modal" class="input-field" placeholder="Numele colegului de patrulă"></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-medium text-sky-500 mb-2">Agent Adițional:</h4>
                     <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center">
                        <input type="checkbox" id="include_agent_ad1_checkbox_modal" class="control-input checkbox-input">
                        <div><input type="text" id="agent_ad1_call_sign_modal" class="input-field max-w-[100px]" placeholder="CS"></div>
                        <div><select id="agent_ad1_grad_modal" class="select-field max-w-xs"><option value="" disabled selected>Alege Grad...</option><option value="Cadet">Cadet</option><option value="Agent">Agent</option><option value="Agent Principal">Agent Principal</option><option value="Agent Șef Adjunct">Agent Șef Adjunct</option><option value="Agent Șef Principal">Agent Șef Principal</option><option value="Inspector">Inspector</option><option value="Inspector Principal">Inspector Principal</option><option value="Subcomisar">Subcomisar</option><option value="Comisar">Comisar</option><option value="Comisar Șef">Comisar Șef</option><option value="Chestor Adjunct">Chestor Adjunct</option><option value="Chestor">Chestor</option><option value="Agent S.A.S.">Agent S.A.S.</option><option value="Agent Special S.A.S.">Agent Special S.A.S.</option><option value="Coordonator S.A.S.">Coordonator S.A.S.</option><option value="Comandant Șef S.A.S.">Comandant Șef S.A.S.</option></select></div>
                        <div><input type="text" id="agent_ad1_nume_modal" class="input-field" placeholder="Numele colegului de patrulă"></div>
                    </div>
                </div>
                 <div>
                    <h4 class="text-lg font-medium text-sky-500 mb-2">Agent Adițional:</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center">
                        <input type="checkbox" id="include_agent_ad2_checkbox_modal" class="control-input checkbox-input">
                        <div><input type="text" id="agent_ad2_call_sign_modal" class="input-field max-w-[100px]" placeholder="CS"></div>
                        <div><select id="agent_ad2_grad_modal" class="select-field max-w-xs"><option value="" disabled selected>Alege Grad...</option><option value="Cadet">Cadet</option><option value="Agent">Agent</option><option value="Agent Principal">Agent Principal</option><option value="Agent Șef Adjunct">Agent Șef Adjunct</option><option value="Agent Șef Principal">Agent Șef Principal</option><option value="Inspector">Inspector</option><option value="Inspector Principal">Inspector Principal</option><option value="Subcomisar">Subcomisar</option><option value="Comisar">Comisar</option><option value="Comisar Șef">Comisar Șef</option><option value="Chestor Adjunct">Chestor Adjunct</option><option value="Chestor">Chestor</option><option value="Agent S.A.S.">Agent S.A.S.</option><option value="Agent Special S.A.S.">Agent Special S.A.S.</option><option value="Coordonator S.A.S.">Coordonator S.A.S.</option><option value="Comandant Șef S.A.S.">Comandant Șef S.A.S.</option></select></div>
                        <div><input type="text" id="agent_ad2_nume_modal" class="input-field" placeholder="Numele colegului de patrulă"></div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-start gap-3">
                <button type="button" id="anuleazaAgentiModalBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaAgentiModalBtn" class="btn-primary-small">Salvează Patrula</button>
            </div>
        </div>
    </div>

    <!-- Descrieri Modal -->
    <div id="descrieriModal" class="modal-overlay hidden-element">
        <div class="modal-content">
            <button id="closeDescrieriModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center text-sky-400">Editează Descrierile Articolului</h3>
            <div class="space-y-4">
                <div>
                    <label for="modal_articol_model_descriere_1" class="label-text">Descriere 1:</label>
                    <textarea id="modal_articol_model_descriere_1" class="textarea-field" rows="5" placeholder="Șablon pentru prima infracțiune"></textarea>
                </div>
                <div>
                    <label for="modal_articol_model_descriere_2" class="label-text">Descriere 2:</label>
                    <textarea id="modal_articol_model_descriere_2" class="textarea-field" rows="5" placeholder="Șablon pentru a doua infracțiune"></textarea>
                </div>
                <div>
                    <label for="modal_articol_model_descriere_3" class="label-text">Descriere 3:</label>
                    <textarea id="modal_articol_model_descriere_3" class="textarea-field" rows="5" placeholder="Șablon pentru a treia infracțiune"></textarea>
                </div>
            </div>
            <div class="mt-8 flex justify-start gap-3">
                <button type="button" id="anuleazaDescrieriModalBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaDescrieriModalBtn" class="btn-primary-small">Salvează Descrierile</button>
            </div>
        </div>
    </div>

    <!-- AI Settings Modal -->
    <div id="aiSettingsModal" class="modal-overlay hidden-element">
        <div class="modal-content">
            <button id="closeAiSettingsModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center text-sky-400">Setări Avansate de Generare (AI)</h3>
            <div class="space-y-4">
                <div>
                    <label for="ai_prompt_instructions_modal" class="label-text">Instrucțiuni AI (Prompt):</label>
                    <textarea id="ai_prompt_instructions_modal" class="textarea-field" rows="4" placeholder="Instrucțiuni pentru modelul AI"></textarea>
                </div>
                <div>
                    <label for="title_separator_input_modal" class="label-text">Separator Titlu:</label>
                    <input type="text" id="title_separator_input_modal" class="input-field" placeholder="Ex: ; ">
                </div>
                <div>
                    <label for="title_format_input_modal" class="label-text">Format Titlu:</label>
                    <input type="text" id="title_format_input_modal" class="input-field" placeholder="Ex: {titluri_infractiuni} ({capitol_principal})">
                </div>
                <div>
                    <label for="composite_header_template_modal" class="label-text">Șablon Antet Raport:</label>
                    <textarea id="composite_header_template_modal" class="textarea-field" rows="6" placeholder="Definiți structura antetului raportului"></textarea>
                </div>
            </div>
            <div class="mt-8 flex justify-start gap-3">
                <button type="button" id="anuleazaAiSettingsModalBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaAiSettingsModalBtn" class="btn-primary-small">Salvează Setările</button>
            </div>
        </div>
    </div>

    <!-- Composite Placeholders Modal -->
    <div id="compositePlaceholdersModal" class="modal-overlay hidden-element">
        <div class="modal-content">
            <button id="closeCompositePlaceholdersModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center text-sky-400">Editează Placeholders Compusi</h3>
            <p class="text-sm text-gray-400 mb-4">Acești placeholders sunt generați din mai multe câmpuri sau au o logică condițională. Folosește <code>[VALOARE]</code> pentru a insera valoarea unui câmp, <code>[NUME_RECLAMANT]</code>, <code>[CNP_RECLAMANT]</code> etc.</p>
            <div class="space-y-4">
                <div>
                    <label for="composite_nr_inmatriculare_filled" class="label-text">Nr. Înmatriculare (Când e completat):</label>
                    <input type="text" id="composite_nr_inmatriculare_filled" class="input-field" placeholder="Ex: cu numerele de înmatriculare [VALOARE]">
                </div>
                <div>
                    <label for="composite_nr_inmatriculare_empty" class="label-text">Nr. Înmatriculare (Când e gol):</label>
                    <input type="text" id="composite_nr_inmatriculare_empty" class="input-field" placeholder="Ex: fără numere de înmatriculare">
                </div>
                <div>
                    <label for="composite_partea_vatamata_text_filled" class="label-text">Partea Vătămată (Când e completat):</label>
                    <input type="text" id="composite_partea_vatamata_text_filled" class="input-field" placeholder="Ex: Partea vătămată: [NUME_RECLAMANT] (CNP: [CNP_RECLAMANT])">
                </div>
                <div>
                    <label for="composite_partea_vatamata_text_empty" class="label-text">Partea Vătămată (Când e gol):</label>
                    <input type="text" id="composite_partea_vatamata_text_empty" class="input-field" placeholder="Ex: Partea vătămată: Statul Român">
                </div>
                <div>
                    <label for="composite_martori_text_filled_single" class="label-text">Martor (Single Entry):</label>
                    <input type="text" id="composite_martori_text_filled_single" class="input-field" placeholder="Ex: Martor: [NUME_MARTOR], CNP: [CNP_MARTOR]">
                </div>
                <div>
                    <label for="composite_martori_text_empty" class="label-text">Martori (Când nu sunt):</label>
                    <input type="text" id="composite_martori_text_empty" class="input-field" placeholder="Ex: (Acest placeholder este omis complet dacă nu există martori)">
                </div>
                <div>
                    <label for="composite_patrola_text_filled_members" class="label-text">Patrulă (Când e completată):</label>
                    <input type="text" id="composite_patrola_text_filled_members" class="input-field" placeholder="Ex: [MEMBERS]">
                </div>
                <div>
                    <label for="composite_patrola_text_empty" class="label-text">Patrulă (Când e goală):</label>
                    <input type="text" id="composite_patrola_text_empty" class="input-field" placeholder="Ex: (Acest placeholder este omis complet dacă nu este setată patrula)">
                </div>
                <h4 class="text-lg font-medium text-sky-500 mt-6 mb-2">Șabloane Sancțiuni:</h4>
                <div>
                    <label for="composite_sanctiuni_amenda" class="label-text">Sancțiune Amendă:</label>
                    <input type="text" id="composite_sanctiuni_amenda" class="input-field" placeholder="Ex: - Amendă contravențională în valoare de [VALOARE]$">
                </div>
                <div>
                    <label for="composite_sanctiuni_arest" class="label-text">Sancțiune Arest:</label>
                    <input type="text" id="composite_sanctiuni_arest" class="input-field" placeholder="Ex: - Reținere în custodie pentru [DURATA] luni, în [LOCATIE]">
                </div>
                <div>
                    <label for="composite_sanctiuni_anulare_permis" class="label-text">Sancțiune Anulare Permis:</label>
                    <input type="text" id="composite_sanctiuni_anulare_permis" class="input-field" placeholder="Ex: - Anularea permisului de conducere">
                </div>
                <div>
                    <label for="composite_sanctiuni_ridicare_vehicul" class="label-text">Sancțiune Ridicare Vehicul:</label>
                    <input type="text" id="composite_sanctiuni_ridicare_vehicul" class="input-field" placeholder="Ex: - Ridicarea autovehiculului">
                </div>
                <div>
                    <label for="composite_sanctiuni_perchezitie_masura" class="label-text">Sancțiune Percheziție Masură:</label>
                    <input type="text" id="composite_perchezitie_masura" class="input-field" placeholder="Ex: - Percheziție corporală și a vehiculului.">
                </div>
                <div>
                    <label for="composite_sanctiuni_lista_empty" class="label-text">Sancțiuni (Când nu sunt):</label>
                    <input type="text" id="composite_sanctiuni_lista_empty" class="input-field" placeholder="Ex: (Acest placeholder este omis complet dacă nu se aplică sancțiuni)">
                </div>
                <h4 class="text-lg font-medium text-sky-500 mt-6 mb-2">Șabloane Percheziție:</h4>
                <div>
                    <label for="composite_perchezitie_buzunare_filled" class="label-text">Percheziție Buzunare (Când e completat):</label>
                    <input type="text" id="composite_perchezitie_buzunare_filled" class="input-field" placeholder="Ex: în buzunare s-a găsit [VALOARE]">
                </div>
                <div>
                    <label for="composite_perchezitie_buzunare_empty" class="label-text">Percheziție Buzunare (Când e gol):</label>
                    <input type="text" id="composite_perchezitie_buzunare_empty" class="input-field" placeholder="Ex: ">
                </div>
                <div>
                    <label for="composite_perchezitie_torpedo_filled" class="label-text">Percheziție Torpedo (Când e completat):</label>
                    <input type="text" id="composite_perchezitie_torpedo_filled" class="input-field" placeholder="Ex: în torpedo s-a găsit [VALOARE]">
                </div>
                <div>
                    <label for="composite_perchezitie_torpedo_empty" class="label-text">Percheziție Torpedo (Când e gol):</label>
                    <input type="text" id="composite_perchezitie_torpedo_empty" class="input-field" placeholder="Ex: ">
                </div>
                <div>
                    <label for="composite_perchezitie_portbagaj_filled" class="label-text">Percheziție Portbagaj (Când e completat):</label>
                    <input type="text" id="composite_perchezitie_portbagaj_filled" class="input-field" placeholder="Ex: în portbagaj s-a găsit [VALOARE]">
                </div>
                <div>
                    <label for="composite_perchezitie_portbagaj_empty" class="label-text">Percheziție Portbagaj (Când e gol):</label>
                    <input type="text" id="composite_perchezitie_portbagaj_empty" class="input-field" placeholder="Ex: ">
                </div>
            </div>
            <div class="mt-8 flex justify-start gap-3">
                <button type="button" id="anuleazaCompositePlaceholdersBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaCompositePlaceholdersBtn" class="btn-primary-small">Salvează Șabloanele</button>
            </div>
        </div>
    </div>

    <!-- Ghid Modal -->
    <div id="ghidModal" class="modal-overlay hidden-element">
        <div class="modal-content">
            <button id="closeGhidModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center text-sky-400">Editează Ghidul de Utilizare</h3>
            <div id="ghidEditorToolbar" class="ghid-editor-toolbar">
                <button type="button" class="toolbar-button" data-command="bold"><i class="fa-solid fa-bold"></i></button>
                <button type="button" class="toolbar-button" data-command="italic"><i class="fa-solid fa-italic"></i></button>
                <button type="button" class="toolbar-button" data-command="underline"><i class="fa-solid fa-underline"></i></button>
                <button type="button" class="toolbar-button" data-command="insertUnorderedList"><i class="fa-solid fa-list-ul"></i></button>
                <button type="button" class="toolbar-button" data-command="insertOrderedList"><i class="fa-solid fa-list-ol"></i></button>
                <button type="button" class="toolbar-button" data-command="formatBlock" data-value="h2">H2</button>
                <button type="button" class="toolbar-button" data-command="formatBlock" data-value="h3">H3</button>
                <button type="button" class="toolbar-button" data-command="createLink"><i class="fa-solid fa-link"></i></button>
                <button type="button" class="toolbar-button" data-command="unlink"><i class="fa-solid fa-unlink"></i></button>
                <input type="color" id="ghidFontColor" class="w-8 h-8 p-0 border-none cursor-pointer" title="Culoare Text">
            </div>
            <div id="ghidEditor" contenteditable="true" class="textarea-field mt-2 p-4 border border-gray-700 rounded-md">
                <!-- Editable content -->
            </div>
            <div class="mt-8 flex justify-start gap-3">
                <button type="button" id="anuleazaGhidModalBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaGhidModalBtn" class="btn-primary-small">Salvează Ghidul</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-message"></div>

    <script>
    // --- All original JS is preserved. Only the Toast function is slightly modified. ---
    // --- This script ensures all functionality from the original file works with the new design. ---
    
    // Function to update the clock in the header
    function updateClock() {
        const timeDisplay = document.getElementById('current-time-display');
        if (timeDisplay) {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Europe/Bucharest' };
            timeDisplay.textContent = now.toLocaleTimeString('ro-RO', timeOptions);
            // console.log("Clock updated:", timeDisplay.textContent); // For debugging
        }
    }

    function showToast(message, success = true) {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.className = 'toast-message'; // Reset classes
            toast.classList.add(success ? 'success' : 'error');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
    }

    // Helper functions for color conversion
    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return { r, g, b };
    }

    function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
    }

    function parseRgba(rgbaString) {
        const parts = rgbaString.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)/);
        if (parts) {
            return {
                r: parseInt(parts[1]),
                g: parseInt(parts[2]),
                b: parseInt(parts[3]),
                a: parseFloat(parts[4] || 1)
            };
        }
        // Fallback for hex values if rgba parsing fails
        if (rgbaString.startsWith('#')) {
            const { r, g, b } = hexToRgb(rgbaString);
            return { r, g, b, a: 1 };
        }
        return { r: 0, g: 0, b: 0, a: 1 }; // Default to black opaque
    }

    function formatRgba(r, g, b, a) {
        return `rgba(${r}, ${g}, ${b}, ${a})`;
    }


    // --- Start of original JS from the provided file, starting from the DOMContentLoaded listener. ---
    document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Selectors ---
            const mainTabButtons = document.querySelectorAll('.tab-button');
            const mainTabContents = document.querySelectorAll('.tab-content');
            
            const procesatorForm = document.getElementById('procesatorForm');
            const resetFormBtn = document.getElementById('resetFormBtn');
            const copyDescriptionBtn = document.getElementById('copyDescriptionBtn');
            const copyTitlesBtn = document.getElementById('copyTitlesBtn');
            const generateCaseDescriptionBtn = document.getElementById('generateCaseDescriptionBtn');
            const caseDescriptionOutput = document.getElementById('caseDescriptionOutput');
            const generatedTitlesOutput = document.getElementById('generatedTitlesOutput');

            // Global DOM Elements
            const zonaSelect = document.getElementById('zona_input'); 
            const listaZoneDatalist = document.getElementById('lista_zone'); 
            const limitaVitezaZonaInput = document.getElementById('limita_viteza_zona');
            const infractiuneInputs = [
                document.getElementById('infractiune1'),
                document.getElementById('infractiune2'),
                document.getElementById('infractiune3')
            ];
            
            const dataProcesareInput = document.getElementById('data_procesare');
            const oraProcesareInput = document.getElementById('ora_procesare');
            const actualizeazaDateTimeBtn = document.getElementById('actualizeazaDateTimeBtn');

            const tipVehiculProcesatorSelect = document.getElementById('tip_vehicul_procesator');
            const modelVehiculInput = document.getElementById('model_vehicul_input'); 
            const listaModeleVehiculeDatalist = document.getElementById('lista_modele_vehicule'); 
            const adaugaVehiculDinProcesatorBtn = document.getElementById('adaugaVehiculDinProcesatorBtn');

            const globalInfractionError = document.getElementById('globalInfractionError');
            
            // Cod Penal Settings Elements
            const codPenalForm = document.getElementById('codPenalForm');
            const listaArticoleCodPenalDiv = document.getElementById('listaArticoleCodPenal');
            const incompatibilitatiListContainer = document.getElementById('incompatibilitatiListContainer');
            const incompatibilitatiLabel = document.getElementById('incompatibilitatiLabel');
            const incompatibilitatiCountSpan = document.getElementById('incompatibilitatiCount');
            const verificareArticolInput = document.getElementById('verificare_articol');
            const articolArestPeViataCheckbox = document.getElementById('articol_arest_pe_viata');
            const articolArestMaxInput = document.getElementById('articol_arest_max');
            const placeholderInput = document.getElementById('placeholder-input');
            const placeholderOutput = document.getElementById('placeholder-output');
            const exportPlaceholdersBtn = document.getElementById('exportPlaceholdersBtn');

            // Speed Limit Settings Elements
            const speedLimitSettingsForm = document.getElementById('speedLimitSettingsForm'); // This element doesn't exist in HTML, but its variables are used.
            const streetNameSettingsInput = document.getElementById('street_name_settings_input');
            const speedLimitSettingsInput = document.getElementById('speed_limit_settings_input');
            const addSpeedLimitBtn = document.getElementById('addSpeedLimitBtn');
            const speedLimitListUL = document.getElementById('speedLimitListUL');
            
            // Other Procesator Form elements
            const amendaTotalaInput = document.getElementById('amenda_totala');
            const arestTotalMinInput = document.getElementById('arest_total_min');
            const arestTotalMaxInput = document.getElementById('arest_total_max');
            const punctePermisInput = document.getElementById('puncte_permis');
            const anularePermisCheckbox = document.getElementById('anulare_permis');
            const ridicareVehiculCheckbox = document.getElementById('ridicare_vehicul');
            const perchezitieMasuraCheckbox = document.getElementById('perchezitie_masura');

            const locatieDetentieContainer = document.getElementById('locatie_detentie_container');
            const numeReclamantInput = document.getElementById('nume_reclamant');
            
            // Modal elements
            const descrieriModal = document.getElementById('descrieriModal');
            const editeazaDescrieriBtn = document.getElementById('editeazaDescrieriBtn');
            const salveazaDescrieriModalBtn = document.getElementById('salveazaDescrieriModalBtn');
            const anuleazaDescrieriModalBtn = document.getElementById('anuleazaDescrieriModalBtn');
            const closeDescrieriModalBtn = document.getElementById('closeDescrieriModalBtn');
            const modalDescriere1 = document.getElementById('modal_articol_model_descriere_1');
            const modalDescriere2 = document.getElementById('modal_articol_model_descriere_2');
            const modalDescriere3 = document.getElementById('modal_articol_model_descriere_3');

            // Agenti Modal Elements
            const agentiModal = document.getElementById('agentiModal');
            const seteazaPatrulaBtn = document.getElementById('seteazaPatrulaBtn');
            const closeAgentiModalBtn = document.getElementById('closeAgentiModalBtn');
            const salveazaAgentiModalBtn = document.getElementById('salveazaAgentiModalBtn');
            const anuleazaAgentiModalBtn = document.getElementById('anuleazaAgentiModalBtn');
            
            // Toggler Checkboxes & Containers
            const licenteCheckbox = document.getElementById('licente_checkbox');
            const licenteContainer = document.getElementById('licente_container');
            const crimaOrganizataCheckbox = document.getElementById('crima_organizata_checkbox');
            const crimaOrganizataContainer = document.getElementById('crima_organizata_container');
            const perchezitieCheckbox = document.getElementById('perchezitie_checkbox');
            const perchezitieContainer = document.getElementById('perchezitie_container');
            const substantaCheckbox = document.getElementById('substanta_checkbox');
            const substantaContainer = document.getElementById('substanta_container');

            // Backup/Restore Buttons
            const exportAllSettingsBtn = document.getElementById('exportAllSettingsBtn');
            const importAllSettingsFile = document.getElementById('importAllSettingsFile');
            
            // Vehicle Settings Elements
            const vehicleTypeSettingsSelect = document.getElementById('vehicle_type_settings');
            const vehicleModelSettingsInput = document.getElementById('vehicle_model_settings_input');
            const addCustomVehicleBtn = document.getElementById('addCustomVehicleBtn');
            const customVehicleListUL = document.getElementById('customVehicleList');

            // AI Logic Editor Elements
            const saveAiLogicBtn = document.getElementById('saveAiLogicBtn');
            const aiSettingsBtn = document.getElementById('aiSettingsBtn');
            const aiSettingsModal = document.getElementById('aiSettingsModal');
            const closeAiSettingsModalBtn = document.getElementById('closeAiSettingsModalBtn');
            const anuleazaAiSettingsModalBtn = document.getElementById('anuleazaAiSettingsModalBtn');
            const salveazaAiSettingsModalBtn = document.getElementById('salveazaAiSettingsModalBtn');
            
            // Martori Elements
            const adaugaMartorBtn = document.getElementById('adaugaMartorBtn');
            const martoriContainer = document.getElementById('martoriContainer');

            // Ghid Elements
            const editGhidBtn = document.getElementById('editGhidBtn');
            const ghidModal = document.getElementById('ghidModal');
            const closeGhidModalBtn = document.getElementById('closeGhidModalBtn');
            const anuleazaGhidModalBtn = document.getElementById('anuleazaGhidModalBtn');
            const salveazaGhidModalBtn = document.getElementById('salveazaGhidModalBtn');
            const ghidEditor = document.getElementById('ghidEditor');
            const tutorialContentContainer = document.getElementById('tutorialContentContainer');
            const ghidEditorToolbar = document.getElementById('ghidEditorToolbar');

            // NOU: Selectors pentru modalul de placeholders compusi
            const showCompositePlaceholdersBtn = document.getElementById('showCompositePlaceholdersBtn');
            const compositePlaceholdersModal = document.getElementById('compositePlaceholdersModal');
            const closeCompositePlaceholdersModalBtn = document.getElementById('closeCompositePlaceholdersModalBtn');
            const anuleazaCompositePlaceholdersBtn = document.getElementById('anuleazaCompositePlaceholdersBtn'); // Added
            const salveazaCompositePlaceholdersBtn = document.getElementById('salveazaCompositePlaceholdersBtn'); // Added

            // --- State Variables ---
            let codPenalEntries = []; 
            let infractionSanctionsData = {}; 
            let editingCodPenalIndex = null;
            let streetSpeedLimitsData = []; 
            let editingSpeedLimitIndex = null;
            const speedLimits = { "": "Selectați zona" };
            let customVehicleModels = []; 
            let editingVehicleIndex = null; 
            let aiLogicTemplates = {};
            let aiSettings = {};
            let martorCounter = 0;
            let compositePlaceholderTemplates = {}; // NEW: State for composite placeholders
            
            const defaultColors = {
                'mdt-bg': 'rgba(13, 17, 23, 1)', /* Very dark charcoal */
                'mdt-bg-secondary': 'rgba(22, 27, 34, 1)', /* Dark panel background */
                'mdt-bg-tertiary': 'rgba(1, 4, 9, 1)', /* Blackest background */
                'mdt-border': 'rgba(48, 54, 61, 1)', /* Muted border */
                'mdt-border-highlight': 'rgba(139, 148, 158, 1)',
                'mdt-text-primary': 'rgba(230, 237, 243, 1)', /* Primary text - off-white */
                'mdt-text-secondary': 'rgba(125, 133, 144, 1)', /* Secondary text - gray */
                'mdt-text-accent': 'rgba(88, 166, 255, 1)', /* Blue accent for highlights */
                'mdt-text-input': 'rgba(201, 209, 217, 1)', /* Text inside inputs */
                'mdt-alert-red': 'rgba(248, 81, 73, 1)',
                'mdt-alert-yellow': 'rgba(210, 153, 34, 1)',
                'mdt-alert-green': 'rgba(63, 185, 80, 1)',
                'mdt-accent-purple': 'rgba(163, 113, 247, 1)',
                'mdt-accent-orange': 'rgba(249, 115, 22, 1)',
            };

            const defaultAiSettings = {
                prompt: "Folosește un limbaj formal, specific Poliției Române. Verifică acordul gramatical între subiect și predicat și adaptează substantivele și adjectivele la genul persoanelor implicate. Asigură-te că punctuația este corectă, cu spațiu după virgulă și punct.",
                titleSeparator: "; ",
                titleFormat: "{titluri_infractiuni} ({capitol_principal})",
                headerTemplate: `**INFRACȚIUNI:**\n{lista_infractiuni}\n\n**PATRULA:**\n{patrola_text}\n\n**PĂRȚI IMPLICATE:**\nInculpat: {nume}, CNP: {cnp}\n{partea_vatamata_text}\n{martori_text}`
            };

            const defaultAiLogicTemplates = {
                intro_standard: "",
                intro_apel_112: "",
                intro_focuri_arma: "",
                intro_mineriada: "",
                intro_autoconstatare: "",
                intro_jaf: "",
                intro_rutiera: "",
                intro_razie_sas: "",
                sanctions: ""
            };

            // NEW: Default templates for composite placeholders
            const defaultCompositePlaceholderTemplates = {
                nr_inmatriculare_filled: "cu numerele de înmatriculare [VALOARE]",
                nr_inmatriculare_empty: "fără numere de înmatriculare",
                partea_vatamata_text_filled: "Partea vătămată: [NUME_RECLAMANT] (CNP: [CNP_RECLAMANT])",
                partea_vatamata_text_empty: "Partea vătămată: Statul Român",
                martori_text_filled_single: "Martor: [NUME_MARTOR], CNP: [CNP_MARTOR]",
                martori_text_empty: "(Acest placeholder este omis complet dacă nu există martori)",
                patrola_text_filled_members: "[MEMBERS]",
                patrola_text_empty: "(Acest placeholder este omis complet dacă nu este setată patrula)",
                sanctiuni_amenda: "- Amendă contravențională în valoare de [VALOARE]$",
                sanctiuni_arest: "- Reținere în custodie pentru [DURATA] luni, în [LOCATIE]",
                sanctiuni_anulare_permis: "- Anularea permisului de conducere",
                sanctiuni_ridicare_vehicul: "- Ridicarea autovehiculului",
                sanctiuni_perchezitie_masura: "- Percheziție corporală și a vehiculului.",
                sanctiuni_lista_empty: "(Acest placeholder este omis complet dacă nu se aplică sancțiuni)",
                perchezitie_buzunare_filled: "în buzunare s-a găsit [VALOARE]",
                perchezitie_buzunare_empty: "",
                perchezitie_torpedo_filled: "în torpedo s-a găsit [VALOARE]",
                perchezitie_torpedo_empty: "",
                perchezitie_portbagaj_filled: "în portbagaj s-a găsit [VALOARE]",
                perchezitie_portbagaj_empty: ""
            };


            const defaultGhidHTML = `
                <h2>1. Introducere</h2>
                <p><strong>MDT Helper</strong> este o unealtă concepută pentru a eficientiza procesul de creare a dosarelor penale și a amenzilor, automatizând calcularea sancțiunilor și generarea descrierilor narative pe baza datelor introduse.</p>
                <h2>2. Configurare Inițială</h2>
                <p>La prima utilizare, aplicația este goală. Pentru a o popula cu date (articole din codul penal, modele de vehicule etc.), urmați pașii de mai jos:</p>
                <ul>
                    <li><strong>Încarcă Datele:</strong> Apăsați butonul <strong>"Încarcă datele"</strong> din colțul stânga-sus.</li>
                    <li><strong>Selectează Fișierul:</strong> Alegeți fișierul <code>mdt_data.txt</code> de pe computer. Acest fișier conține întreaga bază de date a aplicației.</li>
                    <li>Odată încărcat, toate listele și opțiunile din aplicație vor fi populate automat.</li>
                </ul>
                <blockquote><strong>Notă:</strong> Puteți salva oricând configurația curentă mergând la tab-ul <strong>Baza de Date</strong> și apăsând pe <strong>"Salvează datele"</strong>. Acest lucru va genera un nou fișier <code>mdt_data.txt</code>.</blockquote>
                <h2>3. Setarea Patrulei</h2>
                <p>Înainte de a procesa un caz, este esențial să vă setați patrula pentru sesiunea curentă:</p>
                <ul>
                    <li>Apăsați butonul <strong>"Setează Patrulă"</strong>.</li>
                    <li>În fereastra care apare, completați datele pentru agentul operativ (dumneavoastră).</li>
                    <li>Bifați și completați datele pentru agenții parteneri, dacă este cazul.</li>
                    <li>Apăsați <strong>"Salvează Patrula"</strong>. Numele agenților vor fi afișate sub buton.</li>
                </ul>
                <h2>4. Tab-ul "Procesator" - Generarea unui Raport</h2>
                <p>Acesta este ecranul principal unde veți lucra cel mai mult.</p>
                <h3>4.1. Verificare Rapidă Articol</h3>
                <p>În câmpul <strong>"Verificare Articol Cod Penal"</strong>, puteți căuta rapid un articol pentru a-i vedea definiția, sancțiunile și incompatibilitățile.</p>
                <h3>4.2. Datele Părților</h3>
                <p>În <strong>chenarul albastru</strong>, completați datele inculpatului, ale reclamantului/victimei și, de acum, și ale <strong>martorilor</strong>. Puteți adăuga câți martori este necesar folosind butonul "Adaugă Martor".</p>
                <h3>4.3. Acțiunea</h3>
                <p>În <strong>chenarul albastru</strong>, selectați tipul acțiunii. Aceasta va alege șablonul corect și va pre-bifa opțiuni relevante (ex., "Rutieră" bifează "Substanță sub influență").</p>
                <h3>4.4. Detalii Suplimentare</h3>
                <p>În <strong>chenarul gri-închis</strong>, adăugați detalii specifice cazului bifând căsuțele corespunzătoare. De exemplu, bifarea căsuței "Percheziție" va afișa câmpuri pentru <code>{buzunare}</code>, <code>{torpedo}</code> și <code>{portbagaj}</code>.</p>
                <h3>4.5. Detalii Vehicul</h3>
                <p>În <strong>chenarul gri-închis</strong>, completați detaliile vehiculului. Limita de viteză se va completa automat pe baza străzii selectate.</p>
                <h3>4.6. Infracțiuni</h3>
                <p>În <strong>chenarul gri-închis</strong>, selectați până la trei infracțiuni. Sancțiunile se vor calcula și actualiza automat.</p>
                <h3>4.7. Generare și Copiere</h3>
                <ul>
                    <li>After filling in the data, press **"Generate"**.</li>
                    <li>The title and full description will appear below.</li>
                    <li>Use the buttons **"Copy Title"** and **"Copy Description"**.</li>
                </ul>
                <h2>5. Tab-ul "Baza de Date"</h2>
                <p>Here you can customize articles, vehicles and areas. Each section has **Edit** and **Delete** buttons.</p>
                <h2>6. Tab-ul "Setări"</h2>
                <h3>6.1. Placeholders</h3>
                <p>A complete list of all available placeholders, including new terms for witnesses (e.g., <code>{martori_text}</code>). You can click on one to copy it.</p>
                <h3>6.2. Appearance</h3>
                <p>Completely customize the visual appearance of the application.</p>
                <h3>6.3. Templates and Advanced Settings</h3>
                <p>Here you can modify the templates for each type of entry (Standard, 112 Call, etc.). Also, the new **"Advanced Generation Settings (AI)"** button allows you to customize the basic structure of reports and title formats.</p>`;

            // --- Functions ---
            
            function getCurrentRomanianDateTime() {
                const now = new Date();
                const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Europe/Bucharest' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Europe/Bucharest' };
                const romanianDate = now.toLocaleDateString('ro-RO', dateOptions);
                const romanianTime = now.toLocaleTimeString('ro-RO', timeOptions);
                return { date: romanianDate, time: romanianTime };
            }

            function updateDateTimeFields() {
                const { date, time } = getCurrentRomanianDateTime();
                if (dataProcesareInput) dataProcesareInput.value = date;
                if (oraProcesareInput) oraProcesareInput.value = time;
            }

            function getArticleForNoun(noun) {
                if (typeof noun !== 'string' || noun.length === 0) return 'un';
                
                const lowerCaseNoun = noun.toLowerCase();
                 if (lowerCaseNoun === 'atv') return 'un';
                if (lowerCaseNoun.includes('autospecial')) return 'o'; 
                
                const lastChar = lowerCaseNoun.slice(-1);
                if (lastChar === 'a' || lastChar === 'ă') {
                   return 'o';
                }

                return 'un';
            }

            function populateProcesatorVehicleTypeDropdown() {
                const procesatorVehicleSelect = document.getElementById('tip_vehicul_procesator');
                if (!procesatorVehicleSelect) return;

                const currentValue = procesatorVehicleSelect.value;
                procesatorVehicleSelect.innerHTML = '<option value="">Selectează tipul...</option>'; 

                const customTypes = customVehicleModels.map(v => v.type);
                const allUniqueTypes = [...new Set(customTypes)].sort();

                allUniqueTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    if (type.toLowerCase() === 'atv') {
                        option.textContent = 'ATV';
                    } else {
                        option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                    }
                    procesatorVehicleSelect.appendChild(option);
                });

                if (allUniqueTypes.includes(currentValue)) {
                    procesatorVehicleSelect.value = currentValue;
                }
            }
            
            function preprocessCodPenalData(entries) {
                if (!Array.isArray(entries)) return [];
                return entries.map(entry => {
                    const originalTitle = String(entry.titlu || '');
                    let numarArticolNou = '';
                    let titluNou = originalTitle;

                    const regex = /^((?:Art\.\s*)?[\d\.]+(?:\s*\([\w\s\.]+\))?(?:\s*[Ll][Ii][Tt]\.?\s*[a-zA-Z])?)\s*(.*)/;
                    const match = originalTitle.match(regex);

                    if (match && match[1]) {
                        numarArticolNou = match[1].replace(/^Art\.\s*/, '').trim(); 
                        titluNou = (match[match.length - 1] || '').trim(); 
                    } else {
                        numarArticolNou = String(entry.numarArticol || '').trim(); 
                        titluNou = originalTitle;
                    }
                    
                    return {
                        ...entry,
                        numarArticol: numarArticolNou, 
                        titlu: titluNou, 
                        capitolText: entry.capitolText 
                    };
                });
            }

            function renderSpeedLimitsList() {
                const jafLocatieDatalist = document.getElementById('lista_locatii_jaf');
                if (!speedLimitListUL || !listaZoneDatalist || !jafLocatieDatalist) return;
                
                speedLimitListUL.innerHTML = '';
                listaZoneDatalist.innerHTML = ''; 
                jafLocatieDatalist.innerHTML = '';

                Object.keys(speedLimits).forEach(key => { 
                    if (key !== "") delete speedLimits[key];
                });

                streetSpeedLimitsData.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'speed-limit-list-item'; 
                    listItem.innerHTML = `
                        <span>${item.name} - ${item.limit}</span>
                        <div class="actions">
                            <button type="button" data-index="${index}" class="btn-primary-small edit-speed-limit-btn">Modifică</button>
                            <button type="button" data-index="${index}" class="btn-danger delete-speed-limit-btn">Șterge</button>
                        </div>
                    `;
                    speedLimitListUL.appendChild(listItem);

                    const zonaOptionItem = document.createElement('option');
                    zonaOptionItem.value = item.name; 
                    listaZoneDatalist.appendChild(zonaOptionItem);
                    
                    const jafLocatieOption = document.createElement('option');
                    jafLocatieOption.value = item.name; 
                    jafLocatieDatalist.appendChild(jafLocatieOption);
                    
                    speedLimits[item.name] = item.limit; 
                });
                updateSpeedLimitDisplay(); 
            }

            function renderCustomVehicleList() {
                if (!customVehicleListUL || !listaModeleVehiculeDatalist) return; 
                
                customVehicleModels.sort((a, b) => a.name.localeCompare(b.name));

                customVehicleListUL.innerHTML = '';
                
                customVehicleModels.forEach((vehicle) => {
                    const originalIndex = customVehicleModels.findIndex(v => v.id === vehicle.id);
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'vehicle-list-item';
                    listItem.innerHTML = `
                        <span>${vehicle.name} (Tip: ${vehicle.type})</span>
                        <div class="actions">
                            <button type="button" data-index="${originalIndex}" class="btn-primary-small edit-vehicle-btn">Modifică</button>
                            <button type="button" data-index="${originalIndex}" class="btn-danger delete-vehicle-btn">Șterge</button>
                        </div>
                    `;
                    customVehicleListUL.appendChild(listItem);
                });
                 populateProcesatorVehicleTypeDropdown(); 
                 filterVehicleModels();
                 populateVehicleTypeSettingsDropdown();
            }
            
            function populateVehicleTypeSettingsDropdown() {
                const vehicleTypeSettingsSelect = document.getElementById('vehicle_type_settings');
                if (!vehicleTypeSettingsSelect) return;

                const currentValue = vehicleTypeSettingsSelect.value;
                vehicleTypeSettingsSelect.innerHTML = '';

                const defaultTypes = ['autoturism', 'bicicleta', 'motocicleta', 'elicopter', 'skyjet', 'barca', 'atv', 'camion', 'autospecială', 'autospeciala'];
                const customTypes = customVehicleModels.map(v => v.type);
                const allUniqueTypes = [...new Set([...defaultTypes, ...customTypes])].sort();

                allUniqueTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                    vehicleTypeSettingsSelect.appendChild(option);
                });

                if (allUniqueTypes.includes(currentValue)) {
                    vehicleTypeSettingsSelect.value = currentValue;
                } else if (allUniqueTypes.length > 0) {
                    vehicleTypeSettingsSelect.value = allUniqueTypes[0];
                }
            }
            
            function filterVehicleModels() {
                const selectedType = tipVehiculProcesatorSelect.value;
                listaModeleVehiculeDatalist.innerHTML = '';
                let modelsToDisplay;

                if (selectedType) {
                    modelsToDisplay = customVehicleModels.filter(vehicle => vehicle.type === selectedType);
                } else {
                    modelsToDisplay = customVehicleModels;
                }
                
                modelsToDisplay.sort((a, b) => a.name.localeCompare(b.name));

                modelsToDisplay.forEach(vehicle => {
                    const optionItem = document.createElement('option');
                    optionItem.value = vehicle.name;
                    listaModeleVehiculeDatalist.appendChild(optionItem);
                });
            }
            
            function generateArticleId(capitol, numarArticol, titlu) {
                const capClean = String(capitol || '').toLowerCase().replace(/[^a-z0-9\.]/g, '').replace(/\.$/, '');
                const numarArticolClean = String(numarArticol || '').toLowerCase().replace(/[^a-z0-9\.\(\)]/g, '_'); 
                const titluClean = String(titlu || '').toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').substring(0, 30);
                return `${capClean}_${numarArticolClean}_${titluClean}`.replace(/__+/g, '_'); 
            }
            
            function populateInfractionSanctionsData() {
                infractionSanctionsData = { "": { name: "Neselectat", amendaMin: 0, amendaMax: 0, arestMin: 0, arestMax: 0, punctePenalizare: 0 } }; 
                codPenalEntries.forEach(art => {
                    infractionSanctionsData[art.id] = art;
                });
            }
            
            function populateInfractionDatalist() {
                const datalist = document.getElementById('lista_infractiuni_datalist');
                const verificationDatalist = document.getElementById('lista_articole_verificare');
                
                const populate = (list) => {
                    if (list) {
                        list.innerHTML = ''; // Clear the datalist
                        codPenalEntries.forEach(art => {
                            const option = document.createElement('option');
                            option.value = `${art.numarArticol} - ${art.titlu}`;
                            list.appendChild(option);
                        });
                    }
                };

                populate(datalist);
                populate(verificationDatalist);
            }
            
            function renderCodPenalList() {
                if (!listaArticoleCodPenalDiv) return; 
                listaArticoleCodPenalDiv.innerHTML = ''; 
                if (codPenalEntries.length === 0) {
                    listaArticoleCodPenalDiv.innerHTML = '<p class="text-sm text-gray-500">Niciun articol adăugat încă.</p>';
                    return;
                }
                codPenalEntries.forEach((articol, index) => {
                    const div = document.createElement('div');
                    div.className = 'cod-penal-list-item';
                    div.innerHTML = `
                        <span class="flex-grow"><strong class="text-sky-400">${articol.capitolText} ${articol.numarArticol}</strong> - ${articol.titlu}</span>
                        <div class="actions">
                            <button type="button" data-index="${index}" class="btn-primary-small edit-articol-btn">Modifică</button>
                            <button type="button" data-index="${index}" class="btn-danger delete-articol-btn">Șterge</button>
                        </div>
                    `;
                    listaArticoleCodPenalDiv.appendChild(div);
                });
                 renderIncompatibilitatiCheckboxes(); 
            }
            
            function updateIncompatibilitatiCount() {
                if (!incompatibilitatiListContainer || !incompatibilitatiLabel || !incompatibilitatiCountSpan) return;
                const checkedCount = incompatibilitatiListContainer.querySelectorAll('.incompatibilitate-checkbox:checked').length;
                const text = checkedCount === 1 ? "infracțiune selectată" : "infracțiuni selectate";
                incompatibilitatiCountSpan.textContent = `(${checkedCount} ${text})`;
            }

            function renderIncompatibilitatiCheckboxes(articolCurentId = null, incompatibileExistente = []) {
                if (!incompatibilitatiListContainer) return;
                incompatibilitatiListContainer.innerHTML = ''; 

                if (codPenalEntries.length === 0 || (codPenalEntries.length === 1 && articolCurentId && codPenalEntries[0].id === articolCurentId) ) { 
                    incompatibilitatiListContainer.innerHTML = '<p class="text-xs text-gray-500">Nu există alte articole pentru a seta incompatibilități.</p>';
                    updateIncompatibilitatiCount();
                    return;
                }
                
                let hasOtherArticles = false;
                codPenalEntries.forEach(art => {
                    if (articolCurentId && art.id === articolCurentId) return;
                    hasOtherArticles = true;
                    const label = document.createElement('label');
                    label.className = 'control-label text-xs'; 
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'control-input checkbox-input incompatibilitate-checkbox';
                    checkbox.value = art.id;
                    checkbox.dataset.articleId = art.id;
                    if (incompatibileExistente.includes(art.id)) {
                        checkbox.checked = true;
                    }
                    
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(`${art.numarArticol} - ${art.titlu}`)); 
                    incompatibilitatiListContainer.appendChild(label);
                });
                 if (!hasOtherArticles && !articolCurentId) { 
                    incompatibilitatiListContainer.innerHTML = '<p class="text-xs text-gray-500">Nu există alte articole pentru a seta incompatibilități.</p>';
                }
                updateIncompatibilitatiCount();
            }
            
            function displayPatrolInfo() {
                const patrolDisplay = document.getElementById('patrolDisplay'); // The detailed one in the main content
                const patrolUnitDisplay = document.getElementById('patrol-unit-display'); // The one in the header for UNIT (call sign)
                const patrolMembersDisplay = document.getElementById('patrol-members-display'); // The new one in the header for PATRULĂ (names and ranks)
                const agentData = JSON.parse(sessionStorage.getItem('patrolData')) || {};

                let fullPatrolText = ""; // For the detailed display below buttons
                let headerUnitCallSign = "N/A"; // For the "UNIT" in header
                let headerPatrolMembers = "Nicio patrulă setată"; // For the "PATRULĂ" in header

                const membersList = [];
                if (agentData.AgentOpNume) {
                    headerUnitCallSign = agentData.AgentOpCallSign || "N/A";
                    membersList.push(`${agentData.AgentOpGrad} ${agentData.AgentOpNume}`);
                }
                if (agentData.IncludeAgentConst === 'Da' && agentData.AgentConstNume) {
                    membersList.push(`${agentData.AgentConstGrad} ${agentData.AgentConstNume}`);
                }
                if (agentData.IncludeAgentAd1 === 'Da' && agentData.AgentAd1Nume) {
                    membersList.push(`${agentData.AgentAd1Grad} ${agentData.AgentAd1Nume}`);
                }
                if (agentData.IncludeAgentAd2 === 'Da' && agentData.AgentAd2Nume) {
                    membersList.push(`${agentData.AgentAd2Grad} ${agentData.AgentAd2Nume}`);
                }

                // Update the detailed patrol display in the main content area
                if (membersList.length > 0) {
                    fullPatrolText = membersList.map(member => `${member}`).join('<br>');
                } else {
                    fullPatrolText = "- Nicio patrulă setată";
                }
                if (patrolDisplay) {
                    patrolDisplay.innerHTML = fullPatrolText;
                }

                // Update the header displays
                if (patrolUnitDisplay) {
                    patrolUnitDisplay.textContent = headerUnitCallSign; // Set UNIT to call sign
                }
                if (patrolMembersDisplay) {
                    if (membersList.length > 0) {
                        headerPatrolMembers = membersList.join(', '); // Join with comma for concise header
                    }
                    patrolMembersDisplay.textContent = headerPatrolMembers; // Set PATRULĂ to names and ranks
                }
            }

            function updateSpeedLimitDisplay() {
                if (!zonaSelect || !limitaVitezaZonaInput) return;
                const selectedStreetName = zonaSelect.value; 
                limitaVitezaZonaInput.value = speedLimits[selectedStreetName] || "N/A"; 
            }
            
            function displayIndividualInfractionFeedback() {
                infractiuneInputs.forEach((input, index) => {
                    const feedbackDiv = document.getElementById(`feedbackInfractiune${index + 1}`);
                    if (!feedbackDiv) return;

                    feedbackDiv.innerHTML = '';
                    const selectedId = input.dataset.selectedId;

                    if (selectedId && infractionSanctionsData[selectedId]) {
                        const art = infractionSanctionsData[selectedId];
                        let feedbackHTML = '';

                        if (art.amendaMin !== undefined && art.amendaMax !== undefined) {
                            if (art.amendaMin === art.amendaMax && art.amendaMin > 0) {
                                feedbackHTML += `<p class="text-green-500">Amendă: ${art.amendaMin}$</p>`;
                            } else if (art.amendaMin !== art.amendaMax && (art.amendaMin > 0 || art.amendaMax > 0)) {
                                feedbackHTML += `<p class="text-green-500">Amendă: ${art.amendaMin}-${art.amendaMax}$</p>`;
                            }
                        }

                        if (art.arestMin !== undefined && art.arestMax !== undefined) {
                            if (art.arestPeViata) {
                                feedbackHTML += `<p class="text-red-400">Arest: ${art.arestMin > 0 ? art.arestMin + ' luni - ' : ''}Pe viață</p>`; 
                            } else if (art.arestMin === art.arestMax && art.arestMin > 0) {
                                feedbackHTML += `<p class="text-red-400">Arest: ${art.arestMin} luni</p>`; 
                            } else if (art.arestMin !== art.arestMax && (art.arestMin > 0 || art.arestMax > 0)) {
                                 feedbackHTML += `<p class="text-red-400">Arest: ${art.arestMin}-${art.arestMax} luni</p>`; 
                            }
                        }

                         if (art.punctePenalizare !== undefined && art.punctePenalizare > 0) {
                            feedbackHTML += `<p class="text-blue-400">Puncte: ${art.punctePenalizare}</p>`;
                        }
                        
                        let sanctionsText = [];
                        if (art.anularePermis) sanctionsText.push(`<span class="text-yellow-400 sanction-word">Anulare Permis</span>`);
                        if (art.ridicareVehicul) sanctionsText.push(`<span class="text-orange-400 sanction-word">Ridicare Vehicul</span>`);
                        if (art.perchezitie) sanctionsText.push(`<span class="text-purple-400 sanction-word">Percheziție</span>`);
                        
                        if (sanctionsText.length > 0) {
                            feedbackHTML += `<div class="flex space-x-2">${sanctionsText.join('')}</div>`;
                        }

                        if (feedbackHTML) {
                            feedbackDiv.innerHTML = feedbackHTML;
                            feedbackDiv.classList.remove('hidden-element');
                        } else {
                            feedbackDiv.classList.add('hidden-element');
                        }
                    } else {
                        feedbackDiv.classList.add('hidden-element');
                    }
                });
            }
            
            function checkInfractionCombos() {
                if (!globalInfractionError) return;
                globalInfractionError.classList.add('hidden-element');
                globalInfractionError.classList.remove('blinking-warning');
                globalInfractionError.textContent = '';
                infractiuneInputs.forEach((_, index) => {
                    const feedbackDiv = document.getElementById(`feedbackInfractiune${index + 1}`);
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = '';
                        feedbackDiv.classList.add('hidden-element');
                    }
                });

                const selections = infractiuneInputs
                    .map(input => input.dataset.selectedId)
                    .filter(id => id);

                let duplicateFound = false;
                let incompatibleComboFound = false;

                if (selections.length >= 2) {
                    const selectionCounts = {};
                    selections.forEach(id => {
                        selectionCounts[id] = (selectionCounts[id] || 0) + 1;
                    });
                    for (const id in selectionCounts) {
                        if (selectionCounts[id] >= 2) {
                            duplicateFound = true;
                            break;
                        }
                    }
                }

                if (duplicateFound) {
                    globalInfractionError.textContent = "Ai selectat aceeași infracțiune de 2 ori!";
                    globalInfractionError.classList.remove('hidden-element');
                    globalInfractionError.classList.add('blinking-warning');
                    return;
                }

                if (selections.length >= 2) {
                    for (let i = 0; i < selections.length; i++) {
                        for (let k = i + 1; k < selections.length; k++) {
                            const inf1_id = selections[i];
                            const inf2_id = selections[k];
                            const inf1_data = infractionSanctionsData[inf1_id];

                            if (inf1_data && inf1_data.incompatibilCu && inf1_data.incompatibilCu.includes(inf2_id)) {
                                incompatibleComboFound = true;
                                break;
                            }
                        }
                        if (incompatibleComboFound) break;
                    }
                }

                if (incompatibleComboFound) {
                    globalInfractionError.textContent = "Nu se poate face combo!";
                    globalInfractionError.classList.remove('hidden-element');
                    globalInfractionError.classList.add('blinking-warning');
                    return;
                }
                displayIndividualInfractionFeedback();
            }
             
            function updateSanctionsTables() {
                let totalAmendaMaxCalc = 0;
                let totalArestMinCalc = 0;
                let totalArestMaxCalc = 0;
                let totalPuncte = 0;
                let arestPeViataGlobal = false;
                let shouldAnnulLicense = false;
                let shouldLiftVehicle = false;
                let shouldSearch = false;

                infractiuneInputs.forEach((inputElement) => {
                    if (!inputElement) return; 
                    const selectedValue = inputElement.dataset.selectedId; 
                    const sanctionData = infractionSanctionsData[selectedValue];

                    if (sanctionData) {
                        totalAmendaMaxCalc += sanctionData.amendaMax || 0;
                        if (sanctionData.arestPeViata) {
                            arestPeViataGlobal = true;
                        }
                        if (!sanctionData.arestPeViata) {
                            totalArestMinCalc += sanctionData.arestMin || 0;
                            totalArestMaxCalc += sanctionData.arestMax || 0;
                        }
                        if (sanctionData.anularePermis) shouldAnnulLicense = true;
                        if(sanctionData.ridicareVehicul) shouldLiftVehicle = true;
                        if (sanctionData.perchezitie) shouldSearch = true;
                        totalPuncte += sanctionData.punctePenalizare || 0;
                    }
                });
                
                amendaTotalaInput.value = totalAmendaMaxCalc;
                arestTotalMinInput.value = arestPeViataGlobal ? 120 : Math.min(120, totalArestMinCalc);
                arestTotalMaxInput.value = arestPeViataGlobal ? 120 : Math.min(120, totalArestMaxCalc);
                anularePermisCheckbox.checked = shouldAnnulLicense;
                punctePermisInput.value = totalPuncte;
                ridicareVehiculCheckbox.checked = shouldLiftVehicle;
                
                perchezitieCheckbox.checked = shouldSearch;
                perchezitieMasuraCheckbox.checked = shouldSearch;
                
                perchezitieContainer.classList.toggle('hidden-element', !perchezitieCheckbox.checked);

                checkInfractionCombos();
                toggleArestDetailsVisibility();
            }
            
            function toggleArestDetailsVisibility() {
                if (locatieDetentieContainer) {
                     const arestValue = parseInt(arestTotalMaxInput.value) || 0;
                     if (arestValue > 0) {
                        locatieDetentieContainer.classList.remove('hidden-element');
                     } else {
                        locatieDetentieContainer.classList.add('hidden-element');
                     }
                }
            }
            
            function resetFormFields() {
                if (procesatorForm) {
                    procesatorForm.reset();
                }

                infractiuneInputs.forEach(input => {
                    delete input.dataset.selectedId;
                    const index = parseInt(input.id.replace('infractiune', '')) - 1;
                    const previewDiv = document.getElementById(`preview_template${index + 1}`);
                    if(previewDiv) previewDiv.innerHTML = '';
                });
                
                const sexMasculinRadio = document.querySelector('input[name="sex"][value="masculin"]');
                if (sexMasculinRadio) sexMasculinRadio.checked = true;
                
                const reclamantSexMasculinRadio = document.querySelector('input[name="sex_reclamant"][value="masculin_reclamant"]');
                if (reclamantSexMasculinRadio) reclamantSexMasculinRadio.checked = true;

                const locatieDetentieSelect = document.getElementById('locatie_detentie');
                if (locatieDetentieSelect) locatieDetentieSelect.value = "Penitenciarul Sandy";
                
                if (martoriContainer) martoriContainer.innerHTML = '';
                martorCounter = 0;
                
                updateDateTimeFields();
                updateSanctionsTables(); 
                validateAllFields();

                if(caseDescriptionOutput) {
                    caseDescriptionOutput.value = '';
                    caseDescriptionOutput.classList.add('hidden-element');
                }
                 if(generatedTitlesOutput) {
                     generatedTitlesOutput.value = '';
                     generatedTitlesOutput.classList.add('hidden-element');
                }

                infractiuneInputs.forEach((_, index) => {
                    const feedbackDiv = document.getElementById(`feedbackInfractiune${index + 1}`);
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = '';
                        feedbackDiv.classList.add('hidden-element');
                    }
                });
                if (globalInfractionError) {
                    globalInfractionError.classList.add('hidden-element');
                    globalInfractionError.textContent = '';
                }
                
                numeReclamantInput.dispatchEvent(new Event('input'));
            }
            
            function backupData(data, fileName) {
                const jsonData = JSON.stringify(data, null, 2); 
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(`Datele au fost salvate în ${fileName}`, true);
            }
            
            function copyToClipboard(text, type) {
                if (!text) {
                    showToast(`Nu există ${type.toLowerCase()} pentru a fi copiat(ă/e).`, false);
                    return;
                }
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; 
                textarea.style.left = '-9999px'; 
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                    const successful = document.execCommand('copy');
                    const msg = successful ? `${type} a/au fost copiat(ă/e) în clipboard!` : `Nu s-a putut copia ${type.toLowerCase()}.`;
                    showToast(msg, successful);
                } catch (err) {
                    console.error(`Eroare la copierea în clipboard (${type}):`, err);
                    showToast(`Eroare la copierea ${type.toLowerCase()}.`, false);
                }
                document.body.removeChild(textarea);
            }

             function adaptTextToGender(text, gender, context = 'suspect') {
                if (context === 'suspect' && gender === 'feminin') {
                    return text
                        .replace(/cetățeanul/gi, 'cetățeanca')
                        .replace(/numitul/gi, 'numita')
                        .replace(/inculpatul/gi, 'inculpata')
                        .replace(/individul/gi, 'individa')
                        .replace(/suspectul/gi, 'suspecta')
                        .replace(/șoferul/gi, 'șoferița')
                        .replace(/pietonul/gi, 'pietoana')
                        .replace(/făptuitorul/gi, 'făptuitoarea')
                        .replace(/acesta/gi, 'aceasta')
                        .replace(/dânsul/gi, 'dânsa')
                        .replace(/\bel\b/gi, 'ea')
                        .replace(/\blui\b/gi, 'ei')
                        .replace(/identificat/gi, 'identificată')
                        .replace(/legitimat/gi, 'legitimată')
                        .replace(/depistat/gi, 'depistată')
                        .replace(/aflat/gi, 'aflată')
                        .replace(/surprins/gi, 'surprinsă')
                        .replace(/sancționat/gi, 'sancționată')
                        .replace(/oprit/gi, 'oprită')
                        .replace(/găsit/gi, 'găsită')
                        .replace(/condus/gi, 'condusă')
                        .replace(/văzut/gi, 'văzută');
                }
                if (context === 'reclamant' && gender === 'feminin_reclamant') {
                    return text
                        .replace(/reclamantul/gi, 'reclamanta')
                        .replace(/martorul/gi, 'martora')
                        .replace(/păgubitul/gi, 'păgubita');
                }
                if (context.startsWith('martor_') && gender === 'feminin') {
                    return text.replace(/martorul/gi, 'martora');
                }
                return text;
            }

            function autoGenerateTemplateFromDefinition(infractionData) {
                const definition = infractionData.definitie.toLowerCase();

                if (infractionData.punctePenalizare > 0 || infractionData.anularePermis || definition.includes('viteză') || definition.includes('conducere') || definition.includes('vehicul') || definition.includes('circulați')) {
                    return `În data de {data_procesare}, în jurul orei {ora_procesare}, cetățeanul/cetățeanca {nume} (CNP {cnp}) a fost surprins/ă de echipajul de poliție în zona {zona_input}, conducând {tip_vehicul_procesator_formatted}, marca {model_vehicul_input} de culoare {culoare_vehicul}, {nr_inmatriculare_text}, în timp ce ${definition}.`;
                }
                if (infractionData.perchezitie || definition.includes('deținere') || definition.includes('droguri') || definition.includes('arme') || definition.includes('contrabandă')) {
                    return `Asupra numitului/ei {nume}, în urma unui control efectuat în zona {zona_input}, s-a constatat că acesta/aceasta ${definition}.`;
                }
                if (definition.includes('violență') || definition.includes('lovire') || definition.includes('agresiune') || definition.includes('amenințare') || definition.includes('vătămare')) {
                    return `Numitul/a {nume} este sancționat/ă pentru faptul că, în zona {zona_input}, a comis fapta de ${definition} asupra victimei {nume_reclamant}.`;
                }

                return `În data de {data_procesare}, ora {ora_procesare}, în zona {zona_input}, numitul/a {nume} a fost sancționat/ă pentru ${definition}.`;
            }

            // Simplified replacePlaceholders to just replace keys with values from data object
            function replacePlaceholders(text, data, forPreview = false) {
                if (typeof text !== 'string') return '';
                let processedText = text;

                const placeholders = text.match(/{[a-zA-Z0-9_]+}/g) || [];

                placeholders.forEach(placeholder => {
                    const key = placeholder.slice(1, -1);
                    const regex = new RegExp(placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                    let valueToInsert = data[key];

                    if (forPreview) {
                         if (valueToInsert === null || valueToInsert === undefined || valueToInsert === '' || (typeof valueToInsert === 'boolean' && !valueToInsert)) {
                            processedText = processedText.replace(regex, `<strong class="text-red-500 font-bold">${placeholder}</strong>`);
                        } else {
                            processedText = processedText.replace(regex, `<strong class="text-green-400 font-bold">${valueToInsert}</strong>`);
                        }
                    } else {
                         processedText = processedText.replace(regex, valueToInsert || '');
                    }
                });

                return processedText;
            }

            // NEW: Function to collect and process all form data, including composite placeholders
            function collectAndProcessFormData() {
                const allData = {};
                const formElements = document.querySelectorAll('#procesatorForm input, #procesatorForm select, #procesatorForm textarea, #data_procesare, #ora_procesare');
                formElements.forEach(el => {
                    const id = el.id || el.name;
                    if (!id) return;
                    if (el.type === 'radio') {
                        if (el.checked) allData[el.name] = el.value;
                    } else if (el.type === 'checkbox') {
                        allData[id] = el.checked;
                    } else {
                        allData[id] = el.value;
                    }
                });

                const patrolData = JSON.parse(sessionStorage.getItem('patrolData')) || {};
                Object.assign(allData, patrolData);

                // Add specific logic for certain simple placeholders that need formatting
                if (allData.autospeciala_select) {
                    const originalValue = allData.autospeciala_select;
                    const lowerValue = originalValue.toLowerCase();
                    if (lowerValue === 'blindata s.a.s.') {
                        allData.autospeciala_select_formatted = 'o blindată S.A.S.';
                        allData.autospeciala_select_genitive = 'blindatei S.A.S.';
                    } else if(lowerValue.includes('s.m.u.r.d.')) {
                        allData.autospeciala_select_formatted = 'o autospecială S.M.U.R.D.';
                        allData.autospeciala_select_genitive = 'autospecialei S.M.U.R.D.';
                    } else {
                        allData.autospeciala_select_formatted = originalValue;
                        allData.autospeciala_select_genitive = originalValue;
                    }
                } else {
                    allData.autospeciala_select_formatted = '';
                    allData.autospeciala_select_genitive = '';
                }

                if (allData.tip_vehicul_procesator) {
                    allData.tip_vehicul_procesator_formatted = `${getArticleForNoun(allData.tip_vehicul_procesator)} ${allData.tip_vehicul_procesator}`;
                } else {
                    allData.tip_vehicul_procesator_formatted = '';
                }

                // Licenta formatting
                const lipsaLicenta1Select = document.getElementById('lipsa_licenta_1');
                allData.lipsa_licenta_1_text = (lipsaLicenta1Select && lipsaLicenta1Select.selectedIndex > 0) ? lipsaLicenta1Select.options[lipsaLicenta1Select.selectedIndex].text : '';
                const lipsaLicenta2Select = document.getElementById('lipsa_licenta_2');
                allData.lipsa_licenta_2_text = (lipsaLicenta2Select && lipsaLicenta2Select.selectedIndex > 0) ? lipsaLicenta2Select.options[lipsaLicenta2Select.selectedIndex].text : '';


                // --- Composite Placeholder Processing ---
                // nr_inmatriculare
                allData['nr_inmatriculare_text'] = (allData.nr_inmatriculare && allData.nr_inmatriculare.trim() !== '')
                    ? (compositePlaceholderTemplates.nr_inmatriculare_filled || defaultCompositePlaceholderTemplates.nr_inmatriculare_filled).replace('[VALOARE]', allData.nr_inmatriculare.trim())
                    : (compositePlaceholderTemplates.nr_inmatriculare_empty || defaultCompositePlaceholderTemplates.nr_inmatriculare_empty);

                // partea_vatamata_text
                allData['partea_vatamata_text'] = (allData.nume_reclamant && allData.cnp_reclamant)
                    ? (compositePlaceholderTemplates.partea_vatamata_text_filled || defaultCompositePlaceholderTemplates.partea_vatamata_text_filled)
                        .replace('[NUME_RECLAMANT]', allData.nume_reclamant)
                        .replace('[CNP_RECLAMANT]', allData.cnp_reclamant)
                    : (compositePlaceholderTemplates.partea_vatamata_text_empty || defaultCompositePlaceholderTemplates.partea_vatamata_text_empty);

                // martori_text
                const martorEntries = document.querySelectorAll('.martor-entry');
                const martoriData = [];
                martorEntries.forEach((entry) => {
                    const nume = entry.querySelector(`input[id^="nume_martor_"]`).value;
                    const cnp = entry.querySelector(`input[id^="cnp_martor_"]`).value;
                    if (nume || cnp) {
                        martoriData.push({ nume, cnp });
                    }
                });
                allData['martori_text'] = martoriData.length > 0
                    ? martoriData.map(m => (compositePlaceholderTemplates.martori_text_filled_single || defaultCompositePlaceholderTemplates.martori_text_filled_single)
                        .replace('[NUME_MARTOR]', m.nume)
                        .replace('[CNP_MARTOR]', m.cnp)
                    ).join('\n')
                    : (compositePlaceholderTemplates.martori_text_empty || defaultCompositePlaceholderTemplates.martori_text_empty);

                // patrola_text
                const patrolMembers = [];
                if (patrolData.AgentOpNume) patrolMembers.push(`${patrolData.AgentOpGrad} ${patrolData.AgentOpNume}`);
                if (patrolData.IncludeAgentConst === 'Da' && patrolData.AgentConstNume) patrolMembers.push(`${agentData.AgentConstGrad} ${agentData.AgentConstNume}`);
                if (patrolData.IncludeAgentAd1 === 'Da' && patrolData.AgentAd1Nume) patrolMembers.push(`${agentData.AgentAd1Grad} ${agentData.AgentAd1Nume}`);
                if (patrolData.IncludeAgentAd2 === 'Da' && patrolData.AgentAd2Nume) patrolMembers.push(`${agentData.AgentAd2Grad} ${agentData.AgentAd2Nume}`);

                allData['patrola_text'] = patrolMembers.length > 0
                    ? (compositePlaceholderTemplates.patrola_text_filled_members || defaultCompositePlaceholderTemplates.patrola_text_filled_members).replace('[MEMBERS]', patrolMembers.join(', ').replace(/,([^,]*)$/, ' și$1'))
                    : (compositePlaceholderTemplates.patrola_text_empty || defaultCompositePlaceholderTemplates.patrola_text_empty);

                // sanctiuni_lista (elements are built here, then joined)
                let sanctiuniListaArr = [];
                const amendaTotala = document.getElementById('amenda_totala')?.value;
                const arestTotalMin = document.getElementById('arest_total_min')?.value;
                const arestTotalMax = document.getElementById('arest_total_max')?.value;
                const locatieDetentieText = document.getElementById('locatie_detentie')?.options[document.getElementById('locatie_detentie').selectedIndex]?.text;

                if(amendaTotala > 0) sanctiuniListaArr.push((compositePlaceholderTemplates.sanctiuni_amenda || defaultCompositePlaceholderTemplates.sanctiuni_amenda).replace('[VALOARE]', amendaTotala));
                if(arestTotalMax > 0) {
                    sanctiuniListaArr.push((compositePlaceholderTemplates.sanctiuni_arest || defaultCompositePlaceholderTemplates.sanctiuni_arest)
                        .replace('[DURATA]', arestTotalMin === arestTotalMax ? arestTotalMax : `${arestTotalMin}-${arestTotalMax}`)
                        .replace('[LOCATIE]', locatieDetentieText));
                }
                if(document.getElementById('anulare_permis').checked) sanctiuniListaArr.push(compositePlaceholderTemplates.sanctiuni_anulare_permis || defaultCompositePlaceholderTemplates.sanctiuni_anulare_permis);
                if(document.getElementById('ridicare_vehicul').checked) sanctiuniListaArr.push(compositePlaceholderTemplates.sanctiuni_ridicare_vehicul || defaultCompositePlaceholderTemplates.sanctiuni_ridicare_vehicul);
                if(document.getElementById('perchezitie_masura').checked) sanctiuniListaArr.push(compositePlaceholderTemplates.sanctiuni_perchezitie_masura || defaultCompositePlaceholderTemplates.sanctiuni_perchezitie_masura);

                allData['sanctiuni_lista'] = sanctiuniListaArr.length > 0
                    ? sanctiuniListaArr.join('\n')
                    : (compositePlaceholderTemplates.sanctiuni_lista_empty || defaultCompositePlaceholderTemplates.sanctiuni_lista_empty);

                // Perchezitie items
                allData['perchezitie_buzunare_text'] = (allData.perchezitie_buzunare && allData.perchezitie_buzunare.trim() !== '')
                    ? (compositePlaceholderTemplates.perchezitie_buzunare_filled || defaultCompositePlaceholderTemplates.perchezitie_buzunare_filled).replace('[VALOARE]', allData.perchezitie_buzunare.trim())
                    : (compositePlaceholderTemplates.perchezitie_buzunare_empty || defaultCompositePlaceholderTemplates.perchezitie_buzunare_empty);

                allData['perchezitie_torpedo_text'] = (allData.perchezitie_torpedo && allData.perchezitie_torpedo.trim() !== '')
                    ? (compositePlaceholderTemplates.perchezitie_torpedo_filled || defaultCompositePlaceholderTemplates.perchezitie_torpedo_filled).replace('[VALOARE]', allData.perchezitie_torpedo.trim())
                    : (compositePlaceholderTemplates.perchezitie_torpedo_empty || defaultCompositePlaceholderTemplates.perchezitie_torpedo_empty);

                allData['perchezitie_portbagaj_text'] = (allData.perchezitie_portbagaj && allData.perchezitie_portbagaj.trim() !== '')
                    ? (compositePlaceholderTemplates.perchezitie_portbagaj_filled || defaultCompositePlaceholderTemplates.perchezitie_portbagaj_filled).replace('[VALOARE]', allData.perchezitie_portbagaj.trim())
                    : (compositePlaceholderTemplates.perchezitie_portbagaj_empty || defaultCompositePlaceholderTemplates.perchezitie_portbagaj_empty);

                return allData;
            }

            function autoCorrectGrammar(text) {
                if (typeof text !== 'string') return text;
                let correctedText = text;
                correctedText = correctedText.replace(/ *([,;]) */g, '$1 ');
                correctedText = correctedText.charAt(0).toUpperCase() + correctedText.slice(1);
                correctedText = correctedText.replace(/([.!?]\s+)([a-z])/g, (match, p1, p2) => p1 + p2.toUpperCase());
                return correctedText.trim();
            }

            function generateCaseDescription() {
                const loadingIndicator = document.getElementById('caseDescriptionLoading');
                loadingIndicator.classList.remove('hidden-element');
                generatedTitlesOutput.classList.add('hidden-element');
                caseDescriptionOutput.classList.add('hidden-element');

                setTimeout(() => {
                    const allData = collectAndProcessFormData(); // Get all processed data

                    const selectedInfractionIds = infractiuneInputs.map(s => s.dataset.selectedId).filter(v => v);
                    const selectedInfractionsData = selectedInfractionIds.map(id => infractionSanctionsData[id]).filter(Boolean);

                    allData['lista_infractiuni'] = selectedInfractionsData.map(inf => `${inf.numarArticol} - ${inf.titlu}`).join('\n');

                    // --- Build Final Description ---
                    let finalDescription = aiSettings.headerTemplate || defaultAiSettings.headerTemplate;
                    
                    let intro = "\n";
                    const introTemplateKey = `intro_${allData.actiune}`;
                    intro = aiLogicTemplates[introTemplateKey] || defaultAiLogicTemplates[introTemplateKey] || "";
                    finalDescription += `\n\n${intro}`;

                    let infractionDetails = [];
                    selectedInfractionsData.forEach((infractionData, index) => {
                        if (!infractionData) return;
                        let template = infractionData[`modelDescriere${index + 1}`] || autoGenerateTemplateFromDefinition(infractionData);
                        const mentiuniText = document.getElementById(`mentiuni${index + 1}`).value.trim();
                        if (mentiuniText) template += ` ${mentiuniText}`;
                        infractionDetails.push(template);
                    });
                    finalDescription += `\n\n${infractionDetails.join('\n\n')}`;

                    let sanctionsTemplate = aiLogicTemplates.sanctions || defaultAiLogicTemplates.sanctions || "";
                    // The {sanctiuni_lista} placeholder is already processed in collectAndProcessFormData
                    finalDescription += `\n\n${sanctionsTemplate}`;
                    
                    let fullyProcessedText = replacePlaceholders(finalDescription, allData, false);
                    
                    // Adapt gender for main subject
                    fullyProcessedText = adaptTextToGender(fullyProcessedText, allData.sex, 'suspect');
                    
                    // Adapt gender for claimant/victim
                    fullyProcessedText = adaptTextToGender(fullyProcessedText, allData.sex_reclamant, 'reclamant');
                    
                    // Adapt gender for witnesses
                    const martorEntries = document.querySelectorAll('.martor-entry');
                    martorEntries.forEach((entry, index) => {
                        const sexRadio = entry.querySelector(`input[name^="sex_martor_"]:checked`);
                        const sex = sexRadio ? sexRadio.value : 'masculin';
                        fullyProcessedText = adaptTextToGender(fullyProcessedText, sex, `martor_${index+1}`);
                    });

                    fullyProcessedText = autoCorrectGrammar(fullyProcessedText);
                    caseDescriptionOutput.value = fullyProcessedText;
                    
                    // --- Build Title ---
                    selectedInfractionsData.sort((a, b) => (String(b.numarArticol).localeCompare(String(a.numarArticol), undefined, {numeric: true})));
                    
                    let finalTitle = "";
                    if (selectedInfractionsData.length > 0) {
                        const infractionTitles = selectedInfractionsData.map(inf => inf.titlu).join(aiSettings.titleSeparator || defaultAiSettings.titleSeparator);
                        const mainChapter = selectedInfractionsData[0].capitolText;
                        finalTitle = (aiSettings.titleFormat || defaultAiSettings.titleFormat)
                            .replace('{titluri_infractiuni}', infractionTitles)
                            .replace('{capitol_principal}', mainChapter);
                    } else {
                        finalTitle = "Diverse";
                    }
                    generatedTitlesOutput.value = finalTitle;
                    
                    loadingIndicator.classList.add('hidden-element');
                    generatedTitlesOutput.classList.remove('hidden-element');
                    caseDescriptionOutput.classList.remove('hidden-element');
                    showToast('Descrierea infracțiunilor a fost generată!', true);

                }, 500);
            }

            function populatePlaceholdersList() {
                const listContainer = document.getElementById('placeholders-list');
                if (!listContainer) return;

                const keySet = new Set();
                const formElements = document.querySelectorAll('#procesatorForm input[id], #procesatorForm select[id], #procesatorForm textarea[id]');
                formElements.forEach(element => {
                    const id = element.type === 'radio' ? element.name : element.id;
                    if (id) keySet.add(`{${id}}`);
                });

                const modalElements = document.querySelectorAll('#agentiModal input[id], #agentiModal select[id]');
                 modalElements.forEach(element => {
                     if (element.id) keySet.add(`{${element.id}}`);
                });
                
                const conceptualPlaceholders = [
                    'articol_cap', 'articol_numar_input', 'articol_titlu', 'articol_definitie',
                    'model_descriere_1', 'model_descriere_2', 'model_descriere_3',
                    'mentiuni1', 'mentiuni2', 'mentiuni3',
                    'buzunare', 'torpedo', 'portbagaj', 'braconaj',
                    'lista_infractiuni', 'patrola_text', 'partea_vatamata_text', 'martori_text',
                    'nume_martor_1', 'cnp_martor_1', 'nume_martor_2', 'cnp_martor_2',
                    // Add new formatted placeholders that are generated in collectAndProcessFormData
                    'nr_inmatriculare_text', 'tip_vehicul_procesator_formatted', 'autospeciala_select_formatted',
                    'autospeciala_select_genitive', 'lipsa_licenta_1_text', 'lipsa_licenta_2_text',
                    'perchezitie_buzunare_text', 'perchezitie_torpedo_text', 'perchezitie_portbagaj_text',
                    'sanctiuni_lista'
                ];
                conceptualPlaceholders.forEach(p => keySet.add(`{${p}}`));

                listContainer.innerHTML = '';
                Array.from(keySet).sort().forEach(placeholder => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-800 p-2 rounded-md text-center text-sm text-sky-400 font-mono cursor-pointer hover:bg-sky-900 overflow-hidden text-ellipsis whitespace-nowrap';
                    item.textContent = placeholder;
                    item.title = placeholder;
                    item.addEventListener('click', () => copyToClipboard(placeholder, "Placeholder"));
                    listContainer.appendChild(item);
                });
            }
            
            function exportPlaceholdersList() {
                const placeholderDivs = document.querySelectorAll('#placeholders-list > div');
                let textContent = Array.from(placeholderDivs).map(div => div.textContent).join('\n');
                
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'placeholders.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Lista de placeholderi a fost exportată!', true);
            }

            function checkPlaceholderValue() {
                if (!placeholderInput || !placeholderOutput) return;
                const placeholder = placeholderInput.value.trim();
                if (!placeholder.startsWith('{') || !placeholder.endsWith('}')) {
                    placeholderOutput.innerHTML = '<span class="text-red-400">Format invalid</span>';
                    return;
                }
                const key = placeholder.slice(1, -1);
                const allData = collectAndProcessFormData(); // Use the new function
                
                let value = allData[key];
                if (value === undefined) value = '<span class="text-red-400">[N/A]</span>';
                else if (value === '' || value === false) value = '<span class="text-gray-500">[GOL]</span>';
                placeholderOutput.innerHTML = value;
            }

            function displayVerificationDetails(articleId) {
                const detailsContainer = document.getElementById('verificare_articol_details');
                const articleData = infractionSanctionsData[articleId];
                if (!detailsContainer || !articleData) {
                    detailsContainer.classList.add('hidden-element');
                    return;
                }
                detailsContainer.innerHTML = '';
                const definitionP = document.createElement('p');
                definitionP.className = 'font-bold text-white mb-2';
                definitionP.textContent = articleData.definitie;
                detailsContainer.appendChild(definitionP);
                const sanctionsDiv = document.createElement('div');
                sanctionsDiv.className = 'flex flex-col gap-1 text-sm';
                let feedbackHTML = '';
                if (articleData.amendaMin !== undefined && articleData.amendaMax !== undefined) {
                    if (articleData.amendaMin === art.amendaMax && art.amendaMin > 0) feedbackHTML += `<p class="text-green-400">Amendă: ${articleData.amendaMin}$</p>`;
                    else if (articleData.amendaMin !== art.amendaMax && (articleData.amendaMin > 0 || articleData.amendaMax > 0)) feedbackHTML += `<p class="text-green-400">Amendă: ${articleData.amendaMin}-${articleData.amendaMax}$</p>`;
                }
                if (articleData.arestMin !== undefined && articleData.arestMax !== undefined) {
                    if (articleData.arestPeViata) feedbackHTML += `<p class="text-red-400">Arest: ${art.arestMin > 0 ? art.arestMin + ' luni - ' : ''}Pe viață</p>`;
                    else if (articleData.arestMin === art.arestMax && articleData.arestMin > 0) feedbackHTML += `<p class="text-red-400">Arest: ${articleData.arestMin} luni</p>`;
                    else if (articleData.arestMin !== art.arestMax && (articleData.arestMin > 0 || articleData.arestMax > 0)) feedbackHTML += `<p class="text-red-400">Arest: ${articleData.arestMin}-${articleData.arestMax} luni</p>`;
                }
                if (articleData.punctePenalizare > 0) feedbackHTML += `<p class="text-blue-400">Puncte: ${articleData.punctePenalizare}</p>`;
                let sanctionsText = [];
                if (articleData.anularePermis) sanctionsText.push("Anulare Permis");
                if (articleData.ridicareVehicul) sanctionsText.push("Ridicare Autovehicul");
                if (articleData.perchezitie) sanctionsText.push("Percheziție Necesara");
                if (sanctionsText.length > 0) feedbackHTML += `<p class="text-yellow-400">Măsuri: ${sanctionsText.join(', ')}</p>`;
                sanctionsDiv.innerHTML = feedbackHTML;
                detailsContainer.appendChild(sanctionsDiv);
                detailsContainer.classList.remove('hidden-element');
            }

            function handleVerification() {
                const inputValue = verificareArticolInput.value;
                const selectedArticle = codPenalEntries.find(art => `${art.numarArticol} - ${art.titlu}` === inputValue);
                if (selectedArticle) displayVerificationDetails(selectedArticle.id);
                else document.getElementById('verificare_articol_details').classList.add('hidden-element');
            }
            
            function loadAndDisplayAiTemplates() {
                const savedTemplates = localStorage.getItem('aiLogicTemplates');
                aiLogicTemplates = savedTemplates ? JSON.parse(savedTemplates) : { ...defaultAiLogicTemplates };
                Object.keys(defaultAiLogicTemplates).forEach(key => {
                    const el = document.getElementById(`template_${key}`);
                    if (el) el.value = aiLogicTemplates[key] || defaultAiLogicTemplates[key];
                });
            }
            
            function saveAiTemplates() {
                Object.keys(defaultAiLogicTemplates).forEach(key => {
                    const el = document.getElementById(`template_${key}`);
                    if (el) aiLogicTemplates[key] = el.value;
                });
                localStorage.setItem('aiLogicTemplates', JSON.stringify(aiLogicTemplates));
                showToast("Șabloanele de bază au fost salvate!", true);
            }

            function loadAiSettings() {
                const savedSettings = localStorage.getItem('aiSettings');
                aiSettings = savedSettings ? JSON.parse(savedSettings) : { ...defaultAiSettings };
                const headerTemplateTextarea = document.getElementById('composite_header_template'); // Corrected ID
                const aiPromptInstructions = document.getElementById('ai_prompt_instructions'); // Corrected ID
                const titleSeparatorInput = document.getElementById('title_separator_input'); // Corrected ID
                const titleFormatInput = document.getElementById('title_format_input'); // Corrected ID

                if(headerTemplateTextarea) {
                    headerTemplateTextarea.value = aiSettings.headerTemplate || defaultAiSettings.headerTemplate;
                }
                if(aiPromptInstructions) {
                    aiPromptInstructions.value = aiSettings.prompt || defaultAiSettings.prompt;
                }
                if(titleSeparatorInput) {
                    titleSeparatorInput.value = aiSettings.titleSeparator || defaultAiSettings.titleSeparator;
                }
                if(titleFormatInput) {
                    titleFormatInput.value = aiSettings.titleFormat || defaultAiSettings.titleFormat;
                }
            }

            function saveAiSettings() {
                aiSettings.prompt = document.getElementById('ai_prompt_instructions_modal').value; // Corrected ID
                aiSettings.titleSeparator = document.getElementById('title_separator_input_modal').value; // Corrected ID
                aiSettings.titleFormat = document.getElementById('title_format_input_modal').value; // Corrected ID
                aiSettings.headerTemplate = document.getElementById('composite_header_template_modal').value; // Corrected ID
                localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
                loadAiSettings(); // Re-load to update the disabled textarea
                showToast("Setările avansate au fost salvate!", true);
            }

            // NEW: Load and Save functions for Composite Placeholders
            function loadCompositePlaceholderTemplates() {
                const savedTemplates = localStorage.getItem('compositePlaceholderTemplates');
                compositePlaceholderTemplates = savedTemplates ? JSON.parse(savedTemplates) : { ...defaultCompositePlaceholderTemplates };

                Object.keys(defaultCompositePlaceholderTemplates).forEach(key => {
                    const el = document.getElementById(`composite_${key}`);
                    if (el) {
                        el.value = compositePlaceholderTemplates[key] || defaultCompositePlaceholderTemplates[key];
                    }
                });
            }

            function saveCompositePlaceholderTemplates() {
                Object.keys(defaultCompositePlaceholderTemplates).forEach(key => {
                    const el = document.getElementById(`composite_${key}`);
                    if (el) {
                        compositePlaceholderTemplates[key] = el.value;
                    }
                });
                localStorage.setItem('compositePlaceholderTemplates', JSON.stringify(compositePlaceholderTemplates));
                showToast("Șabloanele placeholderilor compuși au fost salvate!", true);
            }

            function getContrastColor(hexcolor) {
                if(hexcolor.slice(0, 1) === '#') hexcolor = hexcolor.slice(1);
                const r = parseInt(hexcolor.substr(0, 2), 16);
                const g = parseInt(hexcolor.substr(3, 5), 16);
                const b = parseInt(hexcolor.substr(5, 7), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#0D1117' : '#C9D1D9';
            }

            function applyCustomColors() {
                const savedColors = JSON.parse(localStorage.getItem('appColors')) || {};
                Object.keys(defaultColors).forEach(key => {
                    let colorValue = savedColors[key] || defaultColors[key];
                    let r, g, b, a;

                    // Try to parse as RGBA first
                    const rgbaParsed = parseRgba(colorValue);
                    r = rgbaParsed.r;
                    g = rgbaParsed.g;
                    b = rgbaParsed.b;
                    a = rgbaParsed.a;

                    // Set CSS variable
                    document.documentElement.style.setProperty(`--${key}`, formatRgba(r, g, b, a));

                    // Update color picker (RGB part)
                    const colorPicker = document.getElementById(`color-${key}`);
                    if (colorPicker) {
                        colorPicker.value = rgbToHex(r, g, b);
                    }

                    // Update alpha slider and value display
                    const alphaSlider = document.getElementById(`alpha-${key}`);
                    const alphaValueDisplay = document.getElementById(`alpha-value-${key}`);
                    if (alphaSlider && alphaValueDisplay) {
                        alphaSlider.value = a;
                        alphaValueDisplay.textContent = a.toFixed(2);
                    }
                });
            }

            function saveColorSetting(key, value, isAlpha = false) {
                const savedColors = JSON.parse(localStorage.getItem('appColors')) || {};
                let currentColor = parseRgba(savedColors[key] || defaultColors[key]);

                if (isAlpha) {
                    currentColor.a = parseFloat(value);
                } else { // It's an RGB hex value from color picker
                    const { r, g, b } = hexToRgb(value);
                    currentColor.r = r;
                    currentColor.g = g;
                    currentColor.b = b;
                }
                
                savedColors[key] = formatRgba(currentColor.r, currentColor.g, currentColor.b, currentColor.a);
                localStorage.setItem('appColors', JSON.stringify(savedColors));
                applyCustomColors(); // Re-apply to update all displays and CSS variables
            }

            function resetColorsToDefault() {
                 // Using a custom modal/message box instead of confirm()
                 const confirmation = window.confirm('Sunteți sigur că doriți să resetați toate culorile la valorile implicite?'); // Placeholder for custom modal
                 if (confirmation) {
                    localStorage.removeItem('appColors');
                    applyCustomColors();
                    showToast('Culorile au fost resetate.', true);
                 }
            }

            function preventInvalidNumberInput(event) {
                if (['e', 'E', '+', '-', '.'].includes(event.key)) event.preventDefault();
            }

            function validateField(field) {
                if (!field || !field.id || field.classList.contains('input-field-readonly') || field.classList.contains('always-blue') || field.classList.contains('no-validation')) return;
                const isOptional = ['nume_reclamant', 'cnp_reclamant', 'nr_inmatriculare'].includes(field.id) || field.id.startsWith('infractiune2') || field.id.startsWith('infractiune3') || field.id.startsWith('mentiuni');
                if (field.value.trim() !== '') {
                    field.classList.add('completed');
                    field.classList.remove('incomplete');
                } else {
                    field.classList.remove('completed');
                    if (!isOptional) field.classList.add('incomplete');
                    else field.classList.remove('incomplete');
                }
            }

            function validateAllFields() {
                document.querySelectorAll('#procesatorForm .input-field, #procesatorForm .select-field, #procesatorForm .textarea-field').forEach(field => validateField(field));
            }
            
            function handleInfractionInput(event) {
                const input = event.target;
                const foundArticle = codPenalEntries.find(art => `${art.numarArticol} - ${art.titlu}` === input.value);
                input.dataset.selectedId = foundArticle ? foundArticle.id : '';
                updateAllPreviews();
                updateSanctionsTables();
            }

            function updateAllPreviews() {
                const allData = collectAndProcessFormData(); // Use the new function to get processed data
                infractiuneInputs.forEach((input, index) => {
                    const previewDiv = document.getElementById(`preview_template${index + 1}`);
                    const selectedId = input.dataset.selectedId;
                    if (selectedId && infractionSanctionsData[selectedId]) {
                        const art = infractionSanctionsData[selectedId];
                        let template = art[`modelDescriere${index + 1}`] || autoGenerateTemplateFromDefinition(art);
                        previewDiv.innerHTML = replacePlaceholders(template, allData, true); // Pass allData and true for preview
                    } else {
                        previewDiv.innerHTML = '';
                    }
                });
            }
            
            function addWitnessField() {
                martorCounter++;
                const div = document.createElement('div');
                div.className = 'martor-entry p-3 border border-dashed border-gray-600/50 rounded-lg relative';
                div.id = `martor_entry_${martorCounter}`;
                div.innerHTML = `
                    <button type="button" class="absolute top-1 right-1 btn-danger !p-0 !text-xs h-6 w-6 rounded-full flex items-center justify-center delete-martor-btn" title="Șterge Martor">&times;</button>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="nume_martor_${martorCounter}" class="label-text text-xs">Nume Martor ${martorCounter}:</label>
                            <div class="input-group"><i class="fa-solid fa-user"></i><input type="text" id="nume_martor_${martorCounter}" class="input-field no-validation" placeholder="Numele martorului"></div>
                        </div>
                        <div>
                            <label for="cnp_martor_${martorCounter}" class="label-text text-xs">CNP Martor ${martorCounter}:</label>
                            <div class="input-group"><i class="fa-solid fa-id-card"></i><input type="number" id="cnp_martor_${martorCounter}" class="input-field no-validation" placeholder="CNP-ul martorului" min="0"></div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="label-text text-xs">Sex Martor ${martorCounter}:</label>
                        <div class="control-group mt-1">
                            <label class="control-label"><input type="radio" name="sex_martor_${martorCounter}" value="masculin" class="control-input radio-input" checked> Masculin</label>
                            <label class="control-label"><input type="radio" name="sex_martor_${martorCounter}" value="feminin" class="control-input radio-input"> Feminin</label>
                        </div>
                    </div>`;
                martoriContainer.appendChild(div);
                div.querySelector('.delete-martor-btn').addEventListener('click', () => div.remove());
            }

            function loadGhidContent() {
                const savedGhidHTML = localStorage.getItem('ghidContentHTML');
                if (tutorialContentContainer) {
                    tutorialContentContainer.innerHTML = savedGhidHTML || defaultGhidHTML;
                }
            }

            function formatDoc(cmd, value = null) {
                if (cmd === 'foreColor' && value) {
                    document.execCommand(cmd, false, value);
                } else {
                    document.execCommand(cmd, false, null);
                }
                ghidEditor.focus();
            }

            // --- Event Listeners Setup ---
            mainTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    mainTabButtons.forEach(btn => btn.classList.remove('active'));
                    mainTabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab)?.classList.add('active');
                });
            });

            document.querySelectorAll('.sub-tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const container = button.closest('.sub-tab-container');
                    container.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const parentContent = button.closest('.tab-content');
                    parentContent.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(button.dataset.subtab)?.classList.add('active');
                });
            });

            document.querySelectorAll('input[name="actiune"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    document.getElementById('jaf_box').classList.toggle('hidden-element', radio.value !== 'alarma_jaf');
                    [substantaCheckbox, perchezitieCheckbox, crimaOrganizataCheckbox, licenteCheckbox].forEach(cb => { cb.checked = false; });
                    switch (radio.value) {
                        case 'razie_mineriada': licenteCheckbox.checked = true; break;
                        case 'razie_main':
                        case 'detectie_focuri_arma': perchezitieCheckbox.checked = true; break;
                        case 'razie_rutiera': substantaCheckbox.checked = true; break;
                    }
                    [substantaCheckbox, perchezitieCheckbox, crimaOrganizataCheckbox, licenteCheckbox].forEach(cb => cb.dispatchEvent(new Event('change')));
                });
            });
            
            if (adaugaMartorBtn) adaugaMartorBtn.addEventListener('click', addWitnessField);

            seteazaPatrulaBtn.addEventListener('click', () => {
                const agentData = JSON.parse(sessionStorage.getItem('patrolData')) || {};
                Object.keys(agentData).forEach(key => {
                    const el = document.getElementById(key.replace(/([A-Z])/g, '_$1').toLowerCase() + '_modal');
                    if(el) {
                        if(el.type === 'checkbox') el.checked = (agentData[key] === 'Da');
                        else el.value = agentData[key] || '';
                    }
                });
                agentiModal.classList.remove('hidden-element');
            });

            salveazaAgentiModalBtn.addEventListener('click', () => {
                const patrolData = {
                    AgentOpCallSign: document.getElementById('agent_op_call_sign_modal').value.trim(),
                    AgentOpGrad: document.getElementById('agent_op_grad_modal').value,
                    AgentOpNume: document.getElementById('agent_op_nume_modal').value.trim(),
                    AgentConstCallSign: document.getElementById('agent_const_call_sign_modal').value.trim(),
                    AgentConstGrad: document.getElementById('agent_const_grad_modal').value,
                    AgentConstNume: document.getElementById('agent_const_nume_modal').value.trim(),
                    IncludeAgentConst: document.getElementById('include_agent_const_checkbox_modal').checked ? 'Da' : 'Nu',
                    AgentAd1CallSign: document.getElementById('agent_ad1_call_sign_modal').value.trim(),
                    AgentAd1Grad: document.getElementById('agent_ad1_grad_modal').value,
                    AgentAd1Nume: document.getElementById('agent_ad1_nume_modal').value.trim(),
                    IncludeAgentAd1: document.getElementById('include_agent_ad1_checkbox_modal').checked ? 'Da' : 'Nu',
                    AgentAd2CallSign: document.getElementById('agent_ad2_call_sign_modal').value.trim(),
                    AgentAd2Grad: document.getElementById('agent_ad2_grad_modal').value,
                    AgentAd2Nume: document.getElementById('agent_ad2_nume_modal').value.trim(),
                    IncludeAgentAd2: document.getElementById('include_agent_ad2_checkbox_modal').checked ? 'Da' : 'Nu',
                };
                sessionStorage.setItem('patrolData', JSON.stringify(patrolData));
                agentiModal.classList.add('hidden-element');
                showToast('Datele patrulei au fost salvate pentru această sesiune.', true);
                displayPatrolInfo();
            });
            
            anuleazaAgentiModalBtn.addEventListener('click', () => agentiModal.classList.add('hidden-element'));
            closeAgentiModalBtn.addEventListener('click', () => agentiModal.classList.add('hidden-element'));
            
            resetFormBtn.addEventListener('click', resetFormFields);
            copyDescriptionBtn.addEventListener('click', () => copyToClipboard(caseDescriptionOutput.value, "Descrierea"));
            copyTitlesBtn.addEventListener('click', () => copyToClipboard(generatedTitlesOutput.value, "Titlurile"));
            zonaSelect.addEventListener('input', updateSpeedLimitDisplay); 
            arestTotalMaxInput.addEventListener('input', toggleArestDetailsVisibility);
            infractiuneInputs.forEach(input => input?.addEventListener('input', handleInfractionInput));
            generateCaseDescriptionBtn.addEventListener('click', generateCaseDescription);
            if(actualizeazaDateTimeBtn) actualizeazaDateTimeBtn.addEventListener('click', updateDateTimeFields);
            if (verificareArticolInput) verificareArticolInput.addEventListener('input', handleVerification);
            if(placeholderInput) placeholderInput.addEventListener('input', checkPlaceholderValue);
            if (exportPlaceholdersBtn) exportPlaceholdersBtn.addEventListener('click', exportPlaceholdersList);
            if (saveAiLogicBtn) saveAiLogicBtn.addEventListener('click', saveAiTemplates);
            if (aiSettingsBtn) aiSettingsBtn.addEventListener('click', () => {
                document.getElementById('ai_prompt_instructions').value = aiSettings.prompt || defaultAiSettings.prompt;
                document.getElementById('title_separator_input').value = aiSettings.titleSeparator || defaultAiSettings.titleSeparator;
                document.getElementById('title_format_input').value = aiSettings.titleFormat || defaultAiSettings.titleFormat;
                document.getElementById('composite_header_template').value = aiSettings.headerTemplate || defaultAiSettings.headerTemplate;
                aiSettingsModal.classList.remove('hidden-element');
            });
            if (salveazaAiSettingsModalBtn) salveazaAiSettingsModalBtn.addEventListener('click', () => {
                saveAiSettings();
                aiSettingsModal.classList.add('hidden-element');
            });
            if (anuleazaAiSettingsModalBtn) anuleazaAiSettingsModalBtn.addEventListener('click', () => aiSettingsModal.classList.add('hidden-element'));
            if (closeAiSettingsModalBtn) closeAiSettingsModalBtn.addEventListener('click', () => aiSettingsModal.classList.add('hidden-element'));
            
            if (editGhidBtn) editGhidBtn.addEventListener('click', () => {
                ghidEditor.innerHTML = tutorialContentContainer.innerHTML;
                ghidModal.classList.remove('hidden-element');
            });
            if (salveazaGhidModalBtn) salveazaGhidModalBtn.addEventListener('click', () => {
                const newGhidHTML = ghidEditor.innerHTML;
                tutorialContentContainer.innerHTML = newGhidHTML;
                localStorage.setItem('ghidContentHTML', newGhidHTML);
                ghidModal.classList.add('hidden-element');
                showToast('Ghidul a fost salvat cu succes!', true);
            });
            if (closeGhidModalBtn) closeGhidModalBtn.addEventListener('click', () => ghidModal.classList.add('hidden-element'));
            if (anuleazaGhidModalBtn) anuleazaGhidModalBtn.addEventListener('click', () => ghidModal.classList.add('hidden-element'));
            if (ghidEditorToolbar) {
                ghidEditorToolbar.querySelectorAll('.toolbar-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        formatDoc(e.currentTarget.dataset.command);
                    });
                });
                const colorInput = document.getElementById('ghidFontColor');
                if(colorInput) {
                    colorInput.addEventListener('input', (e) => {
                        formatDoc('foreColor', e.target.value);
                    });
                }
            }

            document.querySelectorAll('#aspect_subtab input[type="color"]').forEach(picker => {
                picker.addEventListener('input', (event) => {
                    const colorVar = event.target.dataset.colorVar;
                    saveColorSetting(colorVar, event.target.value);
                    applyCustomColors();
                });
            });

            const resetColorsBtn = document.getElementById('resetColorsBtn');
            if (resetColorsBtn) resetColorsBtn.addEventListener('click', resetColorsToDefault);
            
            if(articolArestPeViataCheckbox) {
                articolArestPeViataCheckbox.addEventListener('change', function() {
                    if(articolArestMaxInput) {
                        articolArestMaxInput.disabled = this.checked;
                        if(this.checked) articolArestMaxInput.value = '';
                    }
                });
            }

            // NOU: Event listeners pentru modalul de placeholders compusi
            if (showCompositePlaceholdersBtn) {
                showCompositePlaceholdersBtn.addEventListener('click', () => {
                    loadCompositePlaceholderTemplates(); // Load data when opening
                    if (compositePlaceholdersModal) compositePlaceholdersModal.classList.remove('hidden-element');
                });
            }
            if (closeCompositePlaceholdersModalBtn) {
                closeCompositePlaceholdersModalBtn.addEventListener('click', () => {
                    if (compositePlaceholdersModal) compositePlaceholdersModal.classList.add('hidden-element');
                });
            }
            if (salveazaCompositePlaceholdersBtn) { // NEW: Save button for composite placeholders
                salveazaCompositePlaceholdersBtn.addEventListener('click', () => {
                    saveCompositePlaceholderTemplates();
                    if (compositePlaceholdersModal) compositePlaceholdersModal.classList.add('hidden-element');
                });
            }
            if (anuleazaCompositePlaceholdersBtn) { // NEW: Cancel button for composite placeholders
                anuleazaCompositePlaceholdersBtn.addEventListener('click', () => {
                    if (compositePlaceholdersModal) compositePlaceholdersModal.classList.add('hidden-element');
                });
            }


            codPenalForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const capitolText = document.getElementById('articol_cap').value.trim();
                const numarArticol = document.getElementById('articol_numar_input').value.trim();
                const titlu = document.getElementById('articol_titlu').value.trim();
                const definitie = document.getElementById('articol_definitie').value.trim();
                if (!capitolText || !numarArticol || !titlu || !definitie) {
                    showToast("Toate câmpurile principale ale articolului sunt obligatorii!", false);
                    return;
                }
                const amendaMin = parseInt(document.getElementById('articol_amenda_min').value) || 0;
                const arestPeViata = document.getElementById('articol_arest_pe_viata').checked;
                const articleData = { 
                    capitolText, numarArticol, titlu, definitie, amendaMin, 
                    amendaMax: parseInt(document.getElementById('articol_amenda_max').value) || amendaMin,
                    arestMin: parseInt(document.getElementById('articol_arest_min').value) || 0,
                    arestMax: arestPeViata ? 999 : (parseInt(document.getElementById('articol_arest_max').value) || (parseInt(document.getElementById('articol_arest_min').value) || 0)),
                    arestPeViata, 
                    punctePenalizare: parseInt(document.getElementById('articol_puncte_permis').value) || 0,
                    anularePermis: document.getElementById('articol_anulare_permis').checked,
                    ridicareVehicul: document.getElementById('articol_ridicare_vehicul').checked,
                    perchezitie: document.getElementById('articol_perchezitie').checked,
                    modelDescriere1: document.getElementById('articol_model_descriere_1').value.trim(),
                    modelDescriere2: document.getElementById('articol_model_descriere_2').value.trim(),
                    modelDescriere3: document.getElementById('articol_model_descriere_3').value.trim(),
                    incompatibilCu: Array.from(document.querySelectorAll('.incompatibilitate-checkbox:checked')).map(cb => cb.value)
                };
                const currentId = (editingCodPenalIndex !== null) ? codPenalEntries[editingCodPenalIndex].id : generateArticleId(capitolText, numarArticol, titlu);
                articleData.id = currentId;
                if (editingCodPenalIndex !== null) { 
                    codPenalEntries[editingCodPenalIndex] = articleData;
                } else { 
                    if (codPenalEntries.some(art => art.id === articleData.id)) {
                        showToast("Un articol cu acest ID există deja!", false);
                        return;
                    }
                    codPenalEntries.push(articleData);
                }
                codPenalEntries.forEach(otherArt => {
                    if (otherArt.id === currentId) return; 
                    const indexToRemove = otherArt.incompatibilCu.indexOf(currentId);
                    if (articleData.incompatibilCu.includes(otherArt.id)) {
                        if (indexToRemove === -1) otherArt.incompatibilCu.push(currentId);
                    } else { 
                        if (indexToRemove > -1) otherArt.incompatibilCu.splice(indexToRemove, 1);
                    }
                });
                editingCodPenalIndex = null;
                document.getElementById('salveazaArticolBtn').textContent = "Salvează Articol";
                document.getElementById('salveazaArticolBtn').classList.remove('btn-edit-mode');
                localStorage.setItem('codPenalData', JSON.stringify(codPenalEntries)); 
                populateInfractionSanctionsData(); 
                populateInfractionDatalist(); 
                renderCodPenalList(); 
                codPenalForm.reset(); 
                articolArestMaxInput.disabled = false;
                renderIncompatibilitatiCheckboxes(); 
                showToast("Articol salvat!", true);
            });

             listaArticoleCodPenalDiv.addEventListener('click', function(event) {
                const target = event.target;
                if (target.classList.contains('delete-articol-btn')) {
                    const index = parseInt(target.dataset.index);
                    if (confirm(`Sigur doriți să ștergeți articolul?`)) { 
                        const deletedId = codPenalEntries[index].id;
                        codPenalEntries.splice(index, 1);
                        codPenalEntries.forEach(art => {
                            const idx = art.incompatibilCu.indexOf(deletedId);
                            if (idx > -1) art.incompatibilCu.splice(idx, 1);
                        });
                        localStorage.setItem('codPenalData', JSON.stringify(codPenalEntries)); 
                        populateInfractionSanctionsData();
                        populateInfractionDatalist();
                        renderCodPenalList();
                        renderIncompatibilitatiCheckboxes(); 
                    }
                }
                if (target.classList.contains('edit-articol-btn')) {
                    const index = parseInt(target.dataset.index);
                    const art = codPenalEntries[index];
                    Object.keys(art).forEach(key => {
                        const el = document.getElementById(`articol_${key.replace(/([A-Z])/g, '_$1').toLowerCase()}`);
                        if(el) {
                            if(el.type === 'checkbox') el.checked = art[key];
                            else el.value = art[key] || '';
                        }
                    });
                    document.getElementById('articol_cap').value = art.capitolText;
                    document.getElementById('articol_numar_input').value = art.numarArticol;
                    document.getElementById('articol_arest_max').value = art.arestPeViata ? '' : art.arestMax;
                    articolArestMaxInput.disabled = art.arestPeViata;
                    editingCodPenalIndex = index;
                    document.getElementById('salveazaArticolBtn').textContent = "Salvează Modificări";
                    document.getElementById('salveazaArticolBtn').classList.add('btn-edit-mode');
                    renderIncompatibilitatiCheckboxes(art.id, art.incompatibilCu || []); 
                }
            });
            
            addSpeedLimitBtn.addEventListener('click', () => {
                const streetName = streetNameSettingsInput.value.trim();
                const speedLimit = speedLimitSettingsInput.value.trim();
                if (!streetName || !speedLimit) {
                    showToast("Ambele câmpuri sunt obligatorii.", false);
                    return;
                }
                const streetId = streetName.toLowerCase().replace(/\s+/g, '_');
                if (editingSpeedLimitIndex !== null) {
                    streetSpeedLimitsData[editingSpeedLimitIndex] = { id: streetId, name: streetName, limit: speedLimit };
                    editingSpeedLimitIndex = null;
                    addSpeedLimitBtn.textContent = "Adaugă Limită";
                } else {
                    if (streetSpeedLimitsData.some(item => item.id === streetId)) {
                        showToast("O stradă cu acest nume există deja!", false);
                        return;
                    }
                    streetSpeedLimitsData.push({ id: streetId, name: streetName, limit: speedLimit });
                }
                streetNameSettingsInput.value = '';
                speedLimitSettingsInput.value = '';
                renderSpeedLimitsList();
                localStorage.setItem('streetSpeedLimitsData', JSON.stringify(streetSpeedLimitsData)); 
                showToast("Limită de viteză salvată.", true);
            });

            speedLimitListUL.addEventListener('click', (event) => {
                const target = event.target;
                const index = parseInt(target.dataset.index);
                if (target.classList.contains('delete-speed-limit-btn')) {
                    streetSpeedLimitsData.splice(index, 1);
                    renderSpeedLimitsList();
                    localStorage.setItem('streetSpeedLimitsData', JSON.stringify(streetSpeedLimitsData)); 
                }
                if (target.classList.contains('edit-speed-limit-btn')) {
                    const itemToEdit = streetSpeedLimitsData[index];
                    streetNameSettingsInput.value = itemToEdit.name;
                    speedLimitSettingsInput.value = itemToEdit.limit;
                    editingSpeedLimitIndex = index;
                    addSpeedLimitBtn.textContent = "Salvează Modificări";
                }
            });

            addCustomVehicleBtn.addEventListener('click', () => {
                const modelName = vehicleModelSettingsInput.value.trim();
                const vehicleType = vehicleTypeSettingsSelect.value;
                if (!modelName || !vehicleType) {
                    showToast("Ambele câmpuri sunt obligatorii.", false);
                    return;
                }
                const modelId = `${vehicleType}_${modelName.toLowerCase().replace(/\s+/g, '_')}`;
                if (editingVehicleIndex !== null) {
                    customVehicleModels[editingVehicleIndex] = { id: modelId, name: modelName, type: vehicleType };
                    editingVehicleIndex = null;
                    addCustomVehicleBtn.textContent = "Adaugă Vehicul";
                } else {
                    if (customVehicleModels.some(model => model.id === modelId)) {
                        showToast("Acest model există deja!", false);
                        return; 
                    }
                    customVehicleModels.push({ id: modelId, name: modelName, type: vehicleType });
                }
                vehicleModelSettingsInput.value = '';
                renderCustomVehicleList();
                localStorage.setItem('customVehicleModels', JSON.stringify(customVehicleModels));
                showToast("Vehicul salvat.", true); 
            });

            customVehicleListUL.addEventListener('click', (event) => {
                const target = event.target;
                const index = parseInt(target.dataset.index);
                if (target.classList.contains('delete-vehicle-btn')) {
                    customVehicleModels.splice(index, 1);
                    renderCustomVehicleList();
                    localStorage.setItem('customVehicleModels', JSON.stringify(customVehicleModels)); 
                }
                if (target.classList.contains('edit-vehicle-btn')) {
                    const vehicleToEdit = customVehicleModels[index];
                    vehicleModelSettingsInput.value = vehicleToEdit.name;
                    vehicleTypeSettingsSelect.value = vehicleToEdit.type;
                    editingVehicleIndex = index;
                    addCustomVehicleBtn.textContent = "Salvează Modificări";
                }
            });

            editeazaDescrieriBtn.addEventListener('click', () => {
                const art = (editingCodPenalIndex !== null) ? codPenalEntries[editingCodPenalIndex] : {};
                modalDescriere1.value = art.modelDescriere1 || document.getElementById('articol_model_descriere_1').value;
                modalDescriere2.value = art.modelDescriere2 || document.getElementById('articol_model_descriere_2').value;
                modalDescriere3.value = art.modelDescriere3 || document.getElementById('articol_model_descriere_3').value;
                descrieriModal.classList.remove('hidden-element');
            });
            
            salveazaDescrieriModalBtn.addEventListener('click', () => {
                const descs = {
                    modelDescriere1: modalDescriere1.value,
                    modelDescriere2: modalDescriere2.value,
                    modelDescriere3: modalDescriere3.value
                };
                document.getElementById('articol_model_descriere_1').value = descs.modelDescriere1;
                document.getElementById('articol_model_descriere_2').value = descs.modelDescriere2;
                document.getElementById('articol_model_descriere_3').value = descs.modelDescriere3;
                if (editingCodPenalIndex !== null) Object.assign(codPenalEntries[editingCodPenalIndex], descs);
                descrieriModal.classList.add('hidden-element');
                showToast('Descrierile au fost actualizate temporar.', true);
            });

            anuleazaDescrieriModalBtn.addEventListener('click', () => descrieriModal.classList.add('hidden-element'));
            closeDescrieriModalBtn.addEventListener('click', () => descrieriModal.classList.add('hidden-element'));

            exportAllSettingsBtn.addEventListener('click', () => {
                const allSettingsData = {
                    codPenal: codPenalEntries,
                    vehicule: customVehicleModels,
                    limiteViteza: streetSpeedLimitsData,
                    aiLogic: aiLogicTemplates,
                    aiSettings: aiSettings,
                    colors: JSON.parse(localStorage.getItem('appColors')) || {},
                    ghidHTML: localStorage.getItem('ghidContentHTML') || tutorialContentContainer.innerHTML,
                    compositePlaceholders: compositePlaceholderTemplates // NEW: Include composite placeholders
                };
                backupData(allSettingsData, 'mdt_data.txt'); 
            });
            importAllSettingsFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.codPenal && importedData.vehicule && importedData.limiteViteza) {
                            codPenalEntries = preprocessCodPenalData(importedData.codPenal);
                            customVehicleModels = importedData.vehicule;
                            streetSpeedLimitsData = importedData.limiteViteza;
                            aiLogicTemplates = importedData.aiLogic || { ...defaultAiLogicTemplates };
                            aiSettings = importedData.aiSettings || { ...defaultAiSettings };
                            compositePlaceholderTemplates = importedData.compositePlaceholders || { ...defaultCompositePlaceholderTemplates }; // NEW: Load composite placeholders
                            
                            localStorage.setItem('codPenalData', JSON.stringify(codPenalEntries));
                            localStorage.setItem('customVehicleModels', JSON.stringify(customVehicleModels));
                            localStorage.setItem('streetSpeedLimitsData', JSON.stringify(streetSpeedLimitsData));
                            localStorage.setItem('aiLogicTemplates', JSON.stringify(aiLogicTemplates));
                            localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
                            localStorage.setItem('compositePlaceholderTemplates', JSON.stringify(compositePlaceholderTemplates)); // NEW: Save composite placeholders
                            
                            if (importedData.colors) localStorage.setItem('appColors', JSON.stringify(importedData.colors));
                            else localStorage.removeItem('appColors');
                            
                            if (importedData.ghidHTML) {
                                localStorage.setItem('ghidContentHTML', importedData.ghidHTML);
                            }
                            
                            // Re-render everything
                            applyCustomColors();
                            loadAndDisplayAiTemplates();
                            loadAiSettings();
                            loadGhidContent();
                            loadCompositePlaceholderTemplates(); // NEW: Load composite placeholders
                            populatePlaceholdersList();
                            populateInfractionSanctionsData();
                            populateInfractionDatalist();
                            renderCodPenalList();
                            renderCustomVehicleList();
                            renderSpeedLimitsList();
                            showToast('Fișierul a fost încărcat cu succes!', true);
                            document.getElementById('importAllSettingsLabel').classList.add('bg-cyan-600', 'hover:bg-cyan-700');
                        } else { showToast('Format de fișier invalid.', false); }
                    } catch (error) { showToast('Eroare la parsarea fișierului.', false); }
                    event.target.value = null; 
                };
                reader.readAsText(file);
            });

            licenteCheckbox.addEventListener('change', () => licenteContainer.classList.toggle('hidden-element', !licenteCheckbox.checked));
            crimaOrganizataCheckbox.addEventListener('change', () => crimaOrganizataContainer.classList.toggle('hidden-element', !crimaOrganizataCheckbox.checked));
            perchezitieCheckbox.addEventListener('change', () => {
                 perchezitieContainer.classList.toggle('hidden-element', !perchezitieCheckbox.checked);
                 perchezitieMasuraCheckbox.checked = perchezitieCheckbox.checked;
            });
            substantaCheckbox.addEventListener('change', () => substantaContainer.classList.toggle('hidden-element', !substantaCheckbox.checked));
            tipVehiculProcesatorSelect.addEventListener('change', filterVehicleModels);
            
            // --- Initialization ---
            const savedCodPenal = localStorage.getItem('codPenalData');
            if (savedCodPenal) try { codPenalEntries = preprocessCodPenalData(JSON.parse(savedCodPenal)); } catch (e) { console.error(e); }
            const savedVehicles = localStorage.getItem('customVehicleModels');
            if (savedVehicles) try { customVehicleModels = JSON.parse(savedVehicles); } catch (e) { console.error(e); }
            const savedSpeedLimits = localStorage.getItem('streetSpeedLimitsData');
            if (savedSpeedLimits) try { streetSpeedLimitsData = JSON.parse(savedSpeedLimits); } catch (e) { console.error(e); }
            
            applyCustomColors();
            loadAndDisplayAiTemplates();
            loadAiSettings();
            loadGhidContent();
            loadCompositePlaceholderTemplates(); // NEW: Load composite placeholders
            populatePlaceholdersList();
            populateInfractionSanctionsData(); 
            populateInfractionDatalist(); 
            renderCustomVehicleList(); 
            renderCodPenalList(); 
            renderSpeedLimitsList(); 
            updateDateTimeFields();
            updateSanctionsTables();
            displayPatrolInfo();

            // Numeric input validation
            const integerOnlyFields = [
                'cnp', 'cnp_reclamant', 'tigari_contrabanda', 'bani_murdari',
                'viteza_inregistrata', 'articol_puncte_permis',
                'articol_amenda_min', 'articol_amenda_max', 'articol_arest_min', 'articol_arest_max', 'puncte_permis',
                'arest_total_min', 'arest_total_max'
            ];

            integerOnlyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('keydown', preventInvalidNumberInput);
                }
            });

            validateAllFields(); // Initial call on page load
            document.querySelectorAll('#procesatorForm input, #procesatorForm select, #procesatorForm textarea').forEach(field => {
                 field.addEventListener('input', () => {
                     validateField(field);
                     updateAllPreviews();
                 });
            });

        }); 
    </script>
</body>
</html>
