<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDT Helper | Poliția Română</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Adaugat Font Awesome pentru pictograme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- NOUA PALETA DE CULORI & STILURI --- */
        :root {
            /* Culori inspirate de tematica "politie" */
            --color-background: #0A192F; /* Navy foarte inchis */
            --color-card-background: #112240; /* Navy inchis */
            --color-modal-background: #112240;
            --color-card-border: #3B82F6; /* Albastru accent */
            --color-text: #CCD6F6; /* Alb-gri deschis pentru text */
            --color-text-secondary: #8892b0; /* Gri-albastru pentru text secundar */
            --color-highlight: #64FFDA; /* Cyan pentru highlight (optional) */
            
            /* Mapping culori vechi pe noua tema */
            --color-turquoise-box: #3B82F6; /* Cetateni -> Albastru principal */
            --color-magenta-box: #3B82F6;   /* Actiune -> Albastru principal */
            --color-white-box: #233554;     /* Detalii -> Navy mai deschis */
            --color-orange-box: #F97316;    /* Jaf -> Portocaliu de alerta */
            --color-yellow-box: #233554;    /* Vehicule -> Navy mai deschis */
            --color-blue-box: #3B82F6;      /* Infractiuni -> Navy mai deschis */
            --color-red-box: #DC2626;       /* Sanctiuni -> Rosu de alerta */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            display: flex;
            align-items: flex-start; 
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-card-border);
            border-radius: 8px; 
            box-shadow: 0 10px 30px -15px rgba(2, 12, 27, 0.7);
            padding: 1.5rem 2rem; 
            width: 100%;
            max-width: 1400px; /* Latime marita pentru layout orizontal */
            margin-top: 2rem; 
            margin-bottom: 2rem; 
        }
        
        /* Layout orizontal pentru formularul principal */
        #procesatorForm {
            display: grid;
            grid-template-columns: 1fr; /* O singura coloana pe mobil */
            gap: 1.5rem;
        }

        @media (min-width: 1024px) { /* Doua coloane pe ecrane mai mari de 1024px */
            #procesatorForm {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .form-column {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .tab-container { 
            display: flex;
            border-bottom: 1px solid #30363D;
            margin-bottom: 1.5rem;
        }
        .tab-button.active {
            color: var(--color-highlight); 
            border-bottom-color: var(--color-highlight);
        }

        .input-field, .select-field, .textarea-field {
            background-color: var(--color-background);
            color: var(--color-text);
            border: 1px solid #30363D;
            border-radius: 6px;
            padding: 0.65rem 0.9rem; 
            width: 100%; 
            transition: all 0.3s ease;
            font-size: 0.9rem; 
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            border-color: var(--color-highlight);
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
            outline: none;
        }
        
        /* Stilizare inputuri cu pictograme */
        .input-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background-color: var(--color-background);
            border: 1px solid #30363D;
            border-radius: 6px;
            padding-left: 0.9rem;
            transition: all 0.3s ease;
        }
        .input-group:focus-within {
             border-color: var(--color-highlight);
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
        }
        .input-group i {
            color: var(--color-text-secondary);
        }
        .input-group .input-field {
            border: none;
            padding-left: 0;
            background-color: transparent;
        }
        .input-group .input-field:focus {
            box-shadow: none;
        }

        /* --- NOTIFICARI NOI --- */
        @keyframes slideIn {
            from {
                transform: translateX(110%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(110%);
                opacity: 0;
            }
        }
        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #238636; 
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: translateX(110%);
            opacity: 0;
            visibility: hidden;
            transition: visibility 0.5s, transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s;
        }
        .toast-message.show {
            visibility: visible;
            animation: slideIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .toast-message.hide {
             animation: slideOut 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .toast-message i {
            font-size: 1.5rem;
        }
        
        .title-main { color: var(--color-text); }
        .title-subtitle { color: var(--color-text-secondary); }
        .label-text { color: var(--color-text-secondary); }
        
        .sanctions-title { color: #F87171; /* red-400 */ }
        .btn-primary-small { background-color: #238636; border: 1px solid #2EA043; }
        .btn-primary-small:hover { background-color: #2EA043; }
        
        /* Alte stiluri din fisierul original... (restul stilurilor raman in mare parte neschimbate) */
        :root { --color-turquoise-box: #3B82F6; --color-magenta-box: #3B82F6; --color-white-box: #233554; --color-orange-box: #F97316; --color-yellow-box: #233554; --color-blue-box: #3B82F6; --color-red-box: #DC2626; --color-background: #0A192F; --color-text: #CCD6F6; --color-modal-background: #112240; --color-card-border: #3B82F6; --color-card-background: #112240; }
        .card { background-color: var(--color-card-background); border: 1px solid var(--color-card-border); border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); padding: 1.5rem 2rem; width: 100%; max-width: 1400px; margin-top: 2rem; margin-bottom: 2rem; }
        .tab-container { display: flex; border-bottom: 1px solid #30363D; margin-bottom: 1.5rem; }
        .sub-tab-container { display: flex; border-bottom: 1px solid #22272E; margin-bottom: 1rem; margin-top: 0.5rem; }
        .tab-button, .sub-tab-button { padding: 0.75rem 1.25rem; cursor: pointer; border: none; background-color: transparent; color: #8B949E; font-weight: 500; font-size: 0.95rem; border-bottom: 2px solid transparent; transition: color 0.2s ease, border-color 0.2s ease; }
        .sub-tab-button { font-size: 0.9rem; padding: 0.6rem 1rem; }
        .tab-button:hover, .sub-tab-button:hover { color: var(--color-text); }
        .tab-button.active, .sub-tab-button.active { color: #58A6FF; border-bottom-color: #58A6FF; }
        .tab-content, .sub-tab-content { display: none; }
        .tab-content.active, .sub-tab-content.active { display: block; }
        .textarea-field { min-height: 80px; resize: vertical; }
        .input-field-readonly, .input-field:disabled, .textarea-field:disabled { background-color: #21262D; color: #8B949E; cursor: not-allowed; }
        .select-field option { background-color: #161B22; color: #C9D1D9; }
        .input-field.incomplete, .select-field.incomplete, .textarea-field.incomplete { border-color: #EF4444 !important; }
        .input-field.completed, .select-field.completed, .textarea-field.completed { border-color: #22C55E !important; }
        .always-blue { border-color: #58A6FF !important; }
        .output-blue-border { border-color: #58A6FF !important; }
        .label-text small { font-weight: 400; color: #6a737d; }
        .section-delimiter { margin-top: 1.5rem; margin-bottom: 1.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid #30363D; height: 1px; }
        .title-main-container { margin-bottom: 1.5rem; }
        .title-main { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .settings-section-title { color: var(--color-text); font-weight: 600; font-size: 1.1rem; margin-top: 1rem; margin-bottom: 1rem; }
        .control-group { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .control-label { display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; color: var(--color-text); }
        .control-input { appearance: none; border: 2px solid #30363D; margin-right: 0.5rem; transition: border-color 0.2s ease, background-color 0.2s ease; position: relative; }
        .control-input:checked { border-color: #22C55E; background-color: #22C55E; }
        .radio-input { width: 18px; height: 18px; border-radius: 50%; }
        .radio-input:checked::before { content: ''; display: block; width: 10px; height: 10px; background-color: #0D1117; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .checkbox-input { width: 18px; height: 18px; border-radius: 4px; }
        .checkbox-input:checked::before { content: '✓'; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #0D1117; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 1; }
        .form-grid { gap: 1.25rem; }
        .grid-row-flexible { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .grid-row-2-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .grid-row-3-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .grid-row-4-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .hidden-element { display: none !important; }
        .button-group { display: flex; flex-direction: column; gap: 0.75rem; }
        .button-group-row { display: flex; gap: 0.75rem; }
        .btn-secondary { background-color: #30363D; color: #C9D1D9; border: 1px solid #4B5563; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; transition: background-color 0.2s ease; }
        .btn-secondary:hover { background-color: #4B5563; border-color: #6B7280; }
        .btn-danger { background-color: #B91C1C; color: white; border: 1px solid #991B1B; }
        .btn-danger:hover { background-color: #991B1B; border-color: #7F1D1D; }
        .btn-edit-mode { background-color: #D97706; border-color: #B45309; }
        .btn-edit-mode:hover { background-color: #B45309; }
        .cod-penal-list-item, .vehicle-list-item, .speed-limit-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.8rem; background-color: #0D1117; border: 1px solid #30363D; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.85rem; }
        .cod-penal-list-item .actions, .vehicle-list-item .actions, .speed-limit-list-item .actions { display: flex; align-items: center; }
        .cod-penal-list-item .actions button, .vehicle-list-item .actions button, .speed-limit-list-item .actions button { margin-left: 0.5rem; font-size: 0.75rem; padding: 0.2rem 0.5rem; }
        .settings-actions { display: flex; gap: 0.75rem; align-items: center; margin-top: 0.5rem; }
        .incompatibilitati-container { max-height: 150px; overflow-y: auto; padding: 0.5rem; border: 1px solid #30363D; border-radius: 6px; background-color: #0D1117; }
        .settings-list-scrollable { max-height: 9rem; overflow-y: auto; border: 1px solid #30363D; border-radius: 6px; padding: 0.5rem; background-color: #0D1117; }
        @keyframes blinkWarning { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .blinking-warning { animation: blinkWarning 1s infinite; }
        .verification-details { border: 2px solid #58A6FF; padding: 1rem; border-radius: 6px; margin-top: 0.75rem; font-size: 0.85rem; }
        .verification-details p { margin-bottom: 0.3rem; }
        .verification-details strong { color: #8B949E; }
        .loading-indicator { font-style: italic; color: #8B949E; }
        .global-settings-actions { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #30363D; }
        .infraction-feedback { font-size: 0.75rem; margin-top: 0.25rem; padding-left: 0.5rem; }
        .infraction-feedback p { margin-bottom: 0.125rem; }
        .infraction-feedback .sanction-word { font-weight: 600; margin-right: 0.5rem; }
        .sanctions-container { border: 2px solid var(--color-red-box, #DC2626); border-radius: 8px; padding: 1rem; }
        .magenta-box { border: 2px solid var(--color-magenta-box, #D946EF); border-radius: 8px; padding: 1rem; display: grid; gap: 1.25rem; }
        .turquoise-box { border: 2px solid var(--color-turquoise-box, #2DD4BF); border-radius: 8px; padding: 1rem; display: grid; gap: 1.25rem; }
        .green-box { border: 2px solid #22C55E; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .blue-box { border: 2px solid var(--color-blue-box, #3B82F6); border-radius: 8px; padding: 1rem; }
        .yellow-box { border: 2px solid var(--color-yellow-box, #FBBF24); border-radius: 8px; padding: 1rem; }
        .orange-box { border: 2px solid var(--color-orange-box, #F97316); border-radius: 8px; padding: 1rem; display: grid; gap: 1.25rem; }
        .white-box { border: 2px solid var(--color-white-box, #E5E7EB); border-radius: 8px; padding: 1rem; display: grid; gap: 1.25rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background-color: var(--color-modal-background); padding: 2rem; border-radius: 8px; border: 1px solid #30363D; width: 90%; max-width: 600px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); position: relative; }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; color: #8B949E; font-size: 1.5rem; cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: #C9D1D9; }
        .modal-content .textarea-field { min-height: 100px; }
        .app-footer-text { font-size: 0.7rem; color: #6B7280; text-align: right; margin-top: 1.5rem; }
        .tutorial-content h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #58A6FF; }
        .tutorial-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; color: var(--color-text); }
        .tutorial-content p { margin-bottom: 1rem; line-height: 1.6; }
        .tutorial-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .tutorial-content code { background-color: #21262d; padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem;}
        .tutorial-content blockquote { border-left: 4px solid #30363D; padding-left: 1rem; margin-left: 0; font-style: italic; color: #8B949E; }
        .preview-box { background-color: #21262D; color: #8B949E; border: 1px solid #30363D; border-radius: 6px; padding: 0.65rem 0.9rem; width: 100%; min-height: 80px; font-size: 0.8rem; line-height: 1.5; white-space: pre-wrap; }
        
        /* Stilizare pentru editorul de text al ghidului */
        #ghidEditorToolbar {
            background-color: #0D1117;
            padding: 0.5rem;
            border-radius: 6px 6px 0 0;
            border: 1px solid #30363D;
            border-bottom: none;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            position: sticky; /* MODIFICARE: Face toolbar-ul lipicios */
            top: 0;
            z-index: 10;
        }
        .toolbar-button {
            background: none;
            border: 1px solid transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        .toolbar-button:hover {
            background-color: #30363D;
            color: var(--color-text);
        }
        #ghidEditor {
            min-height: 400px;
            background-color: var(--color-background);
            color: var(--color-text);
            border: 1px solid #30363D;
            border-radius: 0 0 6px 6px;
            padding: 1rem;
            outline: none;
            line-height: 1.6;
        }
        #ghidEditor:focus {
            border-color: var(--color-highlight);
        }

        /* ADAUGARE: Fix pentru modalul de ghid care depășește ecranul */
        #ghidModal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 90vh; /* Limitează înălțimea la 90% din înălțimea vizibilă a ecranului */
        }

        /* ADAUGARE: Face containerul editorului derulabil */
        #ghidModal .modal-content > div:has(#ghidEditor) {
            overflow-y: auto; /* Adaugă scrollbar vertical doar când este necesar */
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="title-main-container flex items-center justify-start gap-4 mb-6">
            <img src="https://i.imgur.com/PL6J46Q.png" alt="Logo Politia" class="h-48 w-auto">
            <div>
                <h1 class="title-main text-left">Mobile Data Terminal Helper</h1>
                <p class="title-subtitle text-left">Amenzi și Dosare Penale - rapid și ușor</p>
            </div>
        </div>
        <div class="tab-container">
            <button class="tab-button active" data-tab="procesator">Procesator</button>
            <button class="tab-button" data-tab="db_setari">Baze de Date</button>
            <button class="tab-button" data-tab="app_setari">Setări</button>
        </div>

        <div id="procesator" class="tab-content active">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-2">
                    <label for="importAllSettingsFile" id="importAllSettingsLabel" class="btn-secondary cursor-pointer bg-fuchsia-600 hover:bg-fuchsia-700 flex items-center gap-2">
                        <i class="fa-solid fa-upload"></i> Încarcă datele
                    </label>
                    <input type="file" id="importAllSettingsFile" class="hidden-element" accept=".txt">
                    <p class="text-xs text-gray-500">încarcă fișierul „mdt_data_XXXX.txt” descărcat din rubrica „helper-mdt” de pe serverul de discord al poliției</p>
                </div>
                
                <div class="flex items-center gap-4">
                    <button type="button" id="seteazaPatrulaBtn" class="btn-secondary flex items-center gap-2"><i class="fa-solid fa-user-shield"></i> Setează Patrulă</button>
                    <div id="patrolDisplay" class="text-xs text-gray-500 mt-1">
                        - se va completa la fiecare început de sesiune <br>
                        - o sesiune se încheie când închizi browserul
                    </div>
                </div>
            </div>

            <!-- Inceput Formular Procesator -->
            <form id="procesatorForm"> 
                <!-- Coloana Stanga -->
                <div class="form-column">
                    <div class="mb-4">
                        <label for="verificare_articol" class="label-text flex items-center gap-2"><i class="fa-solid fa-book-open"></i>Verificare Articol Cod Penal:</label>
                        <div class="input-group">
                             <i class="fa-solid fa-magnifying-glass"></i>
                            <input list="lista_articole_verificare" id="verificare_articol" class="input-field always-blue flex-grow" placeholder="Selectează sau scrie articolul...">
                        </div>
                        <datalist id="lista_articole_verificare"></datalist>
                        <div id="verificare_articol_details" class="verification-details mt-2 hidden-element"></div>
                    </div>
                    
                    <div class="turquoise-box">
                        <h3 class="text-lg font-semibold mb-2 flex items-center gap-2"><i class="fa-solid fa-users"></i> Date Părți Implicate</h3>
                        <div>
                            <label for="nume" class="label-text">Nume și Prenume Inculpat:</label>
                            <div class="input-group">
                                <i class="fa-solid fa-user"></i>
                                <input type="text" id="nume" class="input-field" placeholder="scrie numele inculpatului">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                            <div>
                                <label for="cnp" class="label-text">CNP Inculpat:</label>
                                <div class="input-group">
                                    <i class="fa-solid fa-id-card"></i>
                                    <input type="number" id="cnp" class="input-field max-w-[180px]" placeholder="" min="0">
                                </div>
                            </div>
                            <div>
                                <label class="label-text">Sexul Inculpatului:</label>
                                <div class="control-group mt-1">
                                    <label class="control-label"><input type="radio" name="sex" value="masculin" class="control-input radio-input" checked> Masculin</label>
                                    <label class="control-label"><input type="radio" name="sex" value="feminin" class="control-input radio-input"> Feminin</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="nume_reclamant" class="label-text">Nume și Prenume Reclamant/Victimă:</label>
                            <div class="input-group">
                                <i class="fa-solid fa-user-injured"></i>
                                <input type="text" id="nume_reclamant" class="input-field no-validation" placeholder="scrie numele reclamantului/victimei">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                             <div>
                                <label for="cnp_reclamant" class="label-text">CNP Reclamant/Victimă:</label>
                                 <div class="input-group">
                                    <i class="fa-solid fa-id-card"></i>
                                    <input type="number" id="cnp_reclamant" class="input-field no-validation" placeholder="" min="0">
                                </div>
                            </div>
                            <div>
                                <label class="label-text">Sexul Reclamantului/Victimei:</label>
                                <div class="control-group mt-1">
                                    <label class="control-label"><input type="radio" name="sex_reclamant" value="masculin_reclamant" class="control-input radio-input" checked> Masculin</label>
                                    <label class="control-label"><input type="radio" name="sex_reclamant" value="feminin_reclamant" class="control-input radio-input"> Feminin</label>
                                </div>
                            </div>
                        </div>
                        <!-- NOU: Secțiune Martori -->
                        <div class="section-delimiter my-4 border-blue-400/50"></div>
                        <div>
                            <h4 class="text-base font-semibold mb-2 flex items-center gap-2"><i class="fa-solid fa-user-friends"></i> Martori</h4>
                            <div id="martoriContainer" class="space-y-4">
                                <!-- Câmpurile pentru martori vor fi injectate aici de JavaScript -->
                            </div>
                            <button type="button" id="adaugaMartorBtn" class="btn-secondary mt-3 text-xs py-1.5 px-3 flex items-center gap-2">
                                <i class="fa-solid fa-plus-circle"></i> Adaugă Martor
                            </button>
                        </div>
                    </div>

                    <div class="grid-row-3-items items-end">
                        <div>
                            <label for="data_procesare" class="label-text">Data procesare:</label>
                            <div class="input-group"><i class="fa-solid fa-calendar-days"></i><input type="text" id="data_procesare" class="input-field"></div>
                        </div>
                        <div>
                            <label for="ora_procesare" class="label-text">Ora procesare:</label>
                            <div class="input-group"><i class="fa-solid fa-clock"></i><input type="text" id="ora_procesare" class="input-field"></div>
                        </div>
                        <div class="self-end">
                            <button type="button" id="actualizeazaDateTimeBtn" class="btn-secondary w-full">Actualizează</button>
                        </div>
                    </div>
                    
                    <div class="magenta-box">
                        <label class="label-text font-semibold text-lg flex items-center gap-2"><i class="fa-solid fa-bullhorn"></i>Acțiune:</label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                            <label class="control-label"><input type="radio" name="actiune" value="standard" class="control-input radio-input" checked> Standard</label>
                            <label class="control-label"><input type="radio" name="actiune" value="apel_112" class="control-input radio-input"> Apel 112</label>
                            <label class="control-label"><input type="radio" name="actiune" value="autoconstatare" class="control-input radio-input"> Autoconstatare</label>
                            <label class="control-label"><input type="radio" name="actiune" value="detectie_focuri_arma" class="control-input radio-input"> Sistem S.R.I.</label>
                            <label class="control-label"><input type="radio" name="actiune" value="alarma_jaf" class="control-input radio-input"> Alarmă Jaf</label>
                            <label class="control-label"><input type="radio" name="actiune" value="razie_mineriada" class="control-input radio-input"> Mineriadă</label>
                            <label class="control-label"><input type="radio" name="actiune" value="razie_rutiera" class="control-input radio-input"> Rutieră</label>
                            <label class="control-label"><input type="radio" name="actiune" value="razie_main" class="control-input radio-input"> Razie</label>
                        </div>
                    </div>
                    
                    <div id="jaf_box" class="orange-box hidden-element">
                        <div>
                             <label for="obiectiv_jaf" class="label-text">Selectează alarmele:</label>
                             <select id="obiectiv_jaf" class="select-field"><option value="">Selectează...</option><option value="unui magazin">unui magazin</option><option value="benzinăriei">benzinăriei</option><option value="Băncii FLEECA">Băncii FLEECA</option></select>
                        </div>
                         <div>
                            <input type="text" id="locatie_jaf" list="lista_locatii_jaf" class="input-field" placeholder="selectează strada">
                            <datalist id="lista_locatii_jaf"></datalist>
                        </div>
                    </div>
                    
                </div> <!-- Sfarsit Coloana Stanga -->

                <!-- Coloana Dreapta -->
                <div class="form-column">
                    <!-- MODIFICARE: Zona mutata aici -->
                    <div>
                        <label for="zona_input" class="label-text">Zona:</label>
                        <div class="input-group">
                            <i class="fa-solid fa-map-location-dot"></i>
                            <input list="lista_zone" id="zona_input" name="zona_input" class="input-field" placeholder="Selectează sau scrie strada...">
                        </div>
                        <datalist id="lista_zone"></datalist>
                    </div>

                    <div class="yellow-box">
                         <h3 class="text-lg font-semibold mb-2 flex items-center gap-2"><i class="fa-solid fa-car"></i> Detalii Vehicul</h3>
                        <div class="grid-row-2-items">
                            <div>
                                <label for="tip_vehicul_procesator" class="label-text">Tip Vehicul:</label>
                                <select id="tip_vehicul_procesator" class="select-field"><option value="">Selectează tipul...</option></select>
                            </div>
                            <div>
                                <label for="model_vehicul_input" class="label-text">Model Vehicul:</label>
                                <div class="flex items-center gap-2">
                                    <input list="lista_modele_vehicule" id="model_vehicul_input" name="model_vehicul_input" class="input-field flex-grow" placeholder="Selectează sau scrie modelul...">
                                    <button type="button" id="adaugaVehiculDinProcesatorBtn" class="btn-secondary whitespace-nowrap !py-2.5">Adaugă Vehicul</button>
                                </div>
                                <datalist id="lista_modele_vehicule"></datalist>
                            </div>
                        </div>
                        <div class="grid-row-2-items">
                            <div>
                                <label for="culoare_vehicul" class="label-text">Culoare Vehicul:</label>
                                <input type="text" id="culoare_vehicul" class="input-field" placeholder="scrie culoarea">
                            </div>
                            <div>
                                <label for="nr_inmatriculare" class="label-text">Număr Înmatriculare:</label>
                                <input type="text" id="nr_inmatriculare" class="input-field no-validation" placeholder="scrie sau lasă gol dacă 10-16">
                            </div>
                        </div>
                        <!-- MODIFICARE: Aliniere campuri viteza si autospeciala -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="viteza_inregistrata" class="label-text">Viteza înregistrată (km/h):</label>
                                <input type="number" id="viteza_inregistrata" class="input-field" placeholder="Ex: 70" min="0">
                            </div>
                            <div>
                                <label for="limita_viteza_zona" class="label-text">Limita de viteză:</label>
                                <input type="text" id="limita_viteza_zona" class="input-field input-field-readonly" placeholder="Selectați zona" readonly>
                            </div>
                            <div>
                               <label for="autospeciala_select" class="label-text">Tip autospecială:</label>
                               <select id="autospeciala_select" name="autospeciala_select" class="select-field no-validation"><option value="" selected>Fără autospecială implicată</option><option value="Autospeciala de Poliție">Autospeciala de Poliție</option><option value="Blindata S.A.S.">Blindata S.A.S.</option><option value="Autospeciala S.M.U.R.D.">Autospeciala S.M.U.R.D.</option></select>
                           </div>
                        </div>
                    </div>
                    
                    <div class="white-box">
                         <h3 class="text-lg font-semibold mb-2 flex items-center gap-2"><i class="fa-solid fa-clipboard-check"></i> Constatări Suplimentare</h3>
                         <div class="flex flex-wrap gap-x-6 gap-y-2">
                             <label class="control-label"><input type="checkbox" id="substanta_checkbox" class="control-input checkbox-input"> <i class="fa-solid fa-wine-bottle mx-1"></i> Substanță sub influență</label>
                             <label class="control-label"><input type="checkbox" id="perchezitie_checkbox" class="control-input checkbox-input"> <i class="fa-solid fa-person-military-searching mx-1"></i> Percheziție</label>
                             <label class="control-label"><input type="checkbox" id="crima_organizata_checkbox" class="control-input checkbox-input"> <i class="fa-solid fa-people-group mx-1"></i> Criminalitate Organizată</label>
                             <label class="control-label"><input type="checkbox" id="licente_checkbox" class="control-input checkbox-input"> <i class="fa-solid fa-id-badge mx-1"></i> Licențe</label>
                         </div>
                         <div id="substanta_container" class="grid-row-2-items hidden-element"><div><label class="label-text">&nbsp;</label><input type="text" id="substanta_influenta" class="input-field max-w-xs" placeholder="Ex: Alcool"></div><div><label for="concentratia" class="label-text">Concentrația:</label><input type="text" id="concentratia" class="input-field max-w-xs" placeholder="Ex: 0.8 mg/L"></div></div>
                         <div id="perchezitie_container" class="grid-row-3-items hidden-element"><div><label for="perchezitie_buzunare" class="label-text text-xs">Buzunare/Arme&Muniție:</label><input type="text" id="perchezitie_buzunare" class="input-field" placeholder="Descriere obiecte găsite"></div><div><label for="perchezitie_torpedo" class="label-text text-xs">Torpedo:</label><input type="text" id="perchezitie_torpedo" class="input-field" placeholder="Descriere obiecte găsite"></div><div><label for="perchezitie_portbagaj" class="label-text text-xs">Portbagaj:</label><input type="text" id="perchezitie_portbagaj" class="input-field" placeholder="Descriere obiecte găsite"></div></div>
                         <div id="crima_organizata_container" class="hidden-element space-y-4"><div class="grid-row-2-items"><div><label for="tigari_contrabanda" class="label-text">Țigări de contrabandă:</label><input type="number" id="tigari_contrabanda" class="input-field max-w-xs" placeholder="introdu cantitatea" min="0"></div><div><label for="bani_murdari" class="label-text">Bani nemarcați/murdari:</label><input type="number" id="bani_murdari" class="input-field max-w-xs" placeholder="introdu cantitatea" min="0"></div></div><div class="grid-row-2-items"><div><label for="droguri_risc" class="label-text">Droguri de Risc:</label><input type="text" id="droguri_risc" class="input-field max-w-xs" placeholder="Completează cantitatea și drogul"></div><div><label for="droguri_mare_risc" class="label-text">Droguri de Mare Risc:</label><input type="text" id="droguri_mare_risc" class="input-field max-w-xs" placeholder="Completează cantitatea și drogul"></div></div></div>
                         <!-- MODIFICARE: Doua campuri pentru lipsa licenta -->
                         <div id="licente_container" class="hidden-element space-y-4 mt-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="lipsa_licenta_1" class="label-text">Lipsă document 1:</label>
                                    <select id="lipsa_licenta_1" name="lipsa_licenta_1" class="select-field">
                                        <option value="">Niciunul</option><option value="buletin">buletin</option><option value="permis de conducere">permis de conducere</option><option value="licență de miner">licență de miner</option><option value="licență de pescar">licență de pescar</option><option value="licență de transport comercial">licență de transport comercial</option><option value="licență de tractat">licență de tractat</option><option value="licență de pilot">licență de pilot</option><option value="licență de navigație">licență de navigație</option><option value="permis de port-arme">permis de port-arme</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="lipsa_licenta_2" class="label-text">Lipsă document 2:</label>
                                    <select id="lipsa_licenta_2" name="lipsa_licenta_2" class="select-field">
                                        <option value="">Niciunul</option><option value="buletin">buletin</option><option value="permis de conducere">permis de conducere</option><option value="licență de miner">licență de miner</option><option value="licență de pescar">licență de pescar</option><option value="licență de transport comercial">licență de transport comercial</option><option value="licență de tractat">licență de tractat</option><option value="licență de pilot">licență de pilot</option><option value="licență de navigație">licență de navigație</option><option value="permis de port-arme">permis de port-arme</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="braconaj_materiale" class="label-text">Braconaj / Materiale confiscate:</label>
                                <textarea id="braconaj_materiale" class="textarea-field" placeholder="pești sau materiale deținute fără licența aferentă"></textarea>
                            </div>
                         </div>
                    </div>

                    <div class="blue-box">
                        <h3 class="text-lg font-semibold mb-2 flex items-center gap-2"><i class="fa-solid fa-file-signature"></i> Încadrare Fapte</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                            <div class="space-y-2"><label for="infractiune1" class="label-text">Infracțiune 1:</label><input type="text" id="infractiune1" class="input-field infractiune-input" placeholder="Caută..." list="lista_infractiuni_datalist"><div id="feedbackInfractiune1" class="infraction-feedback hidden-element"></div><label for="preview_template1" class="label-text mt-2">Previzualizare Șablon:</label><div id="preview_template1" class="preview-box"></div><label for="mentiuni1" class="label-text">Mențiuni 1:</label><textarea id="mentiuni1" class="textarea-field no-validation" rows="2" placeholder="Adaugă mai multe detalii..."></textarea></div>
                            <div class="space-y-2"><label for="infractiune2" class="label-text">Infracțiune 2:</label><input type="text" id="infractiune2" class="input-field infractiune-input no-validation" placeholder="Caută..." list="lista_infractiuni_datalist"><div id="feedbackInfractiune2" class="infraction-feedback hidden-element"></div><label for="preview_template2" class="label-text mt-2">Previzualizare Șablon:</label><div id="preview_template2" class="preview-box"></div><label for="mentiuni2" class="label-text">Mențiuni 2:</label><textarea id="mentiuni2" class="textarea-field no-validation" rows="2" placeholder="Adaugă mai multe detalii..."></textarea></div>
                            <div class="space-y-2"><label for="infractiune3" class="label-text">Infracțiune 3:</label><input type="text" id="infractiune3" class="input-field infractiune-input no-validation" placeholder="Caută..." list="lista_infractiuni_datalist"><div id="feedbackInfractiune3" class="infraction-feedback hidden-element"></div><label for="preview_template3" class="label-text mt-2">Previzualizare Șablon:</label><div id="preview_template3" class="preview-box"></div><label for="mentiuni3" class="label-text">Mențiuni 3:</label><textarea id="mentiuni3" class="textarea-field no-validation" rows="2" placeholder="Adaugă mai multe detalii..."></textarea></div>
                        </div>
                        <datalist id="lista_infractiuni_datalist"></datalist>
                        <div id="globalInfractionError" class="text-red-600 font-bold mt-2 hidden-element text-center"></div>
                    </div>
                </div> <!-- Sfarsit Coloana Dreapta -->

                <!-- Sanctiuni - se intind pe ambele coloane -->
                <div class="col-span-1 lg:col-span-2">
                    <div class="sanctions-container">
                        <h2 class="sanctions-title flex items-center justify-center gap-2"><i class="fa-solid fa-gavel"></i> Sancțiuni aplicate</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 items-start">
                            <div><label for="amenda_totala" class="label-text">Amendă contravențională (total):</label><div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">$</span><input type="number" id="amenda_totala" class="input-field pl-7" style="width: 250px;" placeholder="Calculat automat"></div></div>
                            <div class="grid grid-cols-2 gap-4"><div><label for="arest_total_min" class="label-text">Arest total minim (luni):</label><input type="number" id="arest_total_min" class="input-field" placeholder="Calculat" min="0"></div><div><label for="arest_total_max" class="label-text">Arest total maxim (luni):</label><input type="number" id="arest_total_max" class="input-field" placeholder="Calculat" min="0"></div></div>
                        </div>
                        <div class="grid-row-flexible mt-4"><div class="flex-shrink-0 flex-grow"><label for="puncte_permis" class="label-text">Puncte Permis:</label><input type="number" id="puncte_permis" class="input-field" style="min-width: 80px;" placeholder="Calculat automat" min="0"></div><label class="control-label"><input type="checkbox" id="anulare_permis" class="control-input checkbox-input"> Anulare permis</label><label class="control-label"><input type="checkbox" id="ridicare_vehicul" class="control-input checkbox-input"> Ridicare autovehicul</label><label class="control-label"><input type="checkbox" id="perchezitie_masura" class="control-input checkbox-input"> Percheziție</label></div>
                        <div id="locatie_detentie_container" class="mt-4"><label for="locatie_detentie" class="label-text">Locație detenție:</label><select id="locatie_detentie" class="select-field"><option value="Penitenciarul Sandy" selected>Penitenciarul Sandy</option><option value="celulele din Secția Sandy">celulele din Secția Sandy</option><option value="celulele din Secția Centrală">celulele din Secția Centrală</option><option value="celulele din secția Secundară">celulele din secția Secundară</option></select></div>
                    </div>
                </div>

                <!-- Butoane actiune - se intind pe ambele coloane -->
                <div class="col-span-1 lg:col-span-2">
                    <div class="section-delimiter"></div>
                    <div class="green-box">
                        <button type="button" id="generateCaseDescriptionBtn" class="w-full bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-semibold py-2.5 px-4 rounded-md transition duration-150 ease-in-out">
                            Generează
                        </button>
                        <div id="caseDescriptionLoading" class="loading-indicator hidden-element mt-2 text-center">Se generează descrierea...</div>
                        <textarea id="generatedTitlesOutput" class="textarea-field mt-2 hidden-element output-blue-border" rows="3" readonly></textarea>
                        <textarea id="caseDescriptionOutput" class="textarea-field mt-2 hidden-element output-blue-border" rows="15" readonly></textarea>
                    </div>

                    <div class="mt-8 button-group"> 
                        <div class="button-group-row w-full">
                            <button type="button" id="copyTitlesBtn" class="flex-grow bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2.5 px-4 rounded-md transition duration-150 ease-in-out">Copiază titlu</button>
                            <button type="button" id="copyDescriptionBtn" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-md transition duration-150 ease-in-out">Copiază descriere</button>
                        </div>
                        <button type="button" id="resetFormBtn" class="w-full btn-danger text-white font-semibold py-2.5 px-4 rounded-md transition duration-150 ease-in-out mt-2">Resetează Formular</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Restul tab-urilor (Baza de Date, Setari) raman neschimbate ca structura -->
        <div id="db_setari" class="tab-content">
            <!-- Continutul pentru Baza de Date aici -->
             <div class="global-settings-actions">
                <button type="button" id="exportAllSettingsBtn" class="btn-secondary">Salvează datele</button>
            </div>
            <div class="sub-tab-container">
                <button class="sub-tab-button active" data-subtab="cod_penal_settings">Cod Penal</button>
                <button class="sub-tab-button" data-subtab="vehicule_settings">Vehicule</button>
                <button class="sub-tab-button" data-subtab="limite_viteza_settings">Limite de viteză</button>
            </div>

            <div id="cod_penal_settings" class="sub-tab-content active">
                 <h3 class="settings-section-title">Adaugă/Modifică Articol Cod Penal</h3>
                <form id="codPenalForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-[auto_auto_1fr] gap-4 items-start">
                        <div>
                            <label for="articol_cap" class="label-text">Capitol:</label>
                            <input type="text" id="articol_cap" class="input-field max-w-[120px]" placeholder="Ex: Cap. 3">
                        </div>
                        <div>
                            <label for="articol_numar_input" class="label-text">Număr Articol:</label>
                            <input type="text" id="articol_numar_input" class="input-field max-w-[150px]" placeholder="Ex: 1.2">
                        </div>
                        <div>
                            <label for="articol_titlu" class="label-text">Titlul Infracțiunii:</label>
                            <input type="text" id="articol_titlu" class="input-field" placeholder="introdu titlul Legii">
                        </div>
                    </div>
                    <div>
                        <label for="articol_definitie" class="label-text">Definiție / Descriere:</label>
                        <textarea id="articol_definitie" class="textarea-field" placeholder="Definește legea"></textarea>
                    </div>
                    <div class="grid-row-2-items">
                        <div>
                            <label for="articol_amenda_min" class="label-text">Amendă Minimă ($):</label>
                            <input type="number" id="articol_amenda_min" class="input-field max-w-[100px]" placeholder="min" min="0">
                        </div>
                        <div>
                            <label for="articol_amenda_max" class="label-text">Amendă Maximă ($):</label>
                            <input type="number" id="articol_amenda_max" class="input-field max-w-[100px]" placeholder="max" min="0">
                        </div>
                    </div>
                     <div class="grid-row-2-items items-end">
                        <div>
                            <label for="articol_arest_min" class="label-text">Arest Minim (luni):</label>
                            <input type="number" id="articol_arest_min" class="input-field max-w-[100px]" placeholder="min" min="0">
                        </div>
                        <div class="flex items-center">
                            <div class="flex-grow">
                                <label for="articol_arest_max" class="label-text">Arest Maxim (luni):</label>
                                <input type="number" id="articol_arest_max" class="input-field max-w-[100px]" placeholder="max" min="0">
                            </div>
                            <label class="control-label ml-4"> 
                                <input type="checkbox" id="articol_arest_pe_viata" class="control-input checkbox-input">
                                Pe viață
                            </label>
                        </div>
                    </div>
                    <div class="flex items-end gap-4">
                        <button type="button" id="editeazaDescrieriBtn" class="btn-secondary self-end">Editează descrieri</button>
                        <div class="flex-shrink-0">
                            <label for="articol_puncte_permis" class="label-text">Puncte Permis:</label>
                            <input type="number" id="articol_puncte_permis" class="input-field max-w-[80px]" placeholder="0" min="0">
                        </div>
                        <div class="flex-grow">
                            <label class="label-text">Sancțiuni:</label>
                            <div class="control-group">
                                <label class="control-label">
                                    <input type="checkbox" id="articol_anulare_permis" class="control-input checkbox-input">
                                    Anulare Permis
                                </label>
                                <label class="control-label">
                                    <input type="checkbox" id="articol_ridicare_vehicul" class="control-input checkbox-input">
                                    Ridicare Autovehicul
                                </label>
                                <label class="control-label">
                                    <input type="checkbox" id="articol_perchezitie" class="control-input checkbox-input">
                                    Percheziție Necesara
                                </label>
                            </div>
                        </div>
                    </div>
                    <textarea id="articol_model_descriere_1" class="hidden-element"></textarea>
                    <textarea id="articol_model_descriere_2" class="hidden-element"></textarea>
                    <textarea id="articol_model_descriere_3" class="hidden-element"></textarea>

                     <div class="mt-2">
                        <label id="incompatibilitatiLabel" class="label-text">Incompatibilități (nu se cumulează cu): <span id="incompatibilitatiCount">(0 infracțiuni selectate)</span></label>
                        <div id="incompatibilitatiListContainer" class="incompatibilitati-container">
                            <p class="text-xs text-gray-500">Niciun alt articol cu care să se compare (adăugați mai întâi alte articole).</p>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button type="submit" id="salveazaArticolBtn" class="btn-primary-small">Salvează Articol</button>
                        <button type="button" id="backupCodPenalBtn" class="btn-secondary hidden-element">Backup Date</button>
                        <label for="restoreCodPenalFile" class="btn-secondary cursor-pointer hidden-element">Restore Date</label>
                        <input type="file" id="restoreCodPenalFile" class="hidden-element" accept=".txt">
                    </div>
                </form>
                <div class="section-delimiter mt-6"></div>
                <h3 class="settings-section-title">Listă Articole Cod Penal</h3>
                <div id="listaArticoleCodPenal" class="space-y-2 settings-list-scrollable">
                </div>
            </div>
            <div id="vehicule_settings" class="sub-tab-content">
                <h3 class="settings-section-title">Gestionare Vehicule</h3>
                <form id="vehicleSettingsForm" class="space-y-4">
                    <div class="grid-row-2-items items-end">
                        <div>
                            <label for="vehicle_type_settings" class="label-text">Tip Vehicul:</label>
                            <select id="vehicle_type_settings" class="select-field">
                            </select>
                        </div>
                        <div>
                            <label for="vehicle_model_settings_input" class="label-text">Nume Model:</label>
                            <input type="text" id="vehicle_model_settings_input" class="input-field" placeholder="Ex: Dacia Logan">
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button type="button" id="addCustomVehicleBtn" class="btn-primary-small">Adaugă Vehicul</button>
                        <button type="button" id="backupVehiculeBtn" class="btn-secondary hidden-element">Backup Date</button>
                        <label for="restoreVehiculeFile" class="btn-secondary cursor-pointer hidden-element">Restore Date</label>
                        <input type="file" id="restoreVehiculeFile" class="hidden-element" accept=".txt">
                    </div>
                </form>
                <div class="section-delimiter mt-6"></div>
                <h3 class="settings-section-title">Listă Vehicule</h3>
                <ul id="customVehicleList" class="space-y-2 settings-list-scrollable">
                </ul>
            </div>
            <div id="limite_viteza_settings" class="sub-tab-content">
                 <h3 class="settings-section-title">Gestionare Limite de Viteză</h3>
                <form id="speedLimitSettingsForm" class="space-y-4">
                    <div class="grid-row-2-items items-end">
                        <div>
                            <label for="street_name_settings_input" class="label-text">Nume Stradă/Zonă:</label>
                            <input type="text" id="street_name_settings_input" class="input-field" placeholder="Ex: Strada Unirii">
                        </div>
                        <div>
                            <label for="speed_limit_settings_input" class="label-text">Limită Viteză (text):</label>
                            <input type="text" id="speed_limit_settings_input" class="input-field" placeholder="Ex: 50 km/h">
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button type="button" id="addSpeedLimitBtn" class="btn-primary-small">Adaugă Limită</button>
                        <button type="button" id="backupLimiteVitezaBtn" class="btn-secondary hidden-element">Backup Date</button>
                        <label for="restoreLimiteVitezaFile" class="btn-secondary cursor-pointer hidden-element">Restore Date</label>
                        <input type="file" id="restoreLimiteVitezaFile" class="hidden-element" accept=".txt">
                    </div>
                </form>
                <div class="section-delimiter mt-6"></div>
                <h3 class="settings-section-title">Listă Limite de Viteză</h3>
                <ul id="speedLimitListUL" class="space-y-2 settings-list-scrollable">
                </ul>
            </div>
        </div>
        <div id="app_setari" class="tab-content">
            <!-- Continutul pentru Setari App aici -->
             <div class="sub-tab-container">
                <button class="sub-tab-button active" data-subtab="placeholders_subtab">Placeholders</button>
                <button class="sub-tab-button" data-subtab="aspect_subtab">Aspect</button>
                <button class="sub-tab-button" data-subtab="sabloane_subtab">Șabloane</button>
                <button class="sub-tab-button" data-subtab="ghid_subtab">Ghid de Utilizare</button>
            </div>

            <div id="placeholders_subtab" class="sub-tab-content active">
                <div class="mb-6">
                    <h3 class="settings-section-title">Verifică Valoare Placeholder</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <div>
                            <label for="placeholder-input" class="label-text">Placeholder:</label>
                            <input type="text" id="placeholder-input" class="input-field" placeholder="{nume}">
                        </div>
                        <div class="mt-4 md:mt-0">
                            <label class="label-text">Valoare Curentă:</label>
                            <div id="placeholder-output" class="bg-gray-800 p-2.5 rounded-md text-sm text-amber-400 font-mono min-h-[42px]">
                                &nbsp;
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section-delimiter"></div>
                <h3 class="settings-section-title">Listă Placeholders Disponibili</h3>
                <!-- MODIFICARE: Adaugare buton nou -->
                <div class="flex gap-4 mb-4">
                    <button type="button" id="exportPlaceholdersBtn" class="btn-secondary">Exportă Listă (.txt)</button>
                    <button type="button" id="showCompositePlaceholdersBtn" class="btn-secondary bg-sky-600 hover:bg-sky-700">Placeholders Compusi</button>
                </div>
                <p class="text-xs text-gray-400 mb-4">Acești termeni pot fi folosiți în modelele de descriere pentru a insera automat datele corespunzătoare din formular.</p>
                <div id="placeholders-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                </div>
            </div>

            <div id="aspect_subtab" class="sub-tab-content">
                <h3 class="settings-section-title">Setări Culori</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                    <div class="flex items-center gap-3">
                        <label for="color-background" class="label-text flex-shrink-0">Fundal:</label>
                        <input type="color" id="color-background" data-color-var="background" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                     <div class="flex items-center gap-3">
                        <label for="color-card-background" class="label-text flex-shrink-0">Fundal Principal:</label>
                        <input type="color" id="color-card-background" data-color-var="card-background" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                     <div class="flex items-center gap-3">
                        <label for="color-card-border" class="label-text flex-shrink-0">Chenar Principal:</label>
                        <input type="color" id="color-card-border" data-color-var="card-border" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                     <div class="flex items-center gap-3">
                        <label for="color-modal-background" class="label-text flex-shrink-0">Fundal Modale:</label>
                        <input type="color" id="color-modal-background" data-color-var="modal-background" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                    <div class="flex items-center gap-3">
                        <label for="color-turquoise-box" class="label-text flex-shrink-0">Cetățeni:</label>
                        <input type="color" id="color-turquoise-box" data-color-var="turquoise-box" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                     <div class="flex items-center gap-3">
                        <label for="color-magenta-box" class="label-text flex-shrink-0">Acțiune:</label>
                        <input type="color" id="color-magenta-box" data-color-var="magenta-box" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                     <div class="flex items-center gap-3">
                        <label for="color-white-box" class="label-text flex-shrink-0">Detalii Infracțiuni:</label>
                        <input type="color" id="color-white-box" data-color-var="white-box" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                     <div class="flex items-center gap-3">
                        <label for="color-orange-box" class="label-text flex-shrink-0">Jaf:</label>
                        <input type="color" id="color-orange-box" data-color-var="orange-box" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                    <div class="flex items-center gap-3">
                        <label for="color-yellow-box" class="label-text flex-shrink-0">Vehicule:</label>
                        <input type="color" id="color-yellow-box" data-color-var="yellow-box" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                     <div class="flex items-center gap-3">
                        <label for="color-blue-box" class="label-text flex-shrink-0">Infracțiuni:</label>
                        <input type="color" id="color-blue-box" data-color-var="blue-box" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                     <div class="flex items-center gap-3">
                        <label for="color-red-box" class="label-text flex-shrink-0">Sancțiuni:</label>
                        <input type="color" id="color-red-box" data-color-var="red-box" class="p-1 h-10 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                    </div>
                </div>
                <div class="mt-6">
                    <button type="button" id="resetColorsBtn" class="btn-secondary">Resetează la culorile implicite</button>
                </div>
            </div>

            <div id="sabloane_subtab" class="sub-tab-content">
                 <h3 class="settings-section-title">Editor Șabloane Descriere Caz</h3>
                 <p class="text-xs text-gray-400 mb-4">Modificați șabloanele de text folosite pentru a genera descrierea finală. Folosiți placeholder-ii disponibili pentru a insera dinamic datele.</p>
                 <div class="space-y-4">
                     <div>
                         <label for="template_header" class="label-text">Antet (Infracțiuni, Patrulă, Părți):</label>
                         <textarea id="template_header" class="textarea-field font-mono text-sm" rows="6" disabled></textarea>
                     </div>
                     <h4 class="settings-section-title !mb-2 !mt-6 text-base">Șabloane Introducere</h4>
                      <div>
                         <label for="template_intro_standard" class="label-text">Introducere Standard:</label>
                         <textarea id="template_intro_standard" class="textarea-field font-mono text-sm" rows="2"></textarea>
                     </div>
                     <div>
                         <label for="template_intro_apel_112" class="label-text">Introducere Apel 112:</label>
                         <textarea id="template_intro_apel_112" class="textarea-field font-mono text-sm" rows="2"></textarea>
                     </div>
                      <div>
                         <label for="template_intro_focuri_arma" class="label-text">Introducere Detecție Focuri de Armă:</label>
                         <textarea id="template_intro_focuri_arma" class="textarea-field font-mono text-sm" rows="2"></textarea>
                     </div>
                      <div>
                         <label for="template_intro_mineriada" class="label-text">Introducere Mineriadă:</label>
                         <textarea id="template_intro_mineriada" class="textarea-field font-mono text-sm" rows="2"></textarea>
                     </div>
                      <div>
                         <label for="template_intro_autoconstatare" class="label-text">Introducere Autoconstatare:</label>
                         <textarea id="template_intro_autoconstatare" class="textarea-field font-mono text-sm" rows="2"></textarea>
                     </div>
                      <div>
                         <label for="template_intro_jaf" class="label-text">Introducere Alarmă Jaf:</label>
                         <textarea id="template_intro_jaf" class="textarea-field font-mono text-sm" rows="2"></textarea>
                     </div>
                      <div>
                         <label for="template_intro_rutiera" class="label-text">Introducere Razie Rutieră:</label>
                         <textarea id="template_intro_rutiera" class="textarea-field font-mono text-sm" rows="2"></textarea>
                     </div>
                     <div>
                         <label for="template_intro_razie_sas" class="label-text">Introducere Razie S.A.S.:</label>
                         <textarea id="template_intro_razie_sas" class="textarea-field font-mono text-sm" rows="2"></textarea>
                     </div>
                      <h4 class="settings-section-title !mb-2 !mt-6 text-base">Șablon Concluzie</h4>
                     <div>
                         <label for="template_sanctions" class="label-text">Rezumat Sancțiuni:</label>
                         <textarea id="template_sanctions" class="textarea-field font-mono text-sm" rows="6"></textarea>
                     </div>
                 </div>
                 <div class="mt-6 flex gap-4">
                      <button type="button" id="saveAiLogicBtn" class="btn-primary-small">Salvează Șabloane</button>
                      <!-- MODIFICARE: Redenumire buton -->
                      <button type="button" id="aiSettingsBtn" class="btn-secondary bg-sky-600 hover:bg-sky-700">Setări Avansate</button>
                 </div>
            </div>

            <div id="ghid_subtab" class="sub-tab-content">
                <button type="button" id="editGhidBtn" class="btn-secondary float-right mb-4">Editează Ghidul</button>
                <div class="tutorial-content" id="tutorialContentContainer">
                    <!-- Conținutul ghidului este încărcat dinamic aici -->
                </div>
            </div>
        </div>

        <p class="app-footer-text">by Laur Balaur - 5677</p>
    </div>
    <!-- Toast container modificat -->
    <div id="toast" class="toast-message"></div>

    <!-- Modalele -->
    <div id="descrieriModal" class="modal-overlay hidden-element">
        <div class="modal-content">
            <button id="closeDescrieriModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center">Editează Modele Descriere</h3>
            <div class="space-y-4">
                <div><label for="modal_articol_model_descriere_1" class="label-text">Model descriere 1:</label><textarea id="modal_articol_model_descriere_1" class="textarea-field" rows="5" placeholder="Scrie descrierea la modul general"></textarea></div>
                <div><label for="modal_articol_model_descriere_2" class="label-text">Model descriere 2:</label><textarea id="modal_articol_model_descriere_2" class="textarea-field" rows="5" placeholder="Scrie descrierea la modul general"></textarea></div>
                <div><label for="modal_articol_model_descriere_3" class="label-text">Model descriere 3:</label><textarea id="modal_articol_model_descriere_3" class="textarea-field" rows="5" placeholder="Scrie descrierea la modul general"></textarea></div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="anuleazaDescrieriModalBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaDescrieriModalBtn" class="btn-primary-small">Salvează Descrieri</button>
            </div>
        </div>
    </div>

    <div id="agentiModal" class="modal-overlay hidden-element">
        <div class="modal-content">
            <button id="closeAgentiModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center text-sky-400">Setează Patrula</h3>
            <div class="space-y-6">
                 <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center"><input type="checkbox" style="visibility: hidden;" class="control-input checkbox-input"><h4 class="text-lg font-medium text-sky-500 mb-2 col-span-3">Agent Operativ:</h4></div>
                <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center">
                    <input type="checkbox" style="visibility: hidden;" class="control-input checkbox-input">
                    <div><input type="text" id="agent_op_call_sign_modal" class="input-field max-w-[100px]" placeholder="CS"></div>
                    <div><select id="agent_op_grad_modal" class="select-field max-w-xs"><option value="" disabled selected>Alege Grad...</option><option value="Cadet">Cadet</option><option value="Agent">Agent</option><option value="Agent Principal">Agent Principal</option><option value="Agent Șef Adjunct">Agent Șef Adjunct</option><option value="Agent Șef Principal">Agent Șef Principal</option><option value="Inspector">Inspector</option><option value="Inspector Principal">Inspector Principal</option><option value="Subcomisar">Subcomisar</option><option value="Comisar">Comisar</option><option value="Comisar Șef">Comisar Șef</option><option value="Chestor Adjunct">Chestor Adjunct</option><option value="Chestor">Chestor</option><option value="Agent S.A.S.">Agent S.A.S.</option><option value="Agent Special S.A.S.">Agent Special S.A.S.</option><option value="Coordonator S.A.S.">Coordonator S.A.S.</option><option value="Comandant Șef S.A.S.">Comandant Șef S.A.S.</option></select></div>
                    <div><input type="text" id="agent_op_nume_modal" class="input-field" placeholder="Numele tău"></div>
                </div>
                <div>
                    <h4 class="text-lg font-medium text-sky-500 mb-2">Agent Constatator:</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center">
                         <input type="checkbox" id="include_agent_const_checkbox_modal" class="control-input checkbox-input">
                        <div><input type="text" id="agent_const_call_sign_modal" class="input-field max-w-[100px]" placeholder="CS"></div>
                        <div><select id="agent_const_grad_modal" class="select-field max-w-xs"><option value="" disabled selected>Alege Grad...</option><option value="Cadet">Cadet</option><option value="Agent">Agent</option><option value="Agent Principal">Agent Principal</option><option value="Agent Șef Adjunct">Agent Șef Adjunct</option><option value="Agent Șef Principal">Agent Șef Principal</option><option value="Inspector">Inspector</option><option value="Inspector Principal">Inspector Principal</option><option value="Subcomisar">Subcomisar</option><option value="Comisar">Comisar</option><option value="Comisar Șef">Comisar Șef</option><option value="Chestor Adjunct">Chestor Adjunct</option><option value="Chestor">Chestor</option><option value="Agent S.A.S.">Agent S.A.S.</option><option value="Agent Special S.A.S.">Agent Special S.A.S.</option><option value="Coordonator S.A.S.">Coordonator S.A.S.</option><option value="Comandant Șef S.A.S.">Comandant Șef S.A.S.</option></select></div>
                        <div><input type="text" id="agent_const_nume_modal" class="input-field" placeholder="Numele colegului de patrulă"></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-medium text-sky-500 mb-2">Agent Adițional:</h4>
                     <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center">
                        <input type="checkbox" id="include_agent_ad1_checkbox_modal" class="control-input checkbox-input">
                        <div><input type="text" id="agent_ad1_call_sign_modal" class="input-field max-w-[100px]" placeholder="CS"></div>
                        <div><select id="agent_ad1_grad_modal" class="select-field max-w-xs"><option value="" disabled selected>Alege Grad...</option><option value="Cadet">Cadet</option><option value="Agent">Agent</option><option value="Agent Principal">Agent Principal</option><option value="Agent Șef Adjunct">Agent Șef Adjunct</option><option value="Agent Șef Principal">Agent Șef Principal</option><option value="Inspector">Inspector</option><option value="Inspector Principal">Inspector Principal</option><option value="Subcomisar">Subcomisar</option><option value="Comisar">Comisar</option><option value="Comisar Șef">Comisar Șef</option><option value="Chestor Adjunct">Chestor Adjunct</option><option value="Chestor">Chestor</option><option value="Agent S.A.S.">Agent S.A.S.</option><option value="Agent Special S.A.S.">Agent Special S.A.S.</option><option value="Coordonator S.A.S.">Coordonator S.A.S.</option><option value="Comandant Șef S.A.S.">Comandant Șef S.A.S.</option></select></div>
                        <div><input type="text" id="agent_ad1_nume_modal" class="input-field" placeholder="Numele colegului de patrulă"></div>
                    </div>
                </div>
                 <div>
                    <h4 class="text-lg font-medium text-sky-500 mb-2">Agent Adițional:</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_1.5fr_3fr] gap-x-3 gap-y-2 items-center">
                        <input type="checkbox" id="include_agent_ad2_checkbox_modal" class="control-input checkbox-input">
                        <div><input type="text" id="agent_ad2_call_sign_modal" class="input-field max-w-[100px]" placeholder="CS"></div>
                        <div><select id="agent_ad2_grad_modal" class="select-field max-w-xs"><option value="" disabled selected>Alege Grad...</option><option value="Cadet">Cadet</option><option value="Agent">Agent</option><option value="Agent Principal">Agent Principal</option><option value="Agent Șef Adjunct">Agent Șef Adjunct</option><option value="Agent Șef Principal">Agent Șef Principal</option><option value="Inspector">Inspector</option><option value="Inspector Principal">Inspector Principal</option><option value="Subcomisar">Subcomisar</option><option value="Comisar">Comisar</option><option value="Comisar Șef">Comisar Șef</option><option value="Chestor Adjunct">Chestor Adjunct</option><option value="Chestor">Chestor</option><option value="Agent S.A.S.">Agent S.A.S.</option><option value="Agent Special S.A.S.">Agent Special S.A.S.</option><option value="Coordonator S.A.S.">Coordonator S.A.S.</option><option value="Comandant Șef S.A.S.">Comandant Șef S.A.S.</option></select></div>
                        <div><input type="text" id="agent_ad2_nume_modal" class="input-field" placeholder="Numele colegului de patrulă"></div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-start gap-3">
                <button type="button" id="anuleazaAgentiModalBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaAgentiModalBtn" class="btn-primary-small">Salvează Patrula</button>
            </div>
        </div>
    </div>
    
    <!-- MODIFICARE: Modal redenumit si adaugat continut nou -->
    <div id="aiSettingsModal" class="modal-overlay hidden-element">
        <div class="modal-content max-w-2xl">
            <button id="closeAiSettingsModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center text-sky-400">Setări Avansate</h3>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-4">
                
                <h4 class="settings-section-title !mt-2 !mb-2">Formatare Titlu</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="title_separator_input" class="label-text">Separator Titluri Infracțiuni:</label>
                        <input type="text" id="title_separator_input" class="input-field font-mono" placeholder="; ">
                    </div>
                    <div>
                        <label for="title_format_input" class="label-text">Format Titlu Final:</label>
                        <input type="text" id="title_format_input" class="input-field font-mono" placeholder="{titluri_infractiuni} ({capitol_principal})">
                         <p class="text-xs text-gray-500 mt-1">Folosește {titluri_infractiuni} și {capitol_principal}.</p>
                    </div>
                </div>

                <div class="section-delimiter"></div>

                <h4 class="settings-section-title !mb-2">Șablon Antet (Header)</h4>
                <div>
                    <label for="composite_header_template" class="label-text">Structura principală a descrierii:</label>
                    <textarea id="composite_header_template" class="textarea-field font-mono text-sm" rows="8"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Acesta este șablonul principal care combină toate secțiunile. Folosește placeholder-i compuși precum {lista_infractiuni}, {patrola_text}, {partea_vatamata_text}, {martori_text}.</p>
                </div>

                <div class="section-delimiter"></div>
                
                <!-- NOU: Sectiune pentru termeni de gen -->
                <h4 class="settings-section-title !mb-2">Adaptare Gen (Masculin / Feminin)</h4>
                <p class="text-xs text-gray-500 mb-2">Acești termeni sunt adaptați automat în funcție de sexul selectat pentru inculpat, victimă și martori.</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm p-3 bg-black/20 rounded-md">
                    <div><span class="text-gray-400">cetățeanul</span> → <span class="text-sky-400">cetățeanca</span></div>
                    <div><span class="text-gray-400">numitul</span> → <span class="text-sky-400">numita</span></div>
                    <div><span class="text-gray-400">inculpatul</span> → <span class="text-sky-400">inculpata</span></div>
                    <div><span class="text-gray-400">individul</span> → <span class="text-sky-400">individa</span></div>
                    <div><span class="text-gray-400">suspectul</span> → <span class="text-sky-400">suspecta</span></div>
                    <div><span class="text-gray-400">șoferul</span> → <span class="text-sky-400">șoferița</span></div>
                    <div><span class="text-gray-400">pietonul</span> → <span class="text-sky-400">pietoana</span></div>
                    <div><span class="text-gray-400">făptuitorul</span> → <span class="text-sky-400">făptuitoarea</span></div>
                    <div><span class="text-gray-400">reclamantul</span> → <span class="text-sky-400">reclamanta</span></div>
                    <div><span class="text-gray-400">martorul</span> → <span class="text-sky-400">martora</span></div>
                    <div><span class="text-gray-400">păgubitul</span> → <span class="text-sky-400">păgubita</span></div>
                    <div><span class="text-gray-400">acesta</span> → <span class="text-sky-400">aceasta</span></div>
                    <div><span class="text-gray-400">dânsul</span> → <span class="text-sky-400">dânsa</span></div>
                    <div><span class="text-gray-400">el</span> → <span class="text-sky-400">ea</span></div>
                    <div><span class="text-gray-400">lui</span> → <span class="text-sky-400">ei</span></div>
                    <div><span class="text-gray-400">identificat</span> → <span class="text-sky-400">identificată</span></div>
                    <div><span class="text-gray-400">legitimat</span> → <span class="text-sky-400">legitimată</span></div>
                    <div><span class="text-gray-400">depistat</span> → <span class="text-sky-400">depistată</span></div>
                    <div><span class="text-gray-400">aflat</span> → <span class="text-sky-400">aflată</span></div>
                    <div><span class="text-gray-400">surprins</span> → <span class="text-sky-400">surprinsă</span></div>
                    <div><span class="text-gray-400">sancționat</span> → <span class="text-sky-400">sancționată</span></div>
                </div>

                <div class="section-delimiter"></div>

                <h4 class="settings-section-title !mb-2">Instrucțiuni Generale AI (Prompt)</h4>
                <div>
                    <label for="ai_prompt_instructions" class="label-text">Instrucțiuni pentru gramatică, punctuație și logică:</label>
                    <textarea id="ai_prompt_instructions" class="textarea-field font-mono text-sm" rows="5" placeholder="Ex: Folosește un limbaj formal. Verifică acordul gramatical..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Notă: Acest câmp este pentru referință și planificare. Logica actuală a aplicației (corectură gramaticală, adaptare la gen) este pre-programată.</p>
                </div>

            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="anuleazaAiSettingsModalBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaAiSettingsModalBtn" class="btn-primary-small">Salvează Setările</button>
            </div>
        </div>
    </div>

    <!-- NOU: Modal pentru editare Ghid -->
    <div id="ghidModal" class="modal-overlay hidden-element">
        <div class="modal-content max-w-4xl">
            <button id="closeGhidModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center">Editează Ghidul de Utilizare</h3>
            <div>
                <div id="ghidEditorToolbar">
                    <button class="toolbar-button" data-command="bold" title="Îngroșat"><i class="fas fa-bold"></i></button>
                    <button class="toolbar-button" data-command="italic" title="Înclinat"><i class="fas fa-italic"></i></button>
                    <button class="toolbar-button" data-command="underline" title="Subliniat"><i class="fas fa-underline"></i></button>
                    <input type="color" class="toolbar-button p-1 h-8 w-8" id="ghidFontColor" title="Culoare text">
                </div>
                <div id="ghidEditor" class="tutorial-content" contenteditable="true"></div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="anuleazaGhidModalBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaGhidModalBtn" class="btn-primary-small">Salvează Ghidul</button>
            </div>
        </div>
    </div>

    <!-- NOU: Modal pentru Placeholders Compusi -->
    <div id="compositePlaceholdersModal" class="modal-overlay hidden-element">
        <div class="modal-content max-w-3xl">
            <button id="closeCompositePlaceholdersModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center text-sky-400">Placeholders Compusi (Condiționali)</h3>
            <p class="text-sm text-gray-400 mb-6 text-center">Acești placeholders își schimbă textul final în funcție de datele introduse în formular.</p>
            
            <div class="space-y-6 max-h-[60vh] overflow-y-auto pr-4">
                <!-- Exemplu 1: Numar Inmatriculare -->
                <div>
                    <h4 class="font-bold text-lg text-highlight">{nr_inmatriculare}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Text (dacă este completat):</label>
                            <textarea id="composite_nr_inmatriculare_filled" class="textarea-field font-mono text-xs" rows="2" placeholder="cu numerele de înmatriculare [VALOARE]"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Text (dacă este gol):</label>
                            <textarea id="composite_nr_inmatriculare_empty" class="textarea-field font-mono text-xs" rows="2" placeholder="fără numere de înmatriculare"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Exemplu 2: Partea Vatamata -->
                <div>
                    <h4 class="font-bold text-lg text-highlight">{partea_vatamata_text}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Text (dacă este completat):</label>
                            <textarea id="composite_partea_vatamata_text_filled" class="textarea-field font-mono text-xs" rows="3" placeholder="Partea vătămată: [NUME_RECLAMANT] (CNP: [CNP_RECLAMANT])"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Text (dacă este gol):</label>
                            <textarea id="composite_partea_vatamata_text_empty" class="textarea-field font-mono text-xs" rows="3" placeholder="Partea vătămată: Statul Român"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Exemplu 3: Martori -->
                <div>
                    <h4 class="font-bold text-lg text-highlight">{martori_text}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Șablon pentru un singur martor:</label>
                            <textarea id="composite_martori_text_filled_single" class="textarea-field font-mono text-xs" rows="2" placeholder="Martor: [NUME_MARTOR], CNP: [CNP_MARTOR]"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Text (dacă nu există martori):</label>
                            <textarea id="composite_martori_text_empty" class="textarea-field font-mono text-xs" rows="2" placeholder="(Acest placeholder este omis complet dacă nu există martori)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Exemplu 4: Patrola -->
                <div>
                    <h4 class="font-bold text-lg text-highlight">{patrola_text}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Șablon pentru membrii patrulei:</label>
                            <textarea id="composite_patrola_text_filled_members" class="textarea-field font-mono text-xs" rows="2" placeholder="[MEMBERS]"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Text (dacă nu este setată patrula):</label>
                            <textarea id="composite_patrola_text_empty" class="textarea-field font-mono text-xs" rows="2" placeholder="(Acest placeholder este omis complet dacă nu este setată patrula)"></textarea>
                        </div>
                    </div>
                </div>
                
                 <!-- Exemplu 5: Sanctiuni Lista -->
                <div>
                    <h4 class="font-bold text-lg text-highlight">Sancțiuni (elemente individuale)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Șablon Amendă:</label>
                            <textarea id="composite_sanctiuni_amenda" class="textarea-field font-mono text-xs" rows="2" placeholder="- Amendă contravențională în valoare de [VALOARE]$"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Șablon Arest:</label>
                            <textarea id="composite_sanctiuni_arest" class="textarea-field font-mono text-xs" rows="2" placeholder="- Reținere în custodie pentru [DURATA] luni, în [LOCATIE]"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Șablon Anulare Permis:</label>
                            <textarea id="composite_sanctiuni_anulare_permis" class="textarea-field font-mono text-xs" rows="2" placeholder="- Anularea permisului de conducere"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Șablon Ridicare Vehicul:</label>
                            <textarea id="composite_sanctiuni_ridicare_vehicul" class="textarea-field font-mono text-xs" rows="2" placeholder="- Ridicarea autovehiculului"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Șablon Percheziție Măsură:</label>
                            <textarea id="composite_sanctiuni_perchezitie_masura" class="textarea-field font-mono text-xs" rows="2" placeholder="- Percheziție corporală și a vehiculului."></textarea>
                        </div>
                         <div>
                            <label class="label-text">Text (dacă nu se aplică sancțiuni):</label>
                            <textarea id="composite_sanctiuni_lista_empty" class="textarea-field font-mono text-xs" rows="2" placeholder="(Acest placeholder este omis complet dacă nu se aplică sancțiuni)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- NOU: Sectiune pentru Perchezitie Buzunare -->
                <div>
                    <h4 class="font-bold text-lg text-highlight">{perchezitie_buzunare}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Text (dacă este completat):</label>
                            <textarea id="composite_perchezitie_buzunare_filled" class="textarea-field font-mono text-xs" rows="2" placeholder="în buzunare s-a găsit [VALOARE]"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Text (dacă este gol):</label>
                            <textarea id="composite_perchezitie_buzunare_empty" class="textarea-field font-mono text-xs" rows="2" placeholder=""></textarea>
                        </div>
                    </div>
                </div>

                <!-- NOU: Sectiune pentru Perchezitie Torpedo -->
                <div>
                    <h4 class="font-bold text-lg text-highlight">{perchezitie_torpedo}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Text (dacă este completat):</label>
                            <textarea id="composite_perchezitie_torpedo_filled" class="textarea-field font-mono text-xs" rows="2" placeholder="în torpedo s-a găsit [VALOARE]"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Text (dacă este gol):</label>
                            <textarea id="composite_perchezitie_torpedo_empty" class="textarea-field font-mono text-xs" rows="2" placeholder=""></textarea>
                        </div>
                    </div>
                </div>

                <!-- NOU: Sectiune pentru Perchezitie Portbagaj -->
                <div>
                    <h4 class="font-bold text-lg text-highlight">{perchezitie_portbagaj}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="label-text">Text (dacă este completat):</label>
                            <textarea id="composite_perchezitie_portbagaj_filled" class="textarea-field font-mono text-xs" rows="2" placeholder="în portbagaj s-a găsit [VALOARE]"></textarea>
                        </div>
                        <div>
                            <label class="label-text">Text (dacă este gol):</label>
                            <textarea id="composite_perchezitie_portbagaj_empty" class="textarea-field font-mono text-xs" rows="2" placeholder=""></textarea>
                        </div>
                    </div>
                </div>

            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="anuleazaCompositePlaceholdersBtn" class="btn-secondary">Anulează</button>
                <button type="button" id="salveazaCompositePlaceholdersBtn" class="btn-primary-small">Salvează</button>
            </div>
        </div>
    </div>


    <script>
        // --- MODIFICARE JAVASCRIPT PENTRU NOTIFICARI ---
        // Functia showToast a fost modificata pentru a gestiona noile animatii si pictograme.
        function showToast(message, success = true) {
            const toast = document.getElementById('toast');
            if (toast) {
                // Adauga pictograma corespunzatoare
                const iconClass = success ? 'fa-solid fa-check-circle' : 'fa-solid fa-times-circle';
                toast.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
                
                // Seteaza culoarea de fundal
                toast.style.backgroundColor = success ? '#238636' : '#DC2626'; // Verde pentru succes, Rosu pentru eroare
                
                // Adauga clasa 'show' pentru a declansa animatia de intrare
                toast.classList.add('show');
                toast.classList.remove('hide');

                // Seteaza un timeout pentru a ascunde notificarea
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('hide'); // Adauga clasa 'hide' pentru animatia de iesire
                }, 4000); // Notificarea va fi vizibila pentru 4 secunde
            }
        }
    
        // RESTUL CODULUI JAVASCRIPT ORIGINAL INCEPE AICI...
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Selectors ---
            const mainTabButtons = document.querySelectorAll('.tab-button');
            const mainTabContents = document.querySelectorAll('.tab-content');
            
            const procesatorForm = document.getElementById('procesatorForm');
            const resetFormBtn = document.getElementById('resetFormBtn');
            const copyDescriptionBtn = document.getElementById('copyDescriptionBtn');
            const copyTitlesBtn = document.getElementById('copyTitlesBtn');
            const generateCaseDescriptionBtn = document.getElementById('generateCaseDescriptionBtn');
            const caseDescriptionOutput = document.getElementById('caseDescriptionOutput');
            const generatedTitlesOutput = document.getElementById('generatedTitlesOutput');

            // Global DOM Elements
            const zonaSelect = document.getElementById('zona_input'); 
            const listaZoneDatalist = document.getElementById('lista_zone'); 
            const limitaVitezaZonaInput = document.getElementById('limita_viteza_zona');
            const infractiuneInputs = [
                document.getElementById('infractiune1'),
                document.getElementById('infractiune2'),
                document.getElementById('infractiune3')
            ];
            
            const dataProcesareInput = document.getElementById('data_procesare');
            const oraProcesareInput = document.getElementById('ora_procesare');
            const actualizeazaDateTimeBtn = document.getElementById('actualizeazaDateTimeBtn');

            const tipVehiculProcesatorSelect = document.getElementById('tip_vehicul_procesator');
            const modelVehiculInput = document.getElementById('model_vehicul_input'); 
            const listaModeleVehiculeDatalist = document.getElementById('lista_modele_vehicule'); 
            const adaugaVehiculDinProcesatorBtn = document.getElementById('adaugaVehiculDinProcesatorBtn');

            const globalInfractionError = document.getElementById('globalInfractionError');
            
            // Cod Penal Settings Elements
            const codPenalForm = document.getElementById('codPenalForm');
            const listaArticoleCodPenalDiv = document.getElementById('listaArticoleCodPenal');
            const incompatibilitatiListContainer = document.getElementById('incompatibilitatiListContainer');
            const incompatibilitatiLabel = document.getElementById('incompatibilitatiLabel');
            const incompatibilitatiCountSpan = document.getElementById('incompatibilitatiCount');
            const verificareArticolInput = document.getElementById('verificare_articol');
            const articolArestPeViataCheckbox = document.getElementById('articol_arest_pe_viata');
            const articolArestMaxInput = document.getElementById('articol_arest_max');
            const placeholderInput = document.getElementById('placeholder-input');
            const placeholderOutput = document.getElementById('placeholder-output');
            const exportPlaceholdersBtn = document.getElementById('exportPlaceholdersBtn');

            // Speed Limit Settings Elements
            const speedLimitSettingsForm = document.getElementById('speedLimitSettingsForm');
            const streetNameSettingsInput = document.getElementById('street_name_settings_input');
            const speedLimitSettingsInput = document.getElementById('speed_limit_settings_input');
            const addSpeedLimitBtn = document.getElementById('addSpeedLimitBtn');
            const speedLimitListUL = document.getElementById('speedLimitListUL');
            
            // Other Procesator Form elements
            const amendaTotalaInput = document.getElementById('amenda_totala');
            const arestTotalMinInput = document.getElementById('arest_total_min');
            const arestTotalMaxInput = document.getElementById('arest_total_max');
            const punctePermisInput = document.getElementById('puncte_permis');
            const anularePermisCheckbox = document.getElementById('anulare_permis');
            const ridicareVehiculCheckbox = document.getElementById('ridicare_vehicul');
            const perchezitieMasuraCheckbox = document.getElementById('perchezitie_masura');

            const locatieDetentieContainer = document.getElementById('locatie_detentie_container');
            const numeReclamantInput = document.getElementById('nume_reclamant');
            
            // Modal elements
            const descrieriModal = document.getElementById('descrieriModal');
            const editeazaDescrieriBtn = document.getElementById('editeazaDescrieriBtn');
            const salveazaDescrieriModalBtn = document.getElementById('salveazaDescrieriModalBtn');
            const anuleazaDescrieriModalBtn = document.getElementById('anuleazaDescrieriModalBtn');
            const closeDescrieriModalBtn = document.getElementById('closeDescrieriModalBtn');
            const modalDescriere1 = document.getElementById('modal_articol_model_descriere_1');
            const modalDescriere2 = document.getElementById('modal_articol_model_descriere_2');
            const modalDescriere3 = document.getElementById('modal_articol_model_descriere_3');

            // Agenti Modal Elements
            const agentiModal = document.getElementById('agentiModal');
            const seteazaPatrulaBtn = document.getElementById('seteazaPatrulaBtn');
            const closeAgentiModalBtn = document.getElementById('closeAgentiModalBtn');
            const salveazaAgentiModalBtn = document.getElementById('salveazaAgentiModalBtn');
            const anuleazaAgentiModalBtn = document.getElementById('anuleazaAgentiModalBtn');
            
            // Toggler Checkboxes & Containers
            const licenteCheckbox = document.getElementById('licente_checkbox');
            const licenteContainer = document.getElementById('licente_container');
            const crimaOrganizataCheckbox = document.getElementById('crima_organizata_checkbox');
            const crimaOrganizataContainer = document.getElementById('crima_organizata_container');
            const perchezitieCheckbox = document.getElementById('perchezitie_checkbox');
            const perchezitieContainer = document.getElementById('perchezitie_container');
            const substantaCheckbox = document.getElementById('substanta_checkbox');
            const substantaContainer = document.getElementById('substanta_container');

            // Backup/Restore Buttons
            const exportAllSettingsBtn = document.getElementById('exportAllSettingsBtn');
            const importAllSettingsFile = document.getElementById('importAllSettingsFile');
            
            // Vehicle Settings Elements
            const vehicleTypeSettingsSelect = document.getElementById('vehicle_type_settings');
            const vehicleModelSettingsInput = document.getElementById('vehicle_model_settings_input');
            const addCustomVehicleBtn = document.getElementById('addCustomVehicleBtn');
            const customVehicleListUL = document.getElementById('customVehicleList');

            // AI Logic Editor Elements
            const saveAiLogicBtn = document.getElementById('saveAiLogicBtn');
            const aiSettingsBtn = document.getElementById('aiSettingsBtn');
            const aiSettingsModal = document.getElementById('aiSettingsModal');
            const closeAiSettingsModalBtn = document.getElementById('closeAiSettingsModalBtn');
            const anuleazaAiSettingsModalBtn = document.getElementById('anuleazaAiSettingsModalBtn');
            const salveazaAiSettingsModalBtn = document.getElementById('salveazaAiSettingsModalBtn');
            
            // Martori Elements
            const adaugaMartorBtn = document.getElementById('adaugaMartorBtn');
            const martoriContainer = document.getElementById('martoriContainer');

            // Ghid Elements
            const editGhidBtn = document.getElementById('editGhidBtn');
            const ghidModal = document.getElementById('ghidModal');
            const closeGhidModalBtn = document.getElementById('closeGhidModalBtn');
            const anuleazaGhidModalBtn = document.getElementById('anuleazaGhidModalBtn');
            const salveazaGhidModalBtn = document.getElementById('salveazaGhidModalBtn');
            const ghidEditor = document.getElementById('ghidEditor');
            const tutorialContentContainer = document.getElementById('tutorialContentContainer');
            const ghidEditorToolbar = document.getElementById('ghidEditorToolbar');

            // NOU: Selectors pentru modalul de placeholders compusi
            const showCompositePlaceholdersBtn = document.getElementById('showCompositePlaceholdersBtn');
            const compositePlaceholdersModal = document.getElementById('compositePlaceholdersModal');
            const closeCompositePlaceholdersModalBtn = document.getElementById('closeCompositePlaceholdersModalBtn');
            const anuleazaCompositePlaceholdersBtn = document.getElementById('anuleazaCompositePlaceholdersBtn'); // Added
            const salveazaCompositePlaceholdersBtn = document.getElementById('salveazaCompositePlaceholdersBtn'); // Added

            // --- State Variables ---
            let codPenalEntries = []; 
            let infractionSanctionsData = {}; 
            let editingCodPenalIndex = null;
            let streetSpeedLimitsData = []; 
            let editingSpeedLimitIndex = null;
            const speedLimits = { "": "Selectați zona" };
            let customVehicleModels = []; 
            let editingVehicleIndex = null; 
            let aiLogicTemplates = {};
            let aiSettings = {};
            let martorCounter = 0;
            let compositePlaceholderTemplates = {}; // NEW: State for composite placeholders
            
            const defaultColors = {
                'turquoise-box': '#2DD4BF',
                'magenta-box': '#D946EF',
                'white-box': '#E5E7EB',
                'orange-box': '#F97316',
                'yellow-box': '#FBBF24',
                'blue-box': '#3B82F6',
                'red-box': '#DC2626',
                'background': '#0D1117',
                'modal-background': '#161B22',
                'card-border': '#30363D',
                'card-background': '#161B22'
            };

            const defaultAiSettings = {
                prompt: "Folosește un limbaj formal, specific Poliției Române. Verifică acordul gramatical între subiect și predicat și adaptează substantivele și adjectivele la genul persoanelor implicate. Asigură-te că punctuația este corectă, cu spațiu după virgulă și punct.",
                titleSeparator: "; ",
                titleFormat: "{titluri_infractiuni} ({capitol_principal})",
                headerTemplate: `**INFRACȚIUNI:**\n{lista_infractiuni}\n\n**PATRULA:**\n{patrola_text}\n\n**PĂRȚI IMPLICATE:**\nInculpat: {nume}, CNP: {cnp}\n{partea_vatamata_text}\n{martori_text}`
            };

            const defaultAiLogicTemplates = {
                intro_standard: "",
                intro_apel_112: "",
                intro_focuri_arma: "",
                intro_mineriada: "",
                intro_autoconstatare: "",
                intro_jaf: "",
                intro_rutiera: "",
                intro_razie_sas: "",
                sanctions: ""
            };

            // NEW: Default templates for composite placeholders
            const defaultCompositePlaceholderTemplates = {
                nr_inmatriculare_filled: "cu numerele de înmatriculare [VALOARE]",
                nr_inmatriculare_empty: "fără numere de înmatriculare",
                partea_vatamata_text_filled: "Partea vătămată: [NUME_RECLAMANT] (CNP: [CNP_RECLAMANT])",
                partea_vatamata_text_empty: "Partea vătămată: Statul Român",
                martori_text_filled_single: "Martor: [NUME_MARTOR], CNP: [CNP_MARTOR]",
                martori_text_empty: "(Acest placeholder este omis complet dacă nu există martori)",
                patrola_text_filled_members: "[MEMBERS]",
                patrola_text_empty: "(Acest placeholder este omis complet dacă nu este setată patrula)",
                sanctiuni_amenda: "- Amendă contravențională în valoare de [VALOARE]$",
                sanctiuni_arest: "- Reținere în custodie pentru [DURATA] luni, în [LOCATIE]",
                sanctiuni_anulare_permis: "- Anularea permisului de conducere",
                sanctiuni_ridicare_vehicul: "- Ridicarea autovehiculului",
                sanctiuni_perchezitie_masura: "- Percheziție corporală și a vehiculului.",
                sanctiuni_lista_empty: "(Acest placeholder este omis complet dacă nu se aplică sancțiuni)",
                perchezitie_buzunare_filled: "în buzunare s-a găsit [VALOARE]",
                perchezitie_buzunare_empty: "",
                perchezitie_torpedo_filled: "în torpedo s-a găsit [VALOARE]",
                perchezitie_torpedo_empty: "",
                perchezitie_portbagaj_filled: "în portbagaj s-a găsit [VALOARE]",
                perchezitie_portbagaj_empty: ""
            };


            const defaultGhidHTML = `
                <h2>1. Introducere</h2>
                <p><strong>MDT Helper</strong> este o unealtă concepută pentru a eficientiza procesul de creare a dosarelor penale și a amenzilor, automatizând calcularea sancțiunilor și generarea descrierilor narative pe baza datelor introduse.</p>
                <h2>2. Configurare Inițială</h2>
                <p>La prima utilizare, aplicația este goală. Pentru a o popula cu date (articole din codul penal, modele de vehicule etc.), urmați pașii de mai jos:</p>
                <ul>
                    <li><strong>Încarcă Datele:</strong> Apăsați butonul <strong>"Încarcă datele"</strong> din colțul stânga-sus.</li>
                    <li><strong>Selectează Fișierul:</strong> Alegeți fișierul <code>mdt_data.txt</code> de pe computer. Acest fișier conține întreaga bază de date a aplicației.</li>
                    <li>Odată încărcat, toate listele și opțiunile din aplicație vor fi populate automat.</li>
                </ul>
                <blockquote><strong>Notă:</strong> Puteți salva oricând configurația curentă mergând la tab-ul <strong>Baza de Date</strong> și apăsând pe <strong>"Salvează datele"</strong>. Acest lucru va genera un nou fișier <code>mdt_data.txt</code>.</blockquote>
                <h2>3. Setarea Patrulei</h2>
                <p>Înainte de a procesa un caz, este esențial să vă setați patrula pentru sesiunea curentă:</p>
                <ul>
                    <li>Apăsați butonul <strong>"Setează Patrulă"</strong>.</li>
                    <li>În fereastra care apare, completați datele pentru agentul operativ (dumneavoastră).</li>
                    <li>Bifați și completați datele pentru agenții parteneri, dacă este cazul.</li>
                    <li>Apăsați <strong>"Salvează Patrula"</strong>. Numele agenților vor fi afișate sub buton.</li>
                </ul>
                <h2>4. Tab-ul "Procesator" - Generarea unui Raport</h2>
                <p>Acesta este ecranul principal unde veți lucra cel mai mult.</p>
                <h3>4.1. Verificare Rapidă Articol</h3>
                <p>În câmpul <strong>"Verificare Articol Cod Penal"</strong>, puteți căuta rapid un articol pentru a-i vedea definiția, sancțiunile și incompatibilitățile.</p>
                <h3>4.2. Datele Părților</h3>
                <p>În <strong>chenarul albastru</strong>, completați datele inculpatului, ale reclamantului/victimei și, de acum, și ale <strong>martorilor</strong>. Puteți adăuga câți martori este necesar folosind butonul "Adaugă Martor".</p>
                <h3>4.3. Acțiunea</h3>
                <p>În <strong>chenarul albastru</strong>, selectați tipul acțiunii. Aceasta va alege șablonul corect și va pre-bifa opțiuni relevante (ex., "Rutieră" bifează "Substanță sub influență").</p>
                <h3>4.4. Detalii Suplimentare</h3>
                <p>În <strong>chenarul gri-închis</strong>, adăugați detalii specifice cazului bifând căsuțele corespunzătoare. De exemplu, bifarea căsuței "Percheziție" va afișa câmpuri pentru <code>{buzunare}</code>, <code>{torpedo}</code> și <code>{portbagaj}</code>.</p>
                <h3>4.5. Detalii Vehicul</h3>
                <p>În <strong>chenarul gri-închis</strong>, completați detaliile vehiculului. Limita de viteză se va completa automat pe baza străzii selectate.</p>
                <h3>4.6. Infracțiuni</h3>
                <p>În <strong>chenarul gri-închis</strong>, selectați până la trei infracțiuni. Sancțiunile se vor calcula și actualiza automat.</p>
                <h3>4.7. Generare și Copiere</h3>
                <ul>
                    <li>După ce ați completat datele, apăsați <strong>"Generează"</strong>.</li>
                    <li>Titlul și descrierea completă vor apărea mai jos.</li>
                    <li>Folosiți butoanele <strong>"Copiază titlu"</strong> și <strong>"Copiază descriere"</strong>.</li>
                </ul>
                <h2>5. Tab-ul "Baza de Date"</h2>
                <p>Aici personalizați articolele, vehiculele și zonele. Fiecare secțiune are butoane de <strong>Modificare</strong> și <strong>Ștergere</strong>.</p>
                <h2>6. Tab-ul "Setări"</h2>
                <h3>6.1. Placeholders</h3>
                <p>O listă completă a tuturor placeholder-ilor disponibili, inclusiv noii termeni pentru martori (ex: code>{martori_text}</code>). Puteți da click pe unul pentru a-l copia.</p>
                <h3>6.2. Aspect</h3>
                <p>Personalizați complet aspectul vizual al aplicației.</p>
                <h3>6.3. Șabloane și Setări Avansate</h3>
                <p>Aici puteți modifica șabloanele pentru fiecare tip de introducere (Standard, Apel 112 etc.). De asemenea, noul buton <strong>"Setări Avansate de Generare (AI)"</strong> vă permite să personalizați structura de bază a rapoartelor și formatul titlurilor.</p>`;

            // --- Functions ---
            
            function getCurrentRomanianDateTime() {
                const now = new Date();
                const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Europe/Bucharest' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Europe/Bucharest' };
                const romanianDate = now.toLocaleDateString('ro-RO', dateOptions);
                const romanianTime = now.toLocaleTimeString('ro-RO', timeOptions);
                return { date: romanianDate, time: romanianTime };
            }

            function updateDateTimeFields() {
                const { date, time } = getCurrentRomanianDateTime();
                if (dataProcesareInput) dataProcesareInput.value = date;
                if (oraProcesareInput) oraProcesareInput.value = time;
            }

            function getArticleForNoun(noun) {
                if (typeof noun !== 'string' || noun.length === 0) return 'un';
                
                const lowerCaseNoun = noun.toLowerCase();
                 if (lowerCaseNoun === 'atv') return 'un';
                if (lowerCaseNoun.includes('autospecial')) return 'o'; 
                
                const lastChar = lowerCaseNoun.slice(-1);
                if (lastChar === 'a' || lastChar === 'ă') {
                   return 'o';
                }

                return 'un';
            }

            function populateProcesatorVehicleTypeDropdown() {
                const procesatorVehicleSelect = document.getElementById('tip_vehicul_procesator');
                if (!procesatorVehicleSelect) return;

                const currentValue = procesatorVehicleSelect.value;
                procesatorVehicleSelect.innerHTML = '<option value="">Selectează tipul...</option>'; 

                const customTypes = customVehicleModels.map(v => v.type);
                const allUniqueTypes = [...new Set(customTypes)].sort();

                allUniqueTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    if (type.toLowerCase() === 'atv') {
                        option.textContent = 'ATV';
                    } else {
                        option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                    }
                    procesatorVehicleSelect.appendChild(option);
                });

                if (allUniqueTypes.includes(currentValue)) {
                    procesatorVehicleSelect.value = currentValue;
                }
            }
            
            function preprocessCodPenalData(entries) {
                if (!Array.isArray(entries)) return [];
                return entries.map(entry => {
                    const originalTitle = String(entry.titlu || '');
                    let numarArticolNou = '';
                    let titluNou = originalTitle;

                    const regex = /^((?:Art\.\s*)?[\d\.]+(?:\s*\([\w\s\.]+\))?(?:\s*[Ll][Ii][Tt]\.?\s*[a-zA-Z])?)\s*(.*)/;
                    const match = originalTitle.match(regex);

                    if (match && match[1]) {
                        numarArticolNou = match[1].replace(/^Art\.\s*/, '').trim(); 
                        titluNou = (match[match.length - 1] || '').trim(); 
                    } else {
                        numarArticolNou = String(entry.numarArticol || '').trim(); 
                        titluNou = originalTitle;
                    }
                    
                    return {
                        ...entry,
                        numarArticol: numarArticolNou, 
                        titlu: titluNou, 
                        capitolText: entry.capitolText 
                    };
                });
            }

            function renderSpeedLimitsList() {
                const jafLocatieDatalist = document.getElementById('lista_locatii_jaf');
                if (!speedLimitListUL || !listaZoneDatalist || !jafLocatieDatalist) return;
                
                speedLimitListUL.innerHTML = '';
                listaZoneDatalist.innerHTML = ''; 
                jafLocatieDatalist.innerHTML = '';

                Object.keys(speedLimits).forEach(key => { 
                    if (key !== "") delete speedLimits[key];
                });

                streetSpeedLimitsData.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'speed-limit-list-item'; 
                    listItem.innerHTML = `
                        <span>${item.name} - ${item.limit}</span>
                        <div class="actions">
                            <button type="button" data-index="${index}" class="btn-primary-small edit-speed-limit-btn">Modifică</button>
                            <button type="button" data-index="${index}" class="btn-danger delete-speed-limit-btn">Șterge</button>
                        </div>
                    `;
                    speedLimitListUL.appendChild(listItem);

                    const zonaOptionItem = document.createElement('option');
                    zonaOptionItem.value = item.name; 
                    listaZoneDatalist.appendChild(zonaOptionItem);
                    
                    const jafLocatieOption = document.createElement('option');
                    jafLocatieOption.value = item.name; 
                    jafLocatieDatalist.appendChild(jafLocatieOption);
                    
                    speedLimits[item.name] = item.limit; 
                });
                updateSpeedLimitDisplay(); 
            }

            function renderCustomVehicleList() {
                if (!customVehicleListUL || !listaModeleVehiculeDatalist) return; 
                
                customVehicleModels.sort((a, b) => a.name.localeCompare(b.name));

                customVehicleListUL.innerHTML = '';
                
                customVehicleModels.forEach((vehicle) => {
                    const originalIndex = customVehicleModels.findIndex(v => v.id === vehicle.id);
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'vehicle-list-item';
                    listItem.innerHTML = `
                        <span>${vehicle.name} (Tip: ${vehicle.type})</span>
                        <div class="actions">
                            <button type="button" data-index="${originalIndex}" class="btn-primary-small edit-vehicle-btn">Modifică</button>
                            <button type="button" data-index="${originalIndex}" class="btn-danger delete-vehicle-btn">Șterge</button>
                        </div>
                    `;
                    customVehicleListUL.appendChild(listItem);
                });
                 populateProcesatorVehicleTypeDropdown(); 
                 filterVehicleModels();
                 populateVehicleTypeSettingsDropdown();
            }
            
            function populateVehicleTypeSettingsDropdown() {
                const vehicleTypeSettingsSelect = document.getElementById('vehicle_type_settings');
                if (!vehicleTypeSettingsSelect) return;

                const currentValue = vehicleTypeSettingsSelect.value;
                vehicleTypeSettingsSelect.innerHTML = '';

                const defaultTypes = ['autoturism', 'bicicleta', 'motocicleta', 'elicopter', 'skyjet', 'barca', 'atv', 'camion', 'autospecială', 'autospeciala'];
                const customTypes = customVehicleModels.map(v => v.type);
                const allUniqueTypes = [...new Set([...defaultTypes, ...customTypes])].sort();

                allUniqueTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                    vehicleTypeSettingsSelect.appendChild(option);
                });

                if (allUniqueTypes.includes(currentValue)) {
                    vehicleTypeSettingsSelect.value = currentValue;
                } else if (allUniqueTypes.length > 0) {
                    vehicleTypeSettingsSelect.value = allUniqueTypes[0];
                }
            }
            
            function filterVehicleModels() {
                const selectedType = tipVehiculProcesatorSelect.value;
                listaModeleVehiculeDatalist.innerHTML = '';
                let modelsToDisplay;

                if (selectedType) {
                    modelsToDisplay = customVehicleModels.filter(vehicle => vehicle.type === selectedType);
                } else {
                    modelsToDisplay = customVehicleModels;
                }
                
                modelsToDisplay.sort((a, b) => a.name.localeCompare(b.name));

                modelsToDisplay.forEach(vehicle => {
                    const optionItem = document.createElement('option');
                    optionItem.value = vehicle.name;
                    listaModeleVehiculeDatalist.appendChild(optionItem);
                });
            }
            
            function generateArticleId(capitol, numarArticol, titlu) {
                const capClean = String(capitol || '').toLowerCase().replace(/[^a-z0-9\.]/g, '').replace(/\.$/, '');
                const numarArticolClean = String(numarArticol || '').toLowerCase().replace(/[^a-z0-9\.\(\)]/g, '_'); 
                const titluClean = String(titlu || '').toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').substring(0, 30);
                return `${capClean}_${numarArticolClean}_${titluClean}`.replace(/__+/g, '_'); 
            }
            
            function populateInfractionSanctionsData() {
                infractionSanctionsData = { "": { name: "Neselectat", amendaMin: 0, amendaMax: 0, arestMin: 0, arestMax: 0, punctePenalizare: 0 } }; 
                codPenalEntries.forEach(art => {
                    infractionSanctionsData[art.id] = art;
                });
            }
            
            function populateInfractionDatalist() {
                const datalist = document.getElementById('lista_infractiuni_datalist');
                const verificationDatalist = document.getElementById('lista_articole_verificare');
                
                const populate = (list) => {
                    if (list) {
                        list.innerHTML = ''; // Clear the datalist
                        codPenalEntries.forEach(art => {
                            const option = document.createElement('option');
                            option.value = `${art.numarArticol} - ${art.titlu}`;
                            list.appendChild(option);
                        });
                    }
                };

                populate(datalist);
                populate(verificationDatalist);
            }
            
            function renderCodPenalList() {
                if (!listaArticoleCodPenalDiv) return; 
                listaArticoleCodPenalDiv.innerHTML = ''; 
                if (codPenalEntries.length === 0) {
                    listaArticoleCodPenalDiv.innerHTML = '<p class="text-sm text-gray-500">Niciun articol adăugat încă.</p>';
                    return;
                }
                codPenalEntries.forEach((articol, index) => {
                    const div = document.createElement('div');
                    div.className = 'cod-penal-list-item';
                    div.innerHTML = `
                        <span class="flex-grow"><strong class="text-sky-400">${articol.capitolText} ${articol.numarArticol}</strong> - ${articol.titlu}</span>
                        <div class="actions">
                            <button type="button" data-index="${index}" class="btn-primary-small edit-articol-btn">Modifică</button>
                            <button type="button" data-index="${index}" class="btn-danger delete-articol-btn">Șterge</button>
                        </div>
                    `;
                    listaArticoleCodPenalDiv.appendChild(div);
                });
                 renderIncompatibilitatiCheckboxes(); 
            }
            
            function updateIncompatibilitatiCount() {
                if (!incompatibilitatiListContainer || !incompatibilitatiLabel || !incompatibilitatiCountSpan) return;
                const checkedCount = incompatibilitatiListContainer.querySelectorAll('.incompatibilitate-checkbox:checked').length;
                const text = checkedCount === 1 ? "infracțiune selectată" : "infracțiuni selectate";
                incompatibilitatiCountSpan.textContent = `(${checkedCount} ${text})`;
            }

            function renderIncompatibilitatiCheckboxes(articolCurentId = null, incompatibileExistente = []) {
                if (!incompatibilitatiListContainer) return;
                incompatibilitatiListContainer.innerHTML = ''; 

                if (codPenalEntries.length === 0 || (codPenalEntries.length === 1 && articolCurentId && codPenalEntries[0].id === articolCurentId) ) { 
                    incompatibilitatiListContainer.innerHTML = '<p class="text-xs text-gray-500">Nu există alte articole pentru a seta incompatibilități.</p>';
                    updateIncompatibilitatiCount();
                    return;
                }
                
                let hasOtherArticles = false;
                codPenalEntries.forEach(art => {
                    if (articolCurentId && art.id === articolCurentId) return;
                    hasOtherArticles = true;
                    const label = document.createElement('label');
                    label.className = 'control-label text-xs'; 
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'control-input checkbox-input incompatibilitate-checkbox';
                    checkbox.value = art.id;
                    checkbox.dataset.articleId = art.id;
                    if (incompatibileExistente.includes(art.id)) {
                        checkbox.checked = true;
                    }
                    
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(`${art.numarArticol} - ${art.titlu}`)); 
                    incompatibilitatiListContainer.appendChild(label);
                });
                 if (!hasOtherArticles && !articolCurentId) { 
                    incompatibilitatiListContainer.innerHTML = '<p class="text-xs text-gray-500">Nu există alte articole pentru a seta incompatibilități.</p>';
                }
                updateIncompatibilitatiCount();
            }
            
            function displayPatrolInfo() {
                const patrolDisplay = document.getElementById('patrolDisplay');
                const agentData = JSON.parse(sessionStorage.getItem('patrolData')) || {};
                let patrolText = "";

                if (agentData.AgentOpNume) {
                    patrolText += `${agentData.AgentOpCallSign} - ${agentData.AgentOpGrad} ${agentData.AgentOpNume}<br>`;
                }
                if (agentData.IncludeAgentConst === 'Da' && agentData.AgentConstNume) {
                    patrolText += `${agentData.AgentConstCallSign} - ${agentData.AgentConstGrad} ${agentData.AgentConstNume}<br>`;
                }
                 if (agentData.IncludeAgentAd1 === 'Da' && agentData.AgentAd1Nume) {
                    patrolText += `${agentData.AgentAd1CallSign} - ${agentData.AgentAd1Grad} ${agentData.AgentAd1Nume}<br>`;
                }
                 if (agentData.IncludeAgentAd2 === 'Da' && agentData.AgentAd2Nume) {
                    patrolText += `${agentData.AgentAd2CallSign} - ${agentData.AgentAd2Grad} ${agentData.AgentAd2Nume}<br>`;
                }

                if(patrolText) {
                    patrolDisplay.innerHTML = patrolText;
                     seteazaPatrulaBtn.classList.remove('bg-gray-600');
                     seteazaPatrulaBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                } else {
                    patrolDisplay.innerHTML = "- se va completa la fiecare început de sesiune <br>- o sesiune se încheie când închizi browserul";
                     seteazaPatrulaBtn.classList.add('bg-gray-600');
                     seteazaPatrulaBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                }
            }

            function updateSpeedLimitDisplay() {
                if (!zonaSelect || !limitaVitezaZonaInput) return;
                const selectedStreetName = zonaSelect.value; 
                limitaVitezaZonaInput.value = speedLimits[selectedStreetName] || "N/A"; 
            }
            
            function displayIndividualInfractionFeedback() {
                infractiuneInputs.forEach((input, index) => {
                    const feedbackDiv = document.getElementById(`feedbackInfractiune${index + 1}`);
                    if (!feedbackDiv) return;

                    feedbackDiv.innerHTML = '';
                    const selectedId = input.dataset.selectedId;

                    if (selectedId && infractionSanctionsData[selectedId]) {
                        const art = infractionSanctionsData[selectedId];
                        let feedbackHTML = '';

                        if (art.amendaMin !== undefined && art.amendaMax !== undefined) {
                            if (art.amendaMin === art.amendaMax && art.amendaMin > 0) {
                                feedbackHTML += `<p class="text-green-500">Amendă: ${art.amendaMin}$</p>`;
                            } else if (art.amendaMin !== art.amendaMax && (art.amendaMin > 0 || art.amendaMax > 0)) {
                                feedbackHTML += `<p class="text-green-500">Amendă: ${art.amendaMin}-${art.amendaMax}$</p>`;
                            }
                        }

                        if (art.arestMin !== undefined && art.arestMax !== undefined) {
                            if (art.arestPeViata) {
                                feedbackHTML += `<p class="text-red-400">Arest: ${art.arestMin > 0 ? art.arestMin + ' luni - ' : ''}Pe viață</p>`; 
                            } else if (art.arestMin === art.arestMax && art.arestMin > 0) {
                                feedbackHTML += `<p class="text-red-400">Arest: ${art.arestMin} luni</p>`; 
                            } else if (art.arestMin !== art.arestMax && (art.arestMin > 0 || art.arestMax > 0)) {
                                 feedbackHTML += `<p class="text-red-400">Arest: ${art.arestMin}-${art.arestMax} luni</p>`; 
                            }
                        }

                         if (art.punctePenalizare !== undefined && art.punctePenalizare > 0) {
                            feedbackHTML += `<p class="text-blue-400">Puncte: ${art.punctePenalizare}</p>`;
                        }
                        
                        let sanctionsText = [];
                        if (art.anularePermis) sanctionsText.push(`<span class="text-yellow-400 sanction-word">Anulare Permis</span>`);
                        if (art.ridicareVehicul) sanctionsText.push(`<span class="text-orange-400 sanction-word">Ridicare Vehicul</span>`);
                        if (art.perchezitie) sanctionsText.push(`<span class="text-purple-400 sanction-word">Percheziție</span>`);
                        
                        if (sanctionsText.length > 0) {
                            feedbackHTML += `<div class="flex space-x-2">${sanctionsText.join('')}</div>`;
                        }

                        if (feedbackHTML) {
                            feedbackDiv.innerHTML = feedbackHTML;
                            feedbackDiv.classList.remove('hidden-element');
                        } else {
                            feedbackDiv.classList.add('hidden-element');
                        }
                    } else {
                        feedbackDiv.classList.add('hidden-element');
                    }
                });
            }
            
            function checkInfractionCombos() {
                if (!globalInfractionError) return;
                globalInfractionError.classList.add('hidden-element');
                globalInfractionError.classList.remove('blinking-warning');
                globalInfractionError.textContent = '';
                infractiuneInputs.forEach((_, index) => {
                    const feedbackDiv = document.getElementById(`feedbackInfractiune${index + 1}`);
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = '';
                        feedbackDiv.classList.add('hidden-element');
                    }
                });

                const selections = infractiuneInputs
                    .map(input => input.dataset.selectedId)
                    .filter(id => id);

                let duplicateFound = false;
                let incompatibleComboFound = false;

                if (selections.length >= 2) {
                    const selectionCounts = {};
                    selections.forEach(id => {
                        selectionCounts[id] = (selectionCounts[id] || 0) + 1;
                    });
                    for (const id in selectionCounts) {
                        if (selectionCounts[id] >= 2) {
                            duplicateFound = true;
                            break;
                        }
                    }
                }

                if (duplicateFound) {
                    globalInfractionError.textContent = "Ai selectat aceeași infracțiune de 2 ori!";
                    globalInfractionError.classList.remove('hidden-element');
                    globalInfractionError.classList.add('blinking-warning');
                    return;
                }

                if (selections.length >= 2) {
                    for (let i = 0; i < selections.length; i++) {
                        for (let k = i + 1; k < selections.length; k++) {
                            const inf1_id = selections[i];
                            const inf2_id = selections[k];
                            const inf1_data = infractionSanctionsData[inf1_id];

                            if (inf1_data && inf1_data.incompatibilCu && inf1_data.incompatibilCu.includes(inf2_id)) {
                                incompatibleComboFound = true;
                                break;
                            }
                        }
                        if (incompatibleComboFound) break;
                    }
                }

                if (incompatibleComboFound) {
                    globalInfractionError.textContent = "Nu se poate face combo!";
                    globalInfractionError.classList.remove('hidden-element');
                    globalInfractionError.classList.add('blinking-warning');
                    return;
                }
                displayIndividualInfractionFeedback();
            }
             
            function updateSanctionsTables() {
                let totalAmendaMaxCalc = 0;
                let totalArestMinCalc = 0;
                let totalArestMaxCalc = 0;
                let totalPuncte = 0;
                let arestPeViataGlobal = false;
                let shouldAnnulLicense = false;
                let shouldLiftVehicle = false;
                let shouldSearch = false;

                infractiuneInputs.forEach((inputElement) => {
                    if (!inputElement) return; 
                    const selectedValue = inputElement.dataset.selectedId; 
                    const sanctionData = infractionSanctionsData[selectedValue];

                    if (sanctionData) {
                        totalAmendaMaxCalc += sanctionData.amendaMax || 0;
                        if (sanctionData.arestPeViata) {
                            arestPeViataGlobal = true;
                        }
                        if (!sanctionData.arestPeViata) {
                            totalArestMinCalc += sanctionData.arestMin || 0;
                            totalArestMaxCalc += sanctionData.arestMax || 0;
                        }
                        if (sanctionData.anularePermis) shouldAnnulLicense = true;
                        if(sanctionData.ridicareVehicul) shouldLiftVehicle = true;
                        if (sanctionData.perchezitie) shouldSearch = true;
                        totalPuncte += sanctionData.punctePenalizare || 0;
                    }
                });
                
                amendaTotalaInput.value = totalAmendaMaxCalc;
                arestTotalMinInput.value = arestPeViataGlobal ? 120 : Math.min(120, totalArestMinCalc);
                arestTotalMaxInput.value = arestPeViataGlobal ? 120 : Math.min(120, totalArestMaxCalc);
                anularePermisCheckbox.checked = shouldAnnulLicense;
                punctePermisInput.value = totalPuncte;
                ridicareVehiculCheckbox.checked = shouldLiftVehicle;
                
                perchezitieCheckbox.checked = shouldSearch;
                perchezitieMasuraCheckbox.checked = shouldSearch;
                
                perchezitieContainer.classList.toggle('hidden-element', !perchezitieCheckbox.checked);

                checkInfractionCombos();
                toggleArestDetailsVisibility();
            }
            
            function toggleArestDetailsVisibility() {
                if (locatieDetentieContainer) {
                     const arestValue = parseInt(arestTotalMaxInput.value) || 0;
                     if (arestValue > 0) {
                        locatieDetentieContainer.classList.remove('hidden-element');
                     } else {
                        locatieDetentieContainer.classList.add('hidden-element');
                     }
                }
            }
            
            function resetFormFields() {
                if (procesatorForm) {
                    procesatorForm.reset();
                }

                infractiuneInputs.forEach(input => {
                    delete input.dataset.selectedId;
                    const index = parseInt(input.id.replace('infractiune', '')) - 1;
                    const previewDiv = document.getElementById(`preview_template${index + 1}`);
                    if(previewDiv) previewDiv.innerHTML = '';
                });
                
                const sexMasculinRadio = document.querySelector('input[name="sex"][value="masculin"]');
                if (sexMasculinRadio) sexMasculinRadio.checked = true;
                
                const reclamantSexMasculinRadio = document.querySelector('input[name="sex_reclamant"][value="masculin_reclamant"]');
                if (reclamantSexMasculinRadio) reclamantSexMasculinRadio.checked = true;

                const locatieDetentieSelect = document.getElementById('locatie_detentie');
                if (locatieDetentieSelect) locatieDetentieSelect.value = "Penitenciarul Sandy";
                
                if (martoriContainer) martoriContainer.innerHTML = '';
                martorCounter = 0;
                
                updateDateTimeFields();
                updateSanctionsTables(); 
                validateAllFields();

                if(caseDescriptionOutput) {
                    caseDescriptionOutput.value = '';
                    caseDescriptionOutput.classList.add('hidden-element');
                }
                 if(generatedTitlesOutput) {
                     generatedTitlesOutput.value = '';
                     generatedTitlesOutput.classList.add('hidden-element');
                }

                infractiuneInputs.forEach((_, index) => {
                    const feedbackDiv = document.getElementById(`feedbackInfractiune${index + 1}`);
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = '';
                        feedbackDiv.classList.add('hidden-element');
                    }
                });
                if (globalInfractionError) {
                    globalInfractionError.classList.add('hidden-element');
                    globalInfractionError.textContent = '';
                }
                
                numeReclamantInput.dispatchEvent(new Event('input'));
            }
            
            function backupData(data, fileName) {
                const jsonData = JSON.stringify(data, null, 2); 
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(`Datele au fost salvate în ${fileName}`, true);
            }
            
            function copyToClipboard(text, type) {
                if (!text) {
                    showToast(`Nu există ${type.toLowerCase()} pentru a fi copiat(ă/e).`, false);
                    return;
                }
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; 
                textarea.style.left = '-9999px'; 
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                    const successful = document.execCommand('copy');
                    const msg = successful ? `${type} a/au fost copiat(ă/e) în clipboard!` : `Nu s-a putut copia ${type.toLowerCase()}.`;
                    showToast(msg, successful);
                } catch (err) {
                    console.error(`Eroare la copierea în clipboard (${type}):`, err);
                    showToast(`Eroare la copierea ${type.toLowerCase()}.`, false);
                }
                document.body.removeChild(textarea);
            }

             function adaptTextToGender(text, gender, context = 'suspect') {
                if (context === 'suspect' && gender === 'feminin') {
                    return text
                        .replace(/cetățeanul/gi, 'cetățeanca')
                        .replace(/numitul/gi, 'numita')
                        .replace(/inculpatul/gi, 'inculpata')
                        .replace(/individul/gi, 'individa')
                        .replace(/suspectul/gi, 'suspecta')
                        .replace(/șoferul/gi, 'șoferița')
                        .replace(/pietonul/gi, 'pietoana')
                        .replace(/făptuitorul/gi, 'făptuitoarea')
                        .replace(/acesta/gi, 'aceasta')
                        .replace(/dânsul/gi, 'dânsa')
                        .replace(/\bel\b/gi, 'ea')
                        .replace(/\blui\b/gi, 'ei')
                        .replace(/identificat/gi, 'identificată')
                        .replace(/legitimat/gi, 'legitimată')
                        .replace(/depistat/gi, 'depistată')
                        .replace(/aflat/gi, 'aflată')
                        .replace(/surprins/gi, 'surprinsă')
                        .replace(/sancționat/gi, 'sancționată')
                        .replace(/oprit/gi, 'oprită')
                        .replace(/găsit/gi, 'găsită')
                        .replace(/condus/gi, 'condusă')
                        .replace(/văzut/gi, 'văzută');
                }
                if (context === 'reclamant' && gender === 'feminin_reclamant') {
                    return text
                        .replace(/reclamantul/gi, 'reclamanta')
                        .replace(/martorul/gi, 'martora')
                        .replace(/păgubitul/gi, 'păgubita');
                }
                if (context.startsWith('martor_') && gender === 'feminin') {
                    return text.replace(/martorul/gi, 'martora');
                }
                return text;
            }

            function autoGenerateTemplateFromDefinition(infractionData) {
                const definition = infractionData.definitie.toLowerCase();

                if (infractionData.punctePenalizare > 0 || infractionData.anularePermis || definition.includes('viteză') || definition.includes('conducere') || definition.includes('vehicul') || definition.includes('circulați')) {
                    return `În data de {data_procesare}, în jurul orei {ora_procesare}, cetățeanul/cetățeanca {nume} (CNP {cnp}) a fost surprins/ă de echipajul de poliție în zona {zona_input}, conducând {tip_vehicul_procesator_formatted}, marca {model_vehicul_input} de culoare {culoare_vehicul}, {nr_inmatriculare_text}, în timp ce ${definition}.`;
                }
                if (infractionData.perchezitie || definition.includes('deținere') || definition.includes('droguri') || definition.includes('arme') || definition.includes('contrabandă')) {
                    return `Asupra numitului/ei {nume}, în urma unui control efectuat în zona {zona_input}, s-a constatat că acesta/aceasta ${definition}.`;
                }
                if (definition.includes('violență') || definition.includes('lovire') || definition.includes('agresiune') || definition.includes('amenințare') || definition.includes('vătămare')) {
                    return `Numitul/a {nume} este sancționat/ă pentru faptul că, în zona {zona_input}, a comis fapta de ${definition} asupra victimei {nume_reclamant}.`;
                }

                return `În data de {data_procesare}, ora {ora_procesare}, în zona {zona_input}, numitul/a {nume} a fost sancționat/ă pentru ${definition}.`;
            }

            // Simplified replacePlaceholders to just replace keys with values from data object
            function replacePlaceholders(text, data, forPreview = false) {
                if (typeof text !== 'string') return '';
                let processedText = text;

                const placeholders = text.match(/{[a-zA-Z0-9_]+}/g) || [];

                placeholders.forEach(placeholder => {
                    const key = placeholder.slice(1, -1);
                    const regex = new RegExp(placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                    let valueToInsert = data[key];

                    if (forPreview) {
                         if (valueToInsert === null || valueToInsert === undefined || valueToInsert === '' || (typeof valueToInsert === 'boolean' && !valueToInsert)) {
                            processedText = processedText.replace(regex, `<strong class="text-red-500 font-bold">${placeholder}</strong>`);
                        } else {
                            processedText = processedText.replace(regex, `<strong class="text-green-400 font-bold">${valueToInsert}</strong>`);
                        }
                    } else {
                         processedText = processedText.replace(regex, valueToInsert || '');
                    }
                });

                return processedText;
            }

            // NEW: Function to collect and process all form data, including composite placeholders
            function collectAndProcessFormData() {
                const allData = {};
                const formElements = document.querySelectorAll('#procesatorForm input, #procesatorForm select, #procesatorForm textarea, #data_procesare, #ora_procesare');
                formElements.forEach(el => {
                    const id = el.id || el.name;
                    if (!id) return;
                    if (el.type === 'radio') {
                        if (el.checked) allData[el.name] = el.value;
                    } else if (el.type === 'checkbox') {
                        allData[id] = el.checked;
                    } else {
                        allData[id] = el.value;
                    }
                });

                const patrolData = JSON.parse(sessionStorage.getItem('patrolData')) || {};
                Object.assign(allData, patrolData);

                // Add specific logic for certain simple placeholders that need formatting
                if (allData.autospeciala_select) {
                    const originalValue = allData.autospeciala_select;
                    const lowerValue = originalValue.toLowerCase();
                    if (lowerValue === 'blindata s.a.s.') {
                        allData.autospeciala_select_formatted = 'o blindată S.A.S.';
                        allData.autospeciala_select_genitive = 'blindatei S.A.S.';
                    } else if(lowerValue.includes('s.m.u.r.d.')) {
                        allData.autospeciala_select_formatted = 'o autospecială S.M.U.R.D.';
                        allData.autospeciala_select_genitive = 'autospecialei S.M.U.R.D.';
                    } else if(lowerValue.includes('poliție')) {
                        allData.autospeciala_select_formatted = 'o autospecială de poliție';
                        allData.autospeciala_select_genitive = 'autospecialei de poliție';
                    } else {
                        allData.autospeciala_select_formatted = originalValue;
                        allData.autospeciala_select_genitive = originalValue;
                    }
                } else {
                    allData.autospeciala_select_formatted = '';
                    allData.autospeciala_select_genitive = '';
                }

                if (allData.tip_vehicul_procesator) {
                    allData.tip_vehicul_procesator_formatted = `${getArticleForNoun(allData.tip_vehicul_procesator)} ${allData.tip_vehicul_procesator}`;
                } else {
                    allData.tip_vehicul_procesator_formatted = '';
                }

                // Licenta formatting
                const lipsaLicenta1Select = document.getElementById('lipsa_licenta_1');
                allData.lipsa_licenta_1_text = (lipsaLicenta1Select && lipsaLicenta1Select.selectedIndex > 0) ? lipsaLicenta1Select.options[lipsaLicenta1Select.selectedIndex].text : '';
                const lipsaLicenta2Select = document.getElementById('lipsa_licenta_2');
                allData.lipsa_licenta_2_text = (lipsaLicenta2Select && lipsaLicenta2Select.selectedIndex > 0) ? lipsaLicenta2Select.options[lipsaLicenta2Select.selectedIndex].text : '';


                // --- Composite Placeholder Processing ---
                // nr_inmatriculare
                allData['nr_inmatriculare_text'] = (allData.nr_inmatriculare && allData.nr_inmatriculare.trim() !== '')
                    ? (compositePlaceholderTemplates.nr_inmatriculare_filled || defaultCompositePlaceholderTemplates.nr_inmatriculare_filled).replace('[VALOARE]', allData.nr_inmatriculare.trim())
                    : (compositePlaceholderTemplates.nr_inmatriculare_empty || defaultCompositePlaceholderTemplates.nr_inmatriculare_empty);

                // partea_vatamata_text
                allData['partea_vatamata_text'] = (allData.nume_reclamant && allData.cnp_reclamant)
                    ? (compositePlaceholderTemplates.partea_vatamata_text_filled || defaultCompositePlaceholderTemplates.partea_vatamata_text_filled)
                        .replace('[NUME_RECLAMANT]', allData.nume_reclamant)
                        .replace('[CNP_RECLAMANT]', allData.cnp_reclamant)
                    : (compositePlaceholderTemplates.partea_vatamata_text_empty || defaultCompositePlaceholderTemplates.partea_vatamata_text_empty);

                // martori_text
                const martorEntries = document.querySelectorAll('.martor-entry');
                const martoriData = [];
                martorEntries.forEach((entry) => {
                    const nume = entry.querySelector(`input[id^="nume_martor_"]`).value;
                    const cnp = entry.querySelector(`input[id^="cnp_martor_"]`).value;
                    if (nume || cnp) {
                        martoriData.push({ nume, cnp });
                    }
                });
                allData['martori_text'] = martoriData.length > 0
                    ? martoriData.map(m => (compositePlaceholderTemplates.martori_text_filled_single || defaultCompositePlaceholderTemplates.martori_text_filled_single)
                        .replace('[NUME_MARTOR]', m.nume)
                        .replace('[CNP_MARTOR]', m.cnp)
                    ).join('\n')
                    : (compositePlaceholderTemplates.martori_text_empty || defaultCompositePlaceholderTemplates.martori_text_empty);

                // patrola_text
                const patrolMembers = [];
                if (patrolData.AgentOpNume) patrolMembers.push(`${patrolData.AgentOpGrad} ${patrolData.AgentOpNume}`);
                if (patrolData.IncludeAgentConst === 'Da' && patrolData.AgentConstNume) patrolMembers.push(`${patrolData.AgentConstGrad} ${patrolData.AgentConstNume}`);
                if (patrolData.IncludeAgentAd1 === 'Da' && patrolData.AgentAd1Nume) patrolMembers.push(`${patrolData.AgentAd1Grad} ${patrolData.AgentAd1Nume}`);
                if (patrolData.IncludeAgentAd2 === 'Da' && patrolData.AgentAd2Nume) patrolMembers.push(`${patrolData.AgentAd2Grad} ${patrolData.AgentAd2Nume}`);

                allData['patrola_text'] = patrolMembers.length > 0
                    ? (compositePlaceholderTemplates.patrola_text_filled_members || defaultCompositePlaceholderTemplates.patrola_text_filled_members).replace('[MEMBERS]', patrolMembers.join(', ').replace(/,([^,]*)$/, ' și$1'))
                    : (compositePlaceholderTemplates.patrola_text_empty || defaultCompositePlaceholderTemplates.patrola_text_empty);

                // sanctiuni_lista (elements are built here, then joined)
                let sanctiuniListaArr = [];
                const amendaTotala = document.getElementById('amenda_totala')?.value;
                const arestTotalMin = document.getElementById('arest_total_min')?.value;
                const arestTotalMax = document.getElementById('arest_total_max')?.value;
                const locatieDetentieText = document.getElementById('locatie_detentie')?.options[document.getElementById('locatie_detentie').selectedIndex]?.text;

                if(amendaTotala > 0) sanctiuniListaArr.push((compositePlaceholderTemplates.sanctiuni_amenda || defaultCompositePlaceholderTemplates.sanctiuni_amenda).replace('[VALOARE]', amendaTotala));
                if(arestTotalMax > 0) {
                    sanctiuniListaArr.push((compositePlaceholderTemplates.sanctiuni_arest || defaultCompositePlaceholderTemplates.sanctiuni_arest)
                        .replace('[DURATA]', arestTotalMin === arestTotalMax ? arestTotalMax : `${arestTotalMin}-${arestTotalMax}`)
                        .replace('[LOCATIE]', locatieDetentieText));
                }
                if(document.getElementById('anulare_permis').checked) sanctiuniListaArr.push(compositePlaceholderTemplates.sanctiuni_anulare_permis || defaultCompositePlaceholderTemplates.sanctiuni_anulare_permis);
                if(document.getElementById('ridicare_vehicul').checked) sanctiuniListaArr.push(compositePlaceholderTemplates.sanctiuni_ridicare_vehicul || defaultCompositePlaceholderTemplates.sanctiuni_ridicare_vehicul);
                if(document.getElementById('perchezitie_masura').checked) sanctiuniListaArr.push(compositePlaceholderTemplates.sanctiuni_perchezitie_masura || defaultCompositePlaceholderTemplates.sanctiuni_perchezitie_masura);

                allData['sanctiuni_lista'] = sanctiuniListaArr.length > 0
                    ? sanctiuniListaArr.join('\n')
                    : (compositePlaceholderTemplates.sanctiuni_lista_empty || defaultCompositePlaceholderTemplates.sanctiuni_lista_empty);

                // Perchezitie items
                allData['perchezitie_buzunare_text'] = (allData.perchezitie_buzunare && allData.perchezitie_buzunare.trim() !== '')
                    ? (compositePlaceholderTemplates.perchezitie_buzunare_filled || defaultCompositePlaceholderTemplates.perchezitie_buzunare_filled).replace('[VALOARE]', allData.perchezitie_buzunare.trim())
                    : (compositePlaceholderTemplates.perchezitie_buzunare_empty || defaultCompositePlaceholderTemplates.perchezitie_buzunare_empty);

                allData['perchezitie_torpedo_text'] = (allData.perchezitie_torpedo && allData.perchezitie_torpedo.trim() !== '')
                    ? (compositePlaceholderTemplates.perchezitie_torpedo_filled || defaultCompositePlaceholderTemplates.perchezitie_torpedo_filled).replace('[VALOARE]', allData.perchezitie_torpedo.trim())
                    : (compositePlaceholderTemplates.perchezitie_torpedo_empty || defaultCompositePlaceholderTemplates.perchezitie_torpedo_empty);

                allData['perchezitie_portbagaj_text'] = (allData.perchezitie_portbagaj && allData.perchezitie_portbagaj.trim() !== '')
                    ? (compositePlaceholderTemplates.perchezitie_portbagaj_filled || defaultCompositePlaceholderTemplates.perchezitie_portbagaj_filled).replace('[VALOARE]', allData.perchezitie_portbagaj.trim())
                    : (compositePlaceholderTemplates.perchezitie_portbagaj_empty || defaultCompositePlaceholderTemplates.perchezitie_portbagaj_empty);

                return allData;
            }

            function autoCorrectGrammar(text) {
                if (typeof text !== 'string') return text;
                let correctedText = text;
                correctedText = correctedText.replace(/ *([,;]) */g, '$1 ');
                correctedText = correctedText.charAt(0).toUpperCase() + correctedText.slice(1);
                correctedText = correctedText.replace(/([.!?]\s+)([a-z])/g, (match, p1, p2) => p1 + p2.toUpperCase());
                return correctedText.trim();
            }

            function generateCaseDescription() {
                const loadingIndicator = document.getElementById('caseDescriptionLoading');
                loadingIndicator.classList.remove('hidden-element');
                generatedTitlesOutput.classList.add('hidden-element');
                caseDescriptionOutput.classList.add('hidden-element');

                setTimeout(() => {
                    const allData = collectAndProcessFormData(); // Get all processed data

                    const selectedInfractionIds = infractiuneInputs.map(s => s.dataset.selectedId).filter(v => v);
                    const selectedInfractionsData = selectedInfractionIds.map(id => infractionSanctionsData[id]).filter(Boolean);

                    allData['lista_infractiuni'] = selectedInfractionsData.map(inf => `${inf.numarArticol} - ${inf.titlu}`).join('\n');

                    // --- Build Final Description ---
                    let finalDescription = aiSettings.headerTemplate || defaultAiSettings.headerTemplate;
                    
                    let intro = "\n";
                    const introTemplateKey = `intro_${allData.actiune}`;
                    intro = aiLogicTemplates[introTemplateKey] || defaultAiLogicTemplates[introTemplateKey] || "";
                    finalDescription += `\n\n${intro}`;

                    let infractionDetails = [];
                    selectedInfractionsData.forEach((infractionData, index) => {
                        if (!infractionData) return;
                        let template = infractionData[`modelDescriere${index + 1}`] || autoGenerateTemplateFromDefinition(infractionData);
                        const mentiuniText = document.getElementById(`mentiuni${index + 1}`).value.trim();
                        if (mentiuniText) template += ` ${mentiuniText}`;
                        infractionDetails.push(template);
                    });
                    finalDescription += `\n\n${infractionDetails.join('\n\n')}`;

                    let sanctionsTemplate = aiLogicTemplates.sanctions || defaultAiLogicTemplates.sanctions || "";
                    // The {sanctiuni_lista} placeholder is already processed in collectAndProcessFormData
                    finalDescription += `\n\n${sanctionsTemplate}`;
                    
                    let fullyProcessedText = replacePlaceholders(finalDescription, allData, false);
                    
                    // Adapt gender for main subject
                    fullyProcessedText = adaptTextToGender(fullyProcessedText, allData.sex, 'suspect');
                    
                    // Adapt gender for claimant/victim
                    fullyProcessedText = adaptTextToGender(fullyProcessedText, allData.sex_reclamant, 'reclamant');
                    
                    // Adapt gender for witnesses
                    const martorEntries = document.querySelectorAll('.martor-entry');
                    martorEntries.forEach((entry, index) => {
                        const sexRadio = entry.querySelector(`input[name^="sex_martor_"]:checked`);
                        const sex = sexRadio ? sexRadio.value : 'masculin';
                        fullyProcessedText = adaptTextToGender(fullyProcessedText, sex, `martor_${index+1}`);
                    });

                    fullyProcessedText = autoCorrectGrammar(fullyProcessedText);
                    caseDescriptionOutput.value = fullyProcessedText;
                    
                    // --- Build Title ---
                    selectedInfractionsData.sort((a, b) => (String(b.numarArticol).localeCompare(String(a.numarArticol), undefined, {numeric: true})));
                    
                    let finalTitle = "";
                    if (selectedInfractionsData.length > 0) {
                        const infractionTitles = selectedInfractionsData.map(inf => inf.titlu).join(aiSettings.titleSeparator || defaultAiSettings.titleSeparator);
                        const mainChapter = selectedInfractionsData[0].capitolText;
                        finalTitle = (aiSettings.titleFormat || defaultAiSettings.titleFormat)
                            .replace('{titluri_infractiuni}', infractionTitles)
                            .replace('{capitol_principal}', mainChapter);
                    } else {
                        finalTitle = "Diverse";
                    }
                    generatedTitlesOutput.value = finalTitle;
                    
                    loadingIndicator.classList.add('hidden-element');
                    generatedTitlesOutput.classList.remove('hidden-element');
                    caseDescriptionOutput.classList.remove('hidden-element');
                    showToast('Descrierea infracțiunilor a fost generată!', true);

                }, 500);
            }

            function populatePlaceholdersList() {
                const listContainer = document.getElementById('placeholders-list');
                if (!listContainer) return;

                const keySet = new Set();
                const formElements = document.querySelectorAll('#procesatorForm input[id], #procesatorForm select[id], #procesatorForm textarea[id]');
                formElements.forEach(element => {
                    const id = element.type === 'radio' ? element.name : element.id;
                    if (id) keySet.add(`{${id}}`);
                });

                const modalElements = document.querySelectorAll('#agentiModal input[id], #agentiModal select[id]');
                 modalElements.forEach(element => {
                     if (element.id) keySet.add(`{${element.id}}`);
                });
                
                const conceptualPlaceholders = [
                    'articol_cap', 'articol_numar_input', 'articol_titlu', 'articol_definitie',
                    'model_descriere_1', 'model_descriere_2', 'model_descriere_3',
                    'mentiuni1', 'mentiuni2', 'mentiuni3',
                    'buzunare', 'torpedo', 'portbagaj', 'braconaj',
                    'lista_infractiuni', 'patrola_text', 'partea_vatamata_text', 'martori_text',
                    'nume_martor_1', 'cnp_martor_1', 'nume_martor_2', 'cnp_martor_2',
                    // Add new formatted placeholders that are generated in collectAndProcessFormData
                    'nr_inmatriculare_text', 'tip_vehicul_procesator_formatted', 'autospeciala_select_formatted',
                    'autospeciala_select_genitive', 'lipsa_licenta_1_text', 'lipsa_licenta_2_text',
                    'perchezitie_buzunare_text', 'perchezitie_torpedo_text', 'perchezitie_portbagaj_text',
                    'sanctiuni_lista'
                ];
                conceptualPlaceholders.forEach(p => keySet.add(`{${p}}`));

                listContainer.innerHTML = '';
                Array.from(keySet).sort().forEach(placeholder => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-800 p-2 rounded-md text-center text-sm text-sky-400 font-mono cursor-pointer hover:bg-sky-900 overflow-hidden text-ellipsis whitespace-nowrap';
                    item.textContent = placeholder;
                    item.title = placeholder;
                    item.addEventListener('click', () => copyToClipboard(placeholder, "Placeholder"));
                    listContainer.appendChild(item);
                });
            }
            
            function exportPlaceholdersList() {
                const placeholderDivs = document.querySelectorAll('#placeholders-list > div');
                let textContent = Array.from(placeholderDivs).map(div => div.textContent).join('\n');
                
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'placeholders.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Lista de placeholderi a fost exportată!', true);
            }

            function checkPlaceholderValue() {
                if (!placeholderInput || !placeholderOutput) return;
                const placeholder = placeholderInput.value.trim();
                if (!placeholder.startsWith('{') || !placeholder.endsWith('}')) {
                    placeholderOutput.innerHTML = '<span class="text-red-400">Format invalid</span>';
                    return;
                }
                const key = placeholder.slice(1, -1);
                const allData = collectAndProcessFormData(); // Use the new function
                
                let value = allData[key];
                if (value === undefined) value = '<span class="text-red-400">[N/A]</span>';
                else if (value === '' || value === false) value = '<span class="text-gray-500">[GOL]</span>';
                placeholderOutput.innerHTML = value;
            }

            function displayVerificationDetails(articleId) {
                const detailsContainer = document.getElementById('verificare_articol_details');
                const articleData = infractionSanctionsData[articleId];
                if (!detailsContainer || !articleData) {
                    detailsContainer.classList.add('hidden-element');
                    return;
                }
                detailsContainer.innerHTML = '';
                const definitionP = document.createElement('p');
                definitionP.className = 'font-bold text-white mb-2';
                definitionP.textContent = articleData.definitie;
                detailsContainer.appendChild(definitionP);
                const sanctionsDiv = document.createElement('div');
                sanctionsDiv.className = 'flex flex-col gap-1 text-sm';
                let feedbackHTML = '';
                if (articleData.amendaMin !== undefined && articleData.amendaMax !== undefined) {
                    if (articleData.amendaMin === articleData.amendaMax && articleData.amendaMin > 0) feedbackHTML += `<p class="text-green-400">Amendă: ${articleData.amendaMin}$</p>`;
                    else if (articleData.amendaMin !== articleData.amendaMax && (articleData.amendaMin > 0 || articleData.amendaMax > 0)) feedbackHTML += `<p class="text-green-400">Amendă: ${articleData.amendaMin}-${articleData.amendaMax}$</p>`;
                }
                if (articleData.arestMin !== undefined && articleData.arestMax !== undefined) {
                    if (articleData.arestPeViata) feedbackHTML += `<p class="text-red-400">Arest: ${articleData.arestMin > 0 ? articleData.arestMin + ' luni - ' : ''}Pe viață</p>`;
                    else if (articleData.arestMin === articleData.arestMax && articleData.arestMin > 0) feedbackHTML += `<p class="text-red-400">Arest: ${articleData.arestMin} luni</p>`;
                    else if (articleData.arestMin !== articleData.arestMax && (articleData.arestMin > 0 || articleData.arestMax > 0)) feedbackHTML += `<p class="text-red-400">Arest: ${articleData.arestMin}-${articleData.arestMax} luni</p>`;
                }
                if (articleData.punctePenalizare > 0) feedbackHTML += `<p class="text-blue-400">Puncte: ${articleData.punctePenalizare}</p>`;
                let sanctionsText = [];
                if (articleData.anularePermis) sanctionsText.push("Anulare Permis");
                if (articleData.ridicareVehicul) sanctionsText.push("Ridicare Autovehicul");
                if (articleData.perchezitie) sanctionsText.push("Percheziție Necesara");
                if (sanctionsText.length > 0) feedbackHTML += `<p class="text-yellow-400">Măsuri: ${sanctionsText.join(', ')}</p>`;
                sanctionsDiv.innerHTML = feedbackHTML;
                detailsContainer.appendChild(sanctionsDiv);
                detailsContainer.classList.remove('hidden-element');
            }

            function handleVerification() {
                const inputValue = verificareArticolInput.value;
                const selectedArticle = codPenalEntries.find(art => `${art.numarArticol} - ${art.titlu}` === inputValue);
                if (selectedArticle) displayVerificationDetails(selectedArticle.id);
                else document.getElementById('verificare_articol_details').classList.add('hidden-element');
            }
            
            function loadAndDisplayAiTemplates() {
                const savedTemplates = localStorage.getItem('aiLogicTemplates');
                aiLogicTemplates = savedTemplates ? JSON.parse(savedTemplates) : { ...defaultAiLogicTemplates };
                Object.keys(defaultAiLogicTemplates).forEach(key => {
                    const el = document.getElementById(`template_${key}`);
                    if (el) el.value = aiLogicTemplates[key] || defaultAiLogicTemplates[key];
                });
            }
            
            function saveAiTemplates() {
                Object.keys(defaultAiLogicTemplates).forEach(key => {
                    const el = document.getElementById(`template_${key}`);
                    if (el) aiLogicTemplates[key] = el.value;
                });
                localStorage.setItem('aiLogicTemplates', JSON.stringify(aiLogicTemplates));
                showToast("Șabloanele de bază au fost salvate!", true);
            }

            function loadAiSettings() {
                const savedSettings = localStorage.getItem('aiSettings');
                aiSettings = savedSettings ? JSON.parse(savedSettings) : { ...defaultAiSettings };
                const headerTemplateTextarea = document.getElementById('template_header');
                if(headerTemplateTextarea) {
                    headerTemplateTextarea.value = aiSettings.headerTemplate || defaultAiSettings.headerTemplate;
                }
            }

            function saveAiSettings() {
                aiSettings.prompt = document.getElementById('ai_prompt_instructions').value;
                aiSettings.titleSeparator = document.getElementById('title_separator_input').value;
                aiSettings.titleFormat = document.getElementById('title_format_input').value;
                aiSettings.headerTemplate = document.getElementById('composite_header_template').value;
                localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
                loadAiSettings(); // Re-load to update the disabled textarea
                showToast("Setările avansate au fost salvate!", true);
            }

            // NEW: Load and Save functions for Composite Placeholders
            function loadCompositePlaceholderTemplates() {
                const savedTemplates = localStorage.getItem('compositePlaceholderTemplates');
                compositePlaceholderTemplates = savedTemplates ? JSON.parse(savedTemplates) : { ...defaultCompositePlaceholderTemplates };

                Object.keys(defaultCompositePlaceholderTemplates).forEach(key => {
                    const el = document.getElementById(`composite_${key}`);
                    if (el) {
                        el.value = compositePlaceholderTemplates[key] || defaultCompositePlaceholderTemplates[key];
                    }
                });
            }

            function saveCompositePlaceholderTemplates() {
                Object.keys(defaultCompositePlaceholderTemplates).forEach(key => {
                    const el = document.getElementById(`composite_${key}`);
                    if (el) {
                        compositePlaceholderTemplates[key] = el.value;
                    }
                });
                localStorage.setItem('compositePlaceholderTemplates', JSON.stringify(compositePlaceholderTemplates));
                showToast("Șabloanele placeholderilor compuși au fost salvate!", true);
            }

            function getContrastColor(hexcolor) {
                if(hexcolor.slice(0, 1) === '#') hexcolor = hexcolor.slice(1);
                const r = parseInt(hexcolor.substr(0, 2), 16);
                const g = parseInt(hexcolor.substr(2, 2), 16);
                const b = parseInt(hexcolor.substr(4, 2), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#0D1117' : '#C9D1D9';
            }

            function applyCustomColors() {
                const savedColors = JSON.parse(localStorage.getItem('appColors')) || {};
                Object.keys(defaultColors).forEach(key => {
                    const color = savedColors[key] || defaultColors[key];
                    document.documentElement.style.setProperty(`--color-${key}`, color);
                    const colorPicker = document.getElementById(`color-${key}`);
                    if(colorPicker) colorPicker.value = color;
                    if(key === 'background' || key === 'card-background' || key === 'modal-background') {
                        document.documentElement.style.setProperty('--color-text', getContrastColor(color));
                    }
                });
            }

            function saveColorSetting(key, value) {
                const savedColors = JSON.parse(localStorage.getItem('appColors')) || {};
                savedColors[key] = value;
                localStorage.setItem('appColors', JSON.stringify(savedColors));
            }

            function resetColorsToDefault() {
                 if (confirm('Sunteți sigur că doriți să resetați toate culorile la valorile implicite?')) {
                    localStorage.removeItem('appColors');
                    applyCustomColors();
                    showToast('Culorile au fost resetate.', true);
                 }
            }

            function preventInvalidNumberInput(event) {
                if (['e', 'E', '+', '-', '.'].includes(event.key)) event.preventDefault();
            }

            function validateField(field) {
                if (!field || !field.id || field.classList.contains('input-field-readonly') || field.classList.contains('always-blue') || field.classList.contains('no-validation')) return;
                const isOptional = ['nume_reclamant', 'cnp_reclamant', 'nr_inmatriculare'].includes(field.id) || field.id.startsWith('infractiune2') || field.id.startsWith('infractiune3') || field.id.startsWith('mentiuni');
                if (field.value.trim() !== '') {
                    field.classList.add('completed');
                    field.classList.remove('incomplete');
                } else {
                    field.classList.remove('completed');
                    if (!isOptional) field.classList.add('incomplete');
                    else field.classList.remove('incomplete');
                }
            }

            function validateAllFields() {
                document.querySelectorAll('#procesatorForm .input-field, #procesatorForm .select-field, #procesatorForm .textarea-field').forEach(field => validateField(field));
            }
            
            function handleInfractionInput(event) {
                const input = event.target;
                const foundArticle = codPenalEntries.find(art => `${art.numarArticol} - ${art.titlu}` === input.value);
                input.dataset.selectedId = foundArticle ? foundArticle.id : '';
                updateAllPreviews();
                updateSanctionsTables();
            }

            function updateAllPreviews() {
                const allData = collectAndProcessFormData(); // Use the new function to get processed data
                infractiuneInputs.forEach((input, index) => {
                    const previewDiv = document.getElementById(`preview_template${index + 1}`);
                    const selectedId = input.dataset.selectedId;
                    if (selectedId && infractionSanctionsData[selectedId]) {
                        const art = infractionSanctionsData[selectedId];
                        let template = art[`modelDescriere${index + 1}`] || autoGenerateTemplateFromDefinition(art);
                        previewDiv.innerHTML = replacePlaceholders(template, allData, true); // Pass allData and true for preview
                    } else {
                        previewDiv.innerHTML = '';
                    }
                });
            }
            
            function addWitnessField() {
                martorCounter++;
                const div = document.createElement('div');
                div.className = 'martor-entry p-3 border border-dashed border-gray-600/50 rounded-lg relative';
                div.id = `martor_entry_${martorCounter}`;
                div.innerHTML = `
                    <button type="button" class="absolute top-1 right-1 btn-danger !p-0 !text-xs h-6 w-6 rounded-full flex items-center justify-center delete-martor-btn" title="Șterge Martor">&times;</button>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="nume_martor_${martorCounter}" class="label-text text-xs">Nume Martor ${martorCounter}:</label>
                            <div class="input-group"><i class="fa-solid fa-user"></i><input type="text" id="nume_martor_${martorCounter}" class="input-field no-validation" placeholder="Numele martorului"></div>
                        </div>
                        <div>
                            <label for="cnp_martor_${martorCounter}" class="label-text text-xs">CNP Martor ${martorCounter}:</label>
                            <div class="input-group"><i class="fa-solid fa-id-card"></i><input type="number" id="cnp_martor_${martorCounter}" class="input-field no-validation" placeholder="CNP-ul martorului" min="0"></div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="label-text text-xs">Sex Martor ${martorCounter}:</label>
                        <div class="control-group mt-1">
                            <label class="control-label"><input type="radio" name="sex_martor_${martorCounter}" value="masculin" class="control-input radio-input" checked> Masculin</label>
                            <label class="control-label"><input type="radio" name="sex_martor_${martorCounter}" value="feminin" class="control-input radio-input"> Feminin</label>
                        </div>
                    </div>`;
                martoriContainer.appendChild(div);
                div.querySelector('.delete-martor-btn').addEventListener('click', () => div.remove());
            }

            function loadGhidContent() {
                const savedGhidHTML = localStorage.getItem('ghidContentHTML');
                if (tutorialContentContainer) {
                    tutorialContentContainer.innerHTML = savedGhidHTML || defaultGhidHTML;
                }
            }

            function formatDoc(cmd, value = null) {
                if (cmd === 'foreColor' && value) {
                    document.execCommand(cmd, false, value);
                } else {
                    document.execCommand(cmd, false, null);
                }
                ghidEditor.focus();
            }

            // --- Event Listeners Setup ---
            mainTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    mainTabButtons.forEach(btn => btn.classList.remove('active'));
                    mainTabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab)?.classList.add('active');
                });
            });

            document.querySelectorAll('.sub-tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const container = button.closest('.sub-tab-container');
                    container.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const parentContent = button.closest('.tab-content');
                    parentContent.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(button.dataset.subtab)?.classList.add('active');
                });
            });

            document.querySelectorAll('input[name="actiune"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    document.getElementById('jaf_box').classList.toggle('hidden-element', radio.value !== 'alarma_jaf');
                    [substantaCheckbox, perchezitieCheckbox, crimaOrganizataCheckbox, licenteCheckbox].forEach(cb => { cb.checked = false; });
                    switch (radio.value) {
                        case 'razie_mineriada': licenteCheckbox.checked = true; break;
                        case 'razie_main':
                        case 'detectie_focuri_arma': perchezitieCheckbox.checked = true; break;
                        case 'razie_rutiera': substantaCheckbox.checked = true; break;
                    }
                    [substantaCheckbox, perchezitieCheckbox, crimaOrganizataCheckbox, licenteCheckbox].forEach(cb => cb.dispatchEvent(new Event('change')));
                });
            });
            
            if (adaugaMartorBtn) adaugaMartorBtn.addEventListener('click', addWitnessField);

            seteazaPatrulaBtn.addEventListener('click', () => {
                const agentData = JSON.parse(sessionStorage.getItem('patrolData')) || {};
                Object.keys(agentData).forEach(key => {
                    const el = document.getElementById(key.replace(/([A-Z])/g, '_$1').toLowerCase() + '_modal');
                    if(el) {
                        if(el.type === 'checkbox') el.checked = (agentData[key] === 'Da');
                        else el.value = agentData[key] || '';
                    }
                });
                agentiModal.classList.remove('hidden-element');
            });

            salveazaAgentiModalBtn.addEventListener('click', () => {
                const patrolData = {
                    AgentOpCallSign: document.getElementById('agent_op_call_sign_modal').value.trim(),
                    AgentOpGrad: document.getElementById('agent_op_grad_modal').value,
                    AgentOpNume: document.getElementById('agent_op_nume_modal').value.trim(),
                    AgentConstCallSign: document.getElementById('agent_const_call_sign_modal').value.trim(),
                    AgentConstGrad: document.getElementById('agent_const_grad_modal').value,
                    AgentConstNume: document.getElementById('agent_const_nume_modal').value.trim(),
                    IncludeAgentConst: document.getElementById('include_agent_const_checkbox_modal').checked ? 'Da' : 'Nu',
                    AgentAd1CallSign: document.getElementById('agent_ad1_call_sign_modal').value.trim(),
                    AgentAd1Grad: document.getElementById('agent_ad1_grad_modal').value,
                    AgentAd1Nume: document.getElementById('agent_ad1_nume_modal').value.trim(),
                    IncludeAgentAd1: document.getElementById('include_agent_ad1_checkbox_modal').checked ? 'Da' : 'Nu',
                    AgentAd2CallSign: document.getElementById('agent_ad2_call_sign_modal').value.trim(),
                    AgentAd2Grad: document.getElementById('agent_ad2_grad_modal').value,
                    AgentAd2Nume: document.getElementById('agent_ad2_nume_modal').value.trim(),
                    IncludeAgentAd2: document.getElementById('include_agent_ad2_checkbox_modal').checked ? 'Da' : 'Nu',
                };
                sessionStorage.setItem('patrolData', JSON.stringify(patrolData));
                agentiModal.classList.add('hidden-element');
                showToast('Datele patrulei au fost salvate pentru această sesiune.', true);
                displayPatrolInfo();
            });
            
            anuleazaAgentiModalBtn.addEventListener('click', () => agentiModal.classList.add('hidden-element'));
            closeAgentiModalBtn.addEventListener('click', () => agentiModal.classList.add('hidden-element'));
            
            resetFormBtn.addEventListener('click', resetFormFields);
            copyDescriptionBtn.addEventListener('click', () => copyToClipboard(caseDescriptionOutput.value, "Descrierea"));
            copyTitlesBtn.addEventListener('click', () => copyToClipboard(generatedTitlesOutput.value, "Titlurile"));
            zonaSelect.addEventListener('input', updateSpeedLimitDisplay); 
            arestTotalMaxInput.addEventListener('input', toggleArestDetailsVisibility);
            infractiuneInputs.forEach(input => input?.addEventListener('input', handleInfractionInput));
            generateCaseDescriptionBtn.addEventListener('click', generateCaseDescription);
            if(actualizeazaDateTimeBtn) actualizeazaDateTimeBtn.addEventListener('click', updateDateTimeFields);
            if (verificareArticolInput) verificareArticolInput.addEventListener('input', handleVerification);
            if(placeholderInput) placeholderInput.addEventListener('input', checkPlaceholderValue);
            if (exportPlaceholdersBtn) exportPlaceholdersBtn.addEventListener('click', exportPlaceholdersList);
            if (saveAiLogicBtn) saveAiLogicBtn.addEventListener('click', saveAiTemplates);
            if (aiSettingsBtn) aiSettingsBtn.addEventListener('click', () => {
                document.getElementById('ai_prompt_instructions').value = aiSettings.prompt || defaultAiSettings.prompt;
                document.getElementById('title_separator_input').value = aiSettings.titleSeparator || defaultAiSettings.titleSeparator;
                document.getElementById('title_format_input').value = aiSettings.titleFormat || defaultAiSettings.titleFormat;
                document.getElementById('composite_header_template').value = aiSettings.headerTemplate || defaultAiSettings.headerTemplate;
                aiSettingsModal.classList.remove('hidden-element');
            });
            if (salveazaAiSettingsModalBtn) salveazaAiSettingsModalBtn.addEventListener('click', () => {
                saveAiSettings();
                aiSettingsModal.classList.add('hidden-element');
            });
            if (anuleazaAiSettingsModalBtn) anuleazaAiSettingsModalBtn.addEventListener('click', () => aiSettingsModal.classList.add('hidden-element'));
            if (closeAiSettingsModalBtn) closeAiSettingsModalBtn.addEventListener('click', () => aiSettingsModal.classList.add('hidden-element'));
            
            if (editGhidBtn) editGhidBtn.addEventListener('click', () => {
                ghidEditor.innerHTML = tutorialContentContainer.innerHTML;
                ghidModal.classList.remove('hidden-element');
            });
            if (salveazaGhidModalBtn) salveazaGhidModalBtn.addEventListener('click', () => {
                const newGhidHTML = ghidEditor.innerHTML;
                tutorialContentContainer.innerHTML = newGhidHTML;
                localStorage.setItem('ghidContentHTML', newGhidHTML);
                ghidModal.classList.add('hidden-element');
                showToast('Ghidul a fost salvat cu succes!', true);
            });
            if (closeGhidModalBtn) closeGhidModalBtn.addEventListener('click', () => ghidModal.classList.add('hidden-element'));
            if (anuleazaGhidModalBtn) anuleazaGhidModalBtn.addEventListener('click', () => ghidModal.classList.add('hidden-element'));
            if (ghidEditorToolbar) {
                ghidEditorToolbar.querySelectorAll('.toolbar-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        formatDoc(e.currentTarget.dataset.command);
                    });
                });
                const colorInput = document.getElementById('ghidFontColor');
                if(colorInput) {
                    colorInput.addEventListener('input', (e) => {
                        formatDoc('foreColor', e.target.value);
                    });
                }
            }

            document.querySelectorAll('#aspect_subtab input[type="color"]').forEach(picker => {
                picker.addEventListener('input', (event) => {
                    const colorVar = event.target.dataset.colorVar;
                    saveColorSetting(colorVar, event.target.value);
                    applyCustomColors();
                });
            });

            const resetColorsBtn = document.getElementById('resetColorsBtn');
            if (resetColorsBtn) resetColorsBtn.addEventListener('click', resetColorsToDefault);
            
            if(articolArestPeViataCheckbox) {
                articolArestPeViataCheckbox.addEventListener('change', function() {
                    if(articolArestMaxInput) {
                        articolArestMaxInput.disabled = this.checked;
                        if(this.checked) articolArestMaxInput.value = '';
                    }
                });
            }

            // NOU: Event listeners pentru modalul de placeholders compusi
            if (showCompositePlaceholdersBtn) {
                showCompositePlaceholdersBtn.addEventListener('click', () => {
                    loadCompositePlaceholderTemplates(); // Load data when opening
                    if (compositePlaceholdersModal) compositePlaceholdersModal.classList.remove('hidden-element');
                });
            }
            if (closeCompositePlaceholdersModalBtn) {
                closeCompositePlaceholdersModalBtn.addEventListener('click', () => {
                    if (compositePlaceholdersModal) compositePlaceholdersModal.classList.add('hidden-element');
                });
            }
            if (salveazaCompositePlaceholdersBtn) { // NEW: Save button for composite placeholders
                salveazaCompositePlaceholdersBtn.addEventListener('click', () => {
                    saveCompositePlaceholderTemplates();
                    if (compositePlaceholdersModal) compositePlaceholdersModal.classList.add('hidden-element');
                });
            }
            if (anuleazaCompositePlaceholdersBtn) { // NEW: Cancel button for composite placeholders
                anuleazaCompositePlaceholdersBtn.addEventListener('click', () => {
                    if (compositePlaceholdersModal) compositePlaceholdersModal.classList.add('hidden-element');
                });
            }


            codPenalForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const capitolText = document.getElementById('articol_cap').value.trim();
                const numarArticol = document.getElementById('articol_numar_input').value.trim();
                const titlu = document.getElementById('articol_titlu').value.trim();
                const definitie = document.getElementById('articol_definitie').value.trim();
                if (!capitolText || !numarArticol || !titlu || !definitie) {
                    showToast("Toate câmpurile principale ale articolului sunt obligatorii!", false);
                    return;
                }
                const amendaMin = parseInt(document.getElementById('articol_amenda_min').value) || 0;
                const arestPeViata = document.getElementById('articol_arest_pe_viata').checked;
                const articleData = { 
                    capitolText, numarArticol, titlu, definitie, amendaMin, 
                    amendaMax: parseInt(document.getElementById('articol_amenda_max').value) || amendaMin,
                    arestMin: parseInt(document.getElementById('articol_arest_min').value) || 0,
                    arestMax: arestPeViata ? 999 : (parseInt(document.getElementById('articol_arest_max').value) || (parseInt(document.getElementById('articol_arest_min').value) || 0)),
                    arestPeViata, 
                    punctePenalizare: parseInt(document.getElementById('articol_puncte_permis').value) || 0,
                    anularePermis: document.getElementById('articol_anulare_permis').checked,
                    ridicareVehicul: document.getElementById('articol_ridicare_vehicul').checked,
                    perchezitie: document.getElementById('articol_perchezitie').checked,
                    modelDescriere1: document.getElementById('articol_model_descriere_1').value.trim(),
                    modelDescriere2: document.getElementById('articol_model_descriere_2').value.trim(),
                    modelDescriere3: document.getElementById('articol_model_descriere_3').value.trim(),
                    incompatibilCu: Array.from(document.querySelectorAll('.incompatibilitate-checkbox:checked')).map(cb => cb.value)
                };
                const currentId = (editingCodPenalIndex !== null) ? codPenalEntries[editingCodPenalIndex].id : generateArticleId(capitolText, numarArticol, titlu);
                articleData.id = currentId;
                if (editingCodPenalIndex !== null) { 
                    codPenalEntries[editingCodPenalIndex] = articleData;
                } else { 
                    if (codPenalEntries.some(art => art.id === articleData.id)) {
                        showToast("Un articol cu acest ID există deja!", false);
                        return;
                    }
                    codPenalEntries.push(articleData);
                }
                codPenalEntries.forEach(otherArt => {
                    if (otherArt.id === currentId) return; 
                    const indexToRemove = otherArt.incompatibilCu.indexOf(currentId);
                    if (articleData.incompatibilCu.includes(otherArt.id)) {
                        if (indexToRemove === -1) otherArt.incompatibilCu.push(currentId);
                    } else { 
                        if (indexToRemove > -1) otherArt.incompatibilCu.splice(indexToRemove, 1);
                    }
                });
                editingCodPenalIndex = null;
                document.getElementById('salveazaArticolBtn').textContent = "Salvează Articol";
                document.getElementById('salveazaArticolBtn').classList.remove('btn-edit-mode');
                localStorage.setItem('codPenalData', JSON.stringify(codPenalEntries)); 
                populateInfractionSanctionsData(); 
                populateInfractionDatalist(); 
                renderCodPenalList(); 
                codPenalForm.reset(); 
                articolArestMaxInput.disabled = false;
                renderIncompatibilitatiCheckboxes(); 
                showToast("Articol salvat!", true);
            });

             listaArticoleCodPenalDiv.addEventListener('click', function(event) {
                const target = event.target;
                if (target.classList.contains('delete-articol-btn')) {
                    const index = parseInt(target.dataset.index);
                    if (confirm(`Sigur doriți să ștergeți articolul?`)) { 
                        const deletedId = codPenalEntries[index].id;
                        codPenalEntries.splice(index, 1);
                        codPenalEntries.forEach(art => {
                            const idx = art.incompatibilCu.indexOf(deletedId);
                            if (idx > -1) art.incompatibilCu.splice(idx, 1);
                        });
                        localStorage.setItem('codPenalData', JSON.stringify(codPenalEntries)); 
                        populateInfractionSanctionsData();
                        populateInfractionDatalist();
                        renderCodPenalList();
                        renderIncompatibilitatiCheckboxes(); 
                    }
                }
                if (target.classList.contains('edit-articol-btn')) {
                    const index = parseInt(target.dataset.index);
                    const art = codPenalEntries[index];
                    Object.keys(art).forEach(key => {
                        const el = document.getElementById(`articol_${key.replace(/([A-Z])/g, '_$1').toLowerCase()}`);
                        if(el) {
                            if(el.type === 'checkbox') el.checked = art[key];
                            else el.value = art[key] || '';
                        }
                    });
                    document.getElementById('articol_cap').value = art.capitolText;
                    document.getElementById('articol_numar_input').value = art.numarArticol;
                    document.getElementById('articol_arest_max').value = art.arestPeViata ? '' : art.arestMax;
                    articolArestMaxInput.disabled = art.arestPeViata;
                    editingCodPenalIndex = index;
                    document.getElementById('salveazaArticolBtn').textContent = "Salvează Modificări";
                    document.getElementById('salveazaArticolBtn').classList.add('btn-edit-mode');
                    renderIncompatibilitatiCheckboxes(art.id, art.incompatibilCu || []); 
                }
            });
            
            addSpeedLimitBtn.addEventListener('click', () => {
                const streetName = streetNameSettingsInput.value.trim();
                const speedLimit = speedLimitSettingsInput.value.trim();
                if (!streetName || !speedLimit) {
                    showToast("Ambele câmpuri sunt obligatorii.", false);
                    return;
                }
                const streetId = streetName.toLowerCase().replace(/\s+/g, '_');
                if (editingSpeedLimitIndex !== null) {
                    streetSpeedLimitsData[editingSpeedLimitIndex] = { id: streetId, name: streetName, limit: speedLimit };
                    editingSpeedLimitIndex = null;
                    addSpeedLimitBtn.textContent = "Adaugă Limită";
                } else {
                    if (streetSpeedLimitsData.some(item => item.id === streetId)) {
                        showToast("O stradă cu acest nume există deja!", false);
                        return;
                    }
                    streetSpeedLimitsData.push({ id: streetId, name: streetName, limit: speedLimit });
                }
                streetNameSettingsInput.value = '';
                speedLimitSettingsInput.value = '';
                renderSpeedLimitsList();
                localStorage.setItem('streetSpeedLimitsData', JSON.stringify(streetSpeedLimitsData)); 
                showToast("Limită de viteză salvată.", true);
            });

            speedLimitListUL.addEventListener('click', (event) => {
                const target = event.target;
                const index = parseInt(target.dataset.index);
                if (target.classList.contains('delete-speed-limit-btn')) {
                    streetSpeedLimitsData.splice(index, 1);
                    renderSpeedLimitsList();
                    localStorage.setItem('streetSpeedLimitsData', JSON.stringify(streetSpeedLimitsData)); 
                }
                if (target.classList.contains('edit-speed-limit-btn')) {
                    const itemToEdit = streetSpeedLimitsData[index];
                    streetNameSettingsInput.value = itemToEdit.name;
                    speedLimitSettingsInput.value = itemToEdit.limit;
                    editingSpeedLimitIndex = index;
                    addSpeedLimitBtn.textContent = "Salvează Modificări";
                }
            });

            addCustomVehicleBtn.addEventListener('click', () => {
                const modelName = vehicleModelSettingsInput.value.trim();
                const vehicleType = vehicleTypeSettingsSelect.value;
                if (!modelName || !vehicleType) {
                    showToast("Ambele câmpuri sunt obligatorii.", false);
                    return;
                }
                const modelId = `${vehicleType}_${modelName.toLowerCase().replace(/\s+/g, '_')}`;
                if (editingVehicleIndex !== null) {
                    customVehicleModels[editingVehicleIndex] = { id: modelId, name: modelName, type: vehicleType };
                    editingVehicleIndex = null;
                    addCustomVehicleBtn.textContent = "Adaugă Vehicul";
                } else {
                    if (customVehicleModels.some(model => model.id === modelId)) {
                        showToast("Acest model există deja!", false);
                        return; 
                    }
                    customVehicleModels.push({ id: modelId, name: modelName, type: vehicleType });
                }
                vehicleModelSettingsInput.value = '';
                renderCustomVehicleList();
                localStorage.setItem('customVehicleModels', JSON.stringify(customVehicleModels));
                showToast("Vehicul salvat.", true); 
            });

            customVehicleListUL.addEventListener('click', (event) => {
                const target = event.target;
                const index = parseInt(target.dataset.index);
                if (target.classList.contains('delete-vehicle-btn')) {
                    customVehicleModels.splice(index, 1);
                    renderCustomVehicleList();
                    localStorage.setItem('customVehicleModels', JSON.stringify(customVehicleModels)); 
                }
                if (target.classList.contains('edit-vehicle-btn')) {
                    const vehicleToEdit = customVehicleModels[index];
                    vehicleModelSettingsInput.value = vehicleToEdit.name;
                    vehicleTypeSettingsSelect.value = vehicleToEdit.type;
                    editingVehicleIndex = index;
                    addCustomVehicleBtn.textContent = "Salvează Modificări";
                }
            });

            editeazaDescrieriBtn.addEventListener('click', () => {
                const art = (editingCodPenalIndex !== null) ? codPenalEntries[editingCodPenalIndex] : {};
                modalDescriere1.value = art.modelDescriere1 || document.getElementById('articol_model_descriere_1').value;
                modalDescriere2.value = art.modelDescriere2 || document.getElementById('articol_model_descriere_2').value;
                modalDescriere3.value = art.modelDescriere3 || document.getElementById('articol_model_descriere_3').value;
                descrieriModal.classList.remove('hidden-element');
            });
            
            salveazaDescrieriModalBtn.addEventListener('click', () => {
                const descs = {
                    modelDescriere1: modalDescriere1.value,
                    modelDescriere2: modalDescriere2.value,
                    modelDescriere3: modalDescriere3.value
                };
                document.getElementById('articol_model_descriere_1').value = descs.modelDescriere1;
                document.getElementById('articol_model_descriere_2').value = descs.modelDescriere2;
                document.getElementById('articol_model_descriere_3').value = descs.modelDescriere3;
                if (editingCodPenalIndex !== null) Object.assign(codPenalEntries[editingCodPenalIndex], descs);
                descrieriModal.classList.add('hidden-element');
                showToast('Descrierile au fost actualizate temporar.', true);
            });

            anuleazaDescrieriModalBtn.addEventListener('click', () => descrieriModal.classList.add('hidden-element'));
            closeDescrieriModalBtn.addEventListener('click', () => descrieriModal.classList.add('hidden-element'));

            exportAllSettingsBtn.addEventListener('click', () => {
                const allSettingsData = {
                    codPenal: codPenalEntries,
                    vehicule: customVehicleModels,
                    limiteViteza: streetSpeedLimitsData,
                    aiLogic: aiLogicTemplates,
                    aiSettings: aiSettings,
                    colors: JSON.parse(localStorage.getItem('appColors')) || {},
                    ghidHTML: localStorage.getItem('ghidContentHTML') || tutorialContentContainer.innerHTML,
                    compositePlaceholders: compositePlaceholderTemplates // NEW: Include composite placeholders
                };
                backupData(allSettingsData, 'mdt_data.txt'); 
            });
            importAllSettingsFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.codPenal && importedData.vehicule && importedData.limiteViteza) {
                            codPenalEntries = preprocessCodPenalData(importedData.codPenal);
                            customVehicleModels = importedData.vehicule;
                            streetSpeedLimitsData = importedData.limiteViteza;
                            aiLogicTemplates = importedData.aiLogic || { ...defaultAiLogicTemplates };
                            aiSettings = importedData.aiSettings || { ...defaultAiSettings };
                            compositePlaceholderTemplates = importedData.compositePlaceholders || { ...defaultCompositePlaceholderTemplates }; // NEW: Load composite placeholders
                            
                            localStorage.setItem('codPenalData', JSON.stringify(codPenalEntries));
                            localStorage.setItem('customVehicleModels', JSON.stringify(customVehicleModels));
                            localStorage.setItem('streetSpeedLimitsData', JSON.stringify(streetSpeedLimitsData));
                            localStorage.setItem('aiLogicTemplates', JSON.stringify(aiLogicTemplates));
                            localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
                            localStorage.setItem('compositePlaceholderTemplates', JSON.stringify(compositePlaceholderTemplates)); // NEW: Save composite placeholders
                            
                            if (importedData.colors) localStorage.setItem('appColors', JSON.stringify(importedData.colors));
                            else localStorage.removeItem('appColors');
                            
                            if (importedData.ghidHTML) {
                                localStorage.setItem('ghidContentHTML', importedData.ghidHTML);
                            }
                            
                            // Re-render everything
                            applyCustomColors();
                            loadAndDisplayAiTemplates();
                            loadAiSettings();
                            loadGhidContent();
                            loadCompositePlaceholderTemplates(); // NEW: Load composite placeholders
                            populatePlaceholdersList();
                            populateInfractionSanctionsData();
                            populateInfractionDatalist();
                            renderCodPenalList();
                            renderCustomVehicleList();
                            renderSpeedLimitsList();
                            showToast('Fișierul a fost încărcat cu succes!', true);
                            document.getElementById('importAllSettingsLabel').classList.add('bg-cyan-600', 'hover:bg-cyan-700');
                        } else { showToast('Format de fișier invalid.', false); }
                    } catch (error) { showToast('Eroare la parsarea fișierului.', false); }
                    event.target.value = null; 
                };
                reader.readAsText(file);
            });

            licenteCheckbox.addEventListener('change', () => licenteContainer.classList.toggle('hidden-element', !licenteCheckbox.checked));
            crimaOrganizataCheckbox.addEventListener('change', () => crimaOrganizataContainer.classList.toggle('hidden-element', !crimaOrganizataCheckbox.checked));
            perchezitieCheckbox.addEventListener('change', () => {
                 perchezitieContainer.classList.toggle('hidden-element', !perchezitieCheckbox.checked);
                 perchezitieMasuraCheckbox.checked = perchezitieCheckbox.checked;
            });
            substantaCheckbox.addEventListener('change', () => substantaContainer.classList.toggle('hidden-element', !substantaCheckbox.checked));
            tipVehiculProcesatorSelect.addEventListener('change', filterVehicleModels);
            
            // --- Initialization ---
            const savedCodPenal = localStorage.getItem('codPenalData');
            if (savedCodPenal) try { codPenalEntries = preprocessCodPenalData(JSON.parse(savedCodPenal)); } catch (e) { console.error(e); }
            const savedVehicles = localStorage.getItem('customVehicleModels');
            if (savedVehicles) try { customVehicleModels = JSON.parse(savedVehicles); } catch (e) { console.error(e); }
            const savedSpeedLimits = localStorage.getItem('streetSpeedLimitsData');
            if (savedSpeedLimits) try { streetSpeedLimitsData = JSON.parse(savedSpeedLimits); } catch (e) { console.error(e); }
            
            applyCustomColors();
            loadAndDisplayAiTemplates();
            loadAiSettings();
            loadGhidContent();
            loadCompositePlaceholderTemplates(); // NEW: Load composite placeholders
            populatePlaceholdersList();
            populateInfractionSanctionsData(); 
            populateInfractionDatalist(); 
            renderCustomVehicleList(); 
            renderCodPenalList(); 
            renderSpeedLimitsList(); 
            updateDateTimeFields();
            updateSanctionsTables();
            displayPatrolInfo();

            // Numeric input validation
            const integerOnlyFields = [
                'cnp', 'cnp_reclamant', 'tigari_contrabanda', 'bani_murdari',
                'viteza_inregistrata', 'articol_puncte_permis',
                'articol_amenda_min', 'articol_amenda_max', 'articol_arest_min', 'articol_arest_max', 'puncte_permis',
                'arest_total_min', 'arest_total_max'
            ];

            integerOnlyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('keydown', preventInvalidNumberInput);
                }
            });

            validateAllFields(); // Initial call on page load
            document.querySelectorAll('#procesatorForm input, #procesatorForm select, #procesatorForm textarea').forEach(field => {
                 field.addEventListener('input', () => {
                     validateField(field);
                     updateAllPreviews();
                 });
            });

        }); 
    </script>
</body>
</html>
